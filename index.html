<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>üçü –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑ (–∫–ª–∏–µ–Ω—Ç + —Ç–∞–±–ª–æ)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      background:#f9fafb;
    }
    *, *::before, *::after { box-sizing: border-box; }
    img { max-width: 100%; display:block; }

    .toast{
      position:fixed; right:1rem; bottom:1rem;
      background:#111; color:#fff;
      padding:.75rem 1rem; border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.2);
      opacity:.95; z-index:9999
    }
    .hidden{ display:none }

    .phone-shell{
      width: min(100vw, 540px);
      margin: 0 auto;
      padding-left: 0.35rem;
      padding-right: 0.35rem;
    }

    #menuScroll{
      max-height: 15.5rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      width: 100%;
    }

    #menuGrid{
      display: flex;
      flex-direction: column;
      gap: .75rem;
      width: 100%;
    }

    .menu-card{
      display: flex;
      gap: .75rem;
      align-items: center;
      background: #fff;
      border: 1px solid #edf2f7;
      border-radius: 1.25rem;
      padding: 1rem;
      min-height: 6.4rem;
      width: 100%;
    }
    .menu-card-body{ flex:1 1 auto; min-width:0; }
    .menu-card-img{
      width: 110px;
      height: 70px;
      border-radius: .75rem;
      background: #eee;
      flex: 0 0 auto;
      object-fit: cover;
    }

    .category-grid{
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: .5rem;
      width: 100%;
    }
    .category-btn{
      width: 100%;
      text-align: center;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      padding: .5rem .75rem;
      font-size: .9rem;
      background: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .category-btn.active{
      background:#000; color:#fff; border-color:#000;
    }
    @media (max-width: 380px) {
      .category-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    input, select, textarea, button { font-size: 16px; max-width:100%; }

    .section-card {
      background: #fff;
      border-radius: 1.5rem;
      border: 1px solid #e5e7eb;
      padding: 1rem 1rem 1.25rem 1rem;
      width: 100%;
    }
    @media (min-width: 640px) { .section-card { padding: 1.25rem 1.5rem 1.5rem 1.5rem; } }
    @media (max-width: 640px) {
      header h1 { font-size: 1.4rem; }
      nav { width: 100%; flex-wrap: wrap; }
      nav > * { flex: 1 1 auto; text-align: center; }
    }

    .menu-card.disabled { opacity: .5; }
    .menu-card.disabled small {
      display: block; margin-top: .35rem; color: #b91c1c; font-size: .7rem;
    }

    /* ======== Glass+mobile enhancements ======== */
    .glass-panel {
      background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.85) 0%, rgba(255,255,255,0.45) 45%, rgba(255,255,255,0.25) 100%);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.12);
    }
    .sticky-top { position: sticky; top: .5rem; z-index: 40; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    .bottom-nav {
      position: fixed;
      bottom: .75rem; left: 50%;
      transform: translateX(-50%);
      width: min(540px, 96vw);
      background: rgba(248,250,252,.4);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.4);
      border-radius: 1.25rem;
      display: flex; gap: .5rem; justify-content: space-around;
      padding: .4rem .4rem .45rem;
      z-index: 50;
    }
    .bottom-nav button {
      flex: 1 1 0;
      border-radius: 1rem;
      padding: .45rem .1rem .25rem;
      font-size: .7rem;
      display: flex; flex-direction: column; align-items: center; gap: .1rem;
    }
    .bottom-nav button.active { background: rgba(15,23,42,.12); }

    .floating-total {
      position: fixed;
      bottom: 4.5rem;
      right: max(1rem, calc((100vw - 540px)/2 + 1rem));
      background: #0f172a; color: #fff;
      border-radius: 9999px; padding: .55rem 1.1rem;
      font-weight: 600; display: flex; gap: .4rem; align-items: center;
      z-index: 55; box-shadow: 0 14px 35px rgba(15,23,42,.35);
      cursor: pointer;
    }
    @media (min-width: 900px) {
      .bottom-nav { bottom: 1rem; }
      .floating-total { bottom: 5rem; }
    }
  </style>
</head>
<body>
  <div class="w-full py-6">
    <header class="phone-shell flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 gap-3">
      <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">üçü –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑</h1>
      <nav class="flex gap-2 items-center">
        <a id="toClient" href="#/order" class="px-3 py-2 rounded-xl border text-sm sm:text-base">–ö–ª–∏–µ–Ω—Ç</a>
        <button id="openDashboard" type="button" class="px-3 py-2 rounded-xl border text-sm sm:text-base">–¢–∞–±–ª–æ</button>
        <button id="hardRefresh" type="button" class="px-3 py-2 rounded-xl border text-sm sm:text-base">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </nav>
    </header>

    <div id="pinModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
      <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow">
        <h3 class="text-lg font-semibold mb-3">–í—Ö–æ–¥ –≤ —Ç–∞–±–ª–æ</h3>
        <p class="text-sm text-gray-600 mb-3">–í–≤–µ–¥–∏—Ç–µ –ø–∏–Ω-–∫–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <input id="pinInput" type="password" class="w-full border rounded-xl p-3 mb-4" placeholder="–ü–∏–Ω-–∫–æ–¥" />
        <div class="flex gap-2 justify-end">
          <button id="pinCancel" type="button" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
          <button id="pinOk" type="button" class="px-3 py-2 rounded-xl border bg-black text-white">–í–æ–π—Ç–∏</button>
        </div>
        <p id="pinError" class="text-sm text-red-600 mt-2 hidden">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∏–Ω</p>
      </div>
    </div>

    <main id="app" class="phone-shell"></main>

    <p class="mt-6 text-sm text-gray-500 phone-shell">
      –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –Ø–Ω–¥–µ–∫—Å Cloud.
      –¢–∞–±–ª–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥.
    </p>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
  <div id="orderConfirmModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[9998]">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm max-h-[90vh] overflow-y-auto shadow-lg space-y-4">
      <h3 class="text-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑</h3>
      <div id="orderConfirmList" class="space-y-2 text-sm"></div>
      <div id="orderConfirmTotal" class="text-base font-medium pt-1"></div>
      <div id="orderConfirmClient" class="text-sm text-gray-500"></div>
      <div class="flex gap-2 justify-end pt-2">
        <button id="orderConfirmCancel" type="button" class="px-3 py-2 rounded-xl border">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button id="orderConfirmOk" type="button" class="px-3 py-2 rounded-xl bg-black text-white">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>

<script>
const ALLOWED_PIN = "65Vafuza";
const API_BASE   = "https://d5d1ec44lv5uk5k7k9to.bixf7e87.apigw.yandexcloud.net/order";
const UNAVAILABLE_LS_KEY = 'orders_unavailable_v1';
const CLIENT_HISTORY_KEY = 'orders_client_history_v1';

if (!location.hash || location.hash === "#/" || location.hash === "#") {
  location.hash = "#/order";
}

function getClientId() {
  const KEY = 'yc_client_id_v1';
  let cid = localStorage.getItem(KEY);
  if (!cid) {
    cid = 'cid-' + Math.random().toString(36).slice(2) + Date.now();
    localStorage.setItem(KEY, cid);
  }
  return cid;
}
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), 2500);
}
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function money(x){ return x + ' —Ä—É–±.' }

// –æ—Ñ–ª–∞–π–Ω-—Å—Ç–æ—Ä
const LS_KEY = 'orders_yc_fallback_v1';
const store = {
  load(){
    try{
      return JSON.parse(localStorage.getItem(LS_KEY)) || {orders:[], nextLocalId:1};
    }catch{
      return {orders:[], nextLocalId:1};
    }
  },
  save(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
};

// –∑–∞–ø—Ä–æ—Å –∫ –Ø–Ω–¥–µ–∫—Å –∞–ø–∏–≥–µ–π—Ç
async function ycCall(op, extra = {}) {
  const payload = { op, ...extra };
  try {
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data = {};
    if (text) {
      try {
        data = JSON.parse(text);
      } catch (e) {
        return { error: "bad-json", status: res.status, raw: text };
      }
    }

    if (!res.ok) {
      return { error: "http", status: res.status, data };
    }

    return data;
  } catch (e) {
    console.warn("YC network error:", e);
    return { error: "network", message: e.message };
  }
}

/* –º–µ–Ω—é */
const MENU_CATEGORIES = [
  { key: 'burgers', title: '–ë—É—Ä–≥–µ—Ä—ã', items: [
      { name: '–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä',  price: 280, img: 'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
      { name: '–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price: 340, img: 'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
      { name: '–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä',  price: 200, img: 'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
      { name: '–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price: 250, img: 'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
  ]},
  { key: 'twisters', title: '–¢–≤–∏—Å—Ç–µ—Ä—ã', items: [
      { name: '–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price: 200 },
      { name: '–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å',    price: 250 },
  ]},
  { key: 'drinks', title: '–ù–∞–ø–∏—Ç–∫–∏', items: [
      { name: '–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price: 100 },
      { name: '–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price: 100 },
      { name: '–°–ø—Ä–∞–π—Ç', price: 100 },
      { name: '–≠—Å–ø—Ä–µ—Å—Å–æ', price: 120 },
      { name: '–ë–∞–Ω–∞–Ω–æ–≤—ã–π —Ä–∞—Ñ', price: 180 },
      { name: '–ß–∞–π —á—ë—Ä–Ω—ã–π', price: 70 },
  ]},
  { key: 'sushi', title: '–°—É—à–∏ / —Ä–æ–ª–ª—ã', items: [
      { name: '–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price: 350 },
      { name: '–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price: 390 },
      { name: '–ê–ª—è—Å–∫–∞', price: 350 },
  ]},
  { key: 'potato', title: '–ö–∞—Ä—Ç–æ—à–∫–∞', items: [
      { name: '–§—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏–π', price: 150 },
      { name: '–§—Ä–∏ –±–æ–ª—å—à–æ–π', price: 180 },
      { name: '–ü–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏ –º–∞–ª–µ–Ω—å–∫–∏–π', price: 160 },
      { name: '–ü–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏ –±–æ–ª—å—à–æ–π', price: 200 },
  ]},
  { key: 'semi', title: '–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã', items: [
      { name: '–ù–∞–≥–≥–µ—Ç—Å—ã 6 —à—Ç.', price: 160 },
      { name: '–ù–∞–≥–≥–µ—Ç—Å—ã 9 —à—Ç.', price: 210 },
      { name: '–°—Ç—Ä–∏–ø—Å—ã', price: 190 },
  ]},
];

const ALL_ITEMS = MENU_CATEGORIES.flatMap(cat =>
  cat.items.map(it => ({ name: it.name, cat: cat.key }))
);

function findPriceByName(name){
  for (const cat of MENU_CATEGORIES){
    const f = cat.items.find(i => i.name === name);
    if (f) return f.price;
  }
  return 0;
}

function calcTotalFromItems(order){
  let sum = 0;
  (order.items || []).forEach(i => {
    const p = typeof i.price === 'number' ? i.price : findPriceByName(i.name);
    sum += p * (i.qty || 0);
  });
  return sum;
}

/* ===== –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã ===== */
async function fetchUnavailableFromServer(){
  const res = await ycCall("getUnavailable", {});
  if (!res.error && res && Array.isArray(res.items)) return res.items;
  return null;
}
async function saveUnavailableToServer(items){
  const res = await ycCall("setUnavailable", { items });
  return !res.error;
}
function loadUnavailableFromLS(){
  try {
    const raw = localStorage.getItem(UNAVAILABLE_LS_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) return arr;
    return [];
  } catch(e){ return []; }
}
function saveUnavailableToLS(items){
  localStorage.setItem(UNAVAILABLE_LS_KEY, JSON.stringify(items));
}

/* ===== –∏—Å—Ç–æ—Ä–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç—É ===== */
function loadClientHistory(clientId){
  try{
    const all = JSON.parse(localStorage.getItem(CLIENT_HISTORY_KEY)) || {};
    return Array.isArray(all[clientId]) ? all[clientId] : [];
  }catch{
    return [];
  }
}
function saveClientHistory(clientId, list){
  const all = (()=>{ try { return JSON.parse(localStorage.getItem(CLIENT_HISTORY_KEY)) || {}; } catch { return {}; } })();
  all[clientId] = list;
  localStorage.setItem(CLIENT_HISTORY_KEY, JSON.stringify(all));
}
function addToClientHistory(clientId, order){
  const list = loadClientHistory(clientId);
  list.unshift(order);
  saveClientHistory(clientId, list.slice(0, 20));
}

/* ===== –º–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ===== */
const orderConfirm = {
  _ok: null,
  _cancel: null,
  open(data){
    const wrap = document.getElementById('orderConfirmModal');
    const list = document.getElementById('orderConfirmList');
    const totalEl = document.getElementById('orderConfirmTotal');
    const clientEl = document.getElementById('orderConfirmClient');

    list.innerHTML = '';
    data.items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'flex justify-between gap-2';
      row.innerHTML = `<span>${it.name} √ó${it.qty}</span><span>${it.price * it.qty} —Ä—É–±.</span>`;
      list.appendChild(row);
    });
    totalEl.textContent = '–ò—Ç–æ–≥–æ: ' + data.total + ' —Ä—É–±.';
    clientEl.textContent =
      (data.client.name ? data.client.name + ' ¬∑ ' : '') +
      (data.client.phone ? data.client.phone + ' ¬∑ ' : '') +
      (data.client.address ? data.client.address : '') +
      (data.client.deliverByTime && data.client.deliverTime ? ' ¬∑ –∫ ' + data.client.deliverTime : '');

    this._ok = data.onOk || null;
    this._cancel = data.onCancel || null;

    wrap.classList.remove('hidden');
    wrap.classList.add('flex');
  },
  close(){
    const wrap = document.getElementById('orderConfirmModal');
    wrap.classList.add('hidden');
    wrap.classList.remove('flex');
  }
};

// –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
(function initConfirmModal(){
  const wrap = document.getElementById('orderConfirmModal');
  const btnOk = document.getElementById('orderConfirmOk');
  const btnCancel = document.getElementById('orderConfirmCancel');

  btnOk.addEventListener('click', ()=>{
    const cb = orderConfirm._ok;
    orderConfirm.close();
    if (cb) cb();
  });
  btnCancel.addEventListener('click', ()=>{
    const cb = orderConfirm._cancel;
    orderConfirm.close();
    if (cb) cb();
  });
  wrap.addEventListener('click', (e)=>{
    if (e.target === wrap) orderConfirm.close();
  });
})();

/* ===== —ç–∫—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–æ–≤—ã–π UI) ===== */
function OrderView(){
  const root = el(`
    <div class="relative pb-20">
      <!-- –≤–µ—Ä—Ö: –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Å—Ç–µ–∫–ª–µ -->
      <section class="sticky-top mb-4">
        <div class="glass-panel rounded-2xl px-3 py-3">
          <h2 class="text-base font-semibold mb-2 flex items-center gap-2">ü•ò –ú–µ–Ω—é</h2>
          <div id="categoryBar" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
        </div>
      </section>

      <!-- —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ -->
      <section class="mb-4">
        <div id="menuScroll" class="flex flex-col gap-3">
          <div id="menuGrid"></div>
        </div>
      </section>

      <!-- –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
      <section class="glass-panel rounded-2xl px-4 py-4 mb-4">
        <h2 class="text-base font-semibold mb-3 flex items-center gap-2">üöö –î–æ—Å—Ç–∞–≤–∫–∞</h2>
        <form class="grid gap-3" id="orderForm">
          <input class="border rounded-xl p-3 bg-white/70 focus:bg-white outline-none" placeholder="–ò–º—è" name="name" required />
          <input class="border rounded-xl p-3 bg-white/70 focus:bg-white outline-none" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä +7...)" name="phone" required />
          <input class="border rounded-xl p-3 bg-white/70 focus:bg-white outline-none" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" name="address" required />
          <label class="flex items-center gap-3">
            <input type="checkbox" name="deliverByTime" />
            <span class="text-sm">–î–æ—Å—Ç–∞–≤–∏—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–∏</span>
          </label>
          <input class="border rounded-xl p-3 hidden bg-white/70 focus:bg-white outline-none" type="time" name="deliverTime" />
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div class="text-base">
              <span class="text-gray-500">–ò—Ç–æ–≥–æ:</span>
              <span id="total" class="font-semibold">0 —Ä—É–±.</span>
            </div>
            <button id="sendBtn" class="px-4 py-3 rounded-xl bg-black text-white w-full sm:w-auto shadow" type="submit">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
          </div>
        </form>
      </section>

      <!-- –∏—Å—Ç–æ—Ä–∏—è -->
      <section class="glass-panel rounded-2xl px-4 py-4 mb-4">
        <h2 class="text-base font-semibold mb-3">üïì –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
        <p class="text-xs text-gray-500 mb-3">–•—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</p>
        <div id="myOrders" class="grid gap-2"></div>
      </section>

      <section id="result"></section>

      <!-- –Ω–∏–∂–Ω–∏–π –±–∞—Ä -->
      <div class="bottom-nav">
        <button type="button" data-tab="menu" class="active">
          <span class="text-lg">üçî</span>
          –ú–µ–Ω—é
        </button>
        <button type="button" data-tab="delivery">
          <span class="text-lg">üì¶</span>
          –î–æ—Å—Ç–∞–≤–∫–∞
        </button>
        <button type="button" data-tab="history">
          <span class="text-lg">üïì</span>
          –ò—Å—Ç–æ—Ä–∏—è
        </button>
      </div>

      <!-- –ø–ª–∞–≤–∞—é—â–∞—è —Å—É–º–º–∞ -->
      <button type="button" id="floatingTotal" class="floating-total hidden">
        <span id="floatingTotalVal">0 —Ä—É–±.</span>
        <span class="text-xs opacity-80">–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é</span>
      </button>
    </div>
  `);

  const categoryBar = root.querySelector('#categoryBar');
  const menuGrid    = root.querySelector('#menuGrid');
  const form        = root.querySelector('#orderForm');
  const totalEl     = root.querySelector('#total');
  const deliverChk  = form.deliverByTime;
  const deliverTime = form.deliverTime;
  const sendBtn     = form.querySelector('#sendBtn');
  const myOrdersBox = root.querySelector('#myOrders');
  const floatingBtn = root.querySelector('#floatingTotal');

  const clientId = getClientId();

  const counts = {};
  let currentCategory = MENU_CATEGORIES[0].key;

  let unavailable = new Set(loadUnavailableFromLS());

  async function syncUnavailable(){
    const srv = await fetchUnavailableFromServer();
    if (Array.isArray(srv)) {
      const srvSet = new Set(srv);
      if (srv.length !== unavailable.size || srv.some(n => !unavailable.has(n))) {
        unavailable = srvSet;
        saveUnavailableToLS(srv);
        renderCategory(currentCategory);
      }
    }
  }
  syncUnavailable();
  setInterval(syncUnavailable, 10000);

  // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ¬´—á–∏–ø—Å—ã¬ª
  MENU_CATEGORIES.forEach((cat, idx) => {
    const btn = el(`
      <button type="button"
        class="px-3 py-1.5 rounded-full border text-sm whitespace-nowrap ${idx===0?'bg-black text-white border-black':'bg-white/50'}"
        data-cat="${cat.key}">
        ${cat.title}
      </button>
    `);
    categoryBar.appendChild(btn);
  });

  function recalcTotal(){
    let sum = 0;
    for (const cat of MENU_CATEGORIES){
      for (const item of cat.items){
        const q = counts[item.name] || 0;
        sum += item.price * q;
      }
    }
    totalEl.textContent = money(sum);
    if (sum > 0){
      floatingBtn.classList.remove('hidden');
      floatingBtn.querySelector('#floatingTotalVal').textContent = money(sum);
    } else {
      floatingBtn.classList.add('hidden');
    }
    return sum;
  }

  function renderCategory(catKey){
    currentCategory = catKey;
    categoryBar.querySelectorAll('button').forEach(b=>{
      const on = b.dataset.cat === catKey;
      b.classList.toggle('bg-black', on);
      b.classList.toggle('text-white', on);
      b.classList.toggle('border-black', on);
    });

    const cat = MENU_CATEGORIES.find(c=>c.key===catKey);
    menuGrid.innerHTML = '';
    cat.items.forEach(item=>{
      const q = counts[item.name] || 0;
      const isOff = unavailable.has(item.name);
      const card = el(`
        <div class="glass-panel rounded-2xl p-3 flex gap-3 items-center ${isOff?'opacity-50':''}">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <div class="font-medium text-sm">${item.name}</div>
              ${isOff ? '<span class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full">–Ω–µ—Ç</span>' : ''}
            </div>
            <div class="text-xs text-gray-500 mt-1">${money(item.price)}</div>
            <div class="flex items-center gap-3 mt-3">
              <button type="button" class="w-8 h-8 rounded-xl border flex items-center justify-center" data-act="dec" ${isOff?'disabled':''}>‚àí</button>
              <div class="w-6 text-center text-sm" data-q>${q}</div>
              <button type="button" class="w-8 h-8 rounded-xl bg-black text-white flex items-center justify-center" data-act="inc" ${isOff?'disabled':''}>+</button>
            </div>
          </div>
          <img src="${item.img || 'https://placehold.co/80x80?text=food'}" class="w-20 h-16 rounded-xl object-cover flex-shrink-0" alt="">
        </div>
      `);
      const qEl = card.querySelector('[data-q]');
      card.addEventListener('click', e=>{
        if (isOff) { showToast('–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
        if (e.target.dataset.act === 'inc'){
          counts[item.name] = (counts[item.name] || 0) + 1;
          qEl.textContent = counts[item.name];
          recalcTotal();
        }
        if (e.target.dataset.act === 'dec'){
          counts[item.name] = Math.max(0, (counts[item.name] || 0) - 1);
          qEl.textContent = counts[item.name];
          recalcTotal();
        }
      });
      menuGrid.appendChild(card);
    });
  }
  renderCategory(currentCategory);

  // –∫–ª–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  categoryBar.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-cat]');
    if (!btn) return;
    renderCategory(btn.dataset.cat);
  });

  // –Ω–∏–∂–Ω–∏–π –±–∞—Ä ‚Äî —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω—É–∂–Ω—ã–º —Å–µ–∫—Ü–∏—è–º
  const bottom = root.querySelector('.bottom-nav');
  bottom.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-tab]');
    if (!btn) return;
    bottom.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');

    const tab = btn.dataset.tab;
    if (tab === 'menu'){ window.scrollTo({ top: 0, behavior: 'smooth' }); }
    if (tab === 'delivery'){ form.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
    if (tab === 'history'){ myOrdersBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
  });

  // –ø–ª–∞–≤–∞—é—â–∞—è —Å—É–º–º–∞ ‚Üí –∫ –¥–æ—Å—Ç–∞–≤–∫–µ
  floatingBtn.addEventListener('click', ()=>{ form.scrollIntoView({ behavior: 'smooth' }); });

  // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≤—Ä–µ–º—è
  deliverChk.addEventListener('change', ()=>{
    deliverTime.classList.toggle('hidden', !deliverChk.checked);
    if (!deliverChk.checked) deliverTime.value='';
  });

  // –∏—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞
  function renderHistory(){
    const list = loadClientHistory(clientId);
    myOrdersBox.innerHTML = '';
    if (!list.length){
      myOrdersBox.innerHTML = '<div class="text-xs text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
      return;
    }
    list.forEach(o=>{
      const tot = typeof o.total === 'number' ? o.total : calcTotalFromItems(o);
      const card = el(`
        <div class="flex items-center justify-between bg-white/40 rounded-xl px-3 py-2">
          <div>
            <div class="text-sm font-medium">#${o.id || '‚Äî'} ¬∑ ${o.status || '–Ω–æ–≤—ã–π'}</div>
            <div class="text-[10px] text-gray-400">${o.createdAt ? new Date(o.createdAt).toLocaleString() : ''}</div>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-sm">${tot ? tot+' —Ä—É–±.' : ''}</div>
            <button type="button" class="text-xs text-red-500" data-del>‚úï</button>
          </div>
        </div>
      `);
      card.querySelector('[data-del]').addEventListener('click', ()=>{
        const cur = loadClientHistory(clientId).filter(x => x.localUid !== o.localUid);
        saveClientHistory(clientId, cur);
        renderHistory();
      });
      myOrdersBox.appendChild(card);
    });
  }

  // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî —Å–∏–Ω–∫ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  (async ()=>{
    const res = await ycCall("list");
    if (!res.error && Array.isArray(res.orders)) {
      const mine = res.orders.filter(o => o.clientId === clientId);
      if (mine.length){
        const local = loadClientHistory(clientId);
        const ids = new Set(local.map(x => String(x.id)));
        const merged = [...mine.map(o => ({ ...o, localUid: 'srv-'+o.id })), ...local.filter(x => !ids.has(String(x.id)))];
        saveClientHistory(clientId, merged.slice(0, 20));
      }
    }
    renderHistory();
  })();
  renderHistory();

  function resetAll(){
    for (const key in counts) delete counts[key];
    renderCategory(currentCategory);
    totalEl.textContent = '0 —Ä—É–±.';
    floatingBtn.classList.add('hidden');
    form.reset();
    deliverTime.classList.add('hidden');
  }

  // —Å–∞–±–º–∏—Ç ‚Üí —Å–Ω–∞—á–∞–ª–∞ –º–æ–¥–∞–ª–∫–∞, –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∞
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if (sendBtn.disabled) return;

    // —Å–æ–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
    const items = [];
    for (const cat of MENU_CATEGORIES){
      for (const item of cat.items){
        const qty = counts[item.name] || 0;
        if (qty > 0){
          items.push({ name: item.name, qty, price: item.price });
        }
      }
    }
    if (!items.length){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã'); return; }

    const total = recalcTotal();
    const payload = {
      clientId,
      name: form.name.value.trim(),
      phone: form.phone.value.trim(),
      address: form.address.value.trim(),
      deliverByTime: form.deliverByTime.checked,
      deliverTime: form.deliverTime.value || null,
      items,
      total
    };

    orderConfirm.open({
      items,
      total,
      client: {
        name: payload.name,
        phone: payload.phone,
        address: payload.address,
        deliverByTime: payload.deliverByTime,
        deliverTime: payload.deliverTime
      },
      onOk: async ()=>{
        sendBtn.disabled = true;
        sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';

        const res = await ycCall("create", { data: payload });

        if (res.error){
          const data = store.load();
          const id = 'L' + (data.nextLocalId++);
          const now = Date.now();
          const order = { id, ...payload, status:'–Ω–æ–≤—ã–π', createdAt:now, updatedAt:now, _source:'local', localUid: 'local-'+id };
          data.orders.unshift(order); store.save(data);
          addToClientHistory(clientId, order);
          renderHistory();
          showToast('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)');
          document.getElementById('result').innerHTML = `
            <div class="glass-panel rounded-2xl px-4 py-4 mt-4">
              <div class="text-base font-semibold mb-1">–°–ø–∞—Å–∏–±–æ! –ó–∞–∫–∞–∑ #${order.id} –ø—Ä–∏–Ω—è—Ç (–ª–æ–∫–∞–ª—å–Ω–æ).</div>
              <div class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å: ${order.status} ¬∑ –ò—Ç–æ–≥: <b>${order.total} —Ä—É–±.</b></div>
            </div>`;
          resetAll();
          sendBtn.disabled = false;
          sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
          return;
        }

        const o = res.order || { id: '‚Äî', status: '–Ω–æ–≤—ã–π', items, total };
        const serverTotal = typeof o.total === 'number' ? o.total : 0;
        const clientTotalFromResp = calcTotalFromItems(o);
        const shownTotal = Math.max(serverTotal, total, clientTotalFromResp);
        const now = Date.now();

        addToClientHistory(clientId, { ...o, createdAt: o.createdAt || now, localUid: 'srv-'+o.id });
        renderHistory();

        document.getElementById('result').innerHTML = `
          <div class="glass-panel rounded-2xl px-4 py-4 mt-4">
            <div class="text-base font-semibold mb-1">–°–ø–∞—Å–∏–±–æ! –ó–∞–∫–∞–∑ #${o.id} –ø—Ä–∏–Ω—è—Ç.</div>
            <div class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å: ${o.status || '–Ω–æ–≤—ã–π'} ¬∑ –ò—Ç–æ–≥: <b>${shownTotal} —Ä—É–±.</b></div>
          </div>`;

        showToast(res.dedup ? '–ó–∞–∫–∞–∑ —É–∂–µ –±—ã–ª, –ø–æ–∫–∞–∑–∞–ª–∏ –µ–≥–æ' : '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');

        resetAll();
        sendBtn.disabled = false;
        sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
      },
      onCancel: ()=>{}
    });
  });

  return root;
}

/* ===== —Ç–∞–±–ª–æ ===== */
function DashboardView(){
  const root = el(`
    <div class="grid gap-4 max-w-6xl">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h2>
        <div class="flex gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border" id="enableSound">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
          <button type="button" class="px-3 py-2 rounded-xl border" id="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="p-4 rounded-2xl bg-white border">
        <h3 class="font-semibold mb-3">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <p class="text-sm text-gray-500 mb-3">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–∫–æ–π, —á–µ–≥–æ –ù–ï–¢ ‚Äî –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ —Ç–æ–≤–∞—Ä —Å—Ç–∞–Ω–µ—Ç —Å–µ—Ä—ã–º –∏ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å.</p>
        <div id="stockList" class="grid gap-2 md:grid-cols-3"></div>
        <div class="mt-3">
          <button id="saveStock" class="px-3 py-2 rounded-xl border bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="list"></div>
    </div>
  `);

  const list = root.querySelector('#list');
  let audioCtx = null;
  let soundEnabled = false;
  const seenIds = new Set();
  let lastOrdersMap = new Map();   // —á—Ç–æ–±—ã –Ω–µ –∏—Å—á–µ–∑–∞–ª–æ

  const stockList = root.querySelector('#stockList');
  let unavailable = new Set(loadUnavailableFromLS());

  function renderStock(){
    stockList.innerHTML = '';
    ALL_ITEMS.forEach(item => {
      const row = el(`
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" value="${item.name}" ${unavailable.has(item.name)?'checked':''} />
          <span>${item.name}</span>
        </label>
      `);
      stockList.appendChild(row);
    });
  }
  renderStock();

  (async ()=>{
    const srv = await fetchUnavailableFromServer();
    if (Array.isArray(srv)) {
      unavailable = new Set(srv);
      renderStock();
      saveUnavailableToLS(srv);
    }
  })();

  root.querySelector('#saveStock').addEventListener('click', async ()=>{
    const checked = Array.from(stockList.querySelectorAll('input[type=checkbox]:checked'))
      .map(i=>i.value);
    saveUnavailableToLS(checked);
    const ok = await saveUnavailableToServer(checked);
    if (ok) showToast('–ù–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    else showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ');
    unavailable = new Set(checked);
  });

  function playBeep(duration = 0.35, freq = 880) {
    if (!audioCtx || !soundEnabled) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.35, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  root.querySelector('#enableSound').addEventListener('click', async () => {
    try {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      soundEnabled = true;
      playBeep(); setTimeout(()=>playBeep(), 200);
      showToast("–ó–≤—É–∫ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤–∫–ª—é—á—ë–Ω");
      root.querySelector('#enableSound').textContent = "üîî –ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω";
    } catch (e) {
      showToast("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–∞–ª –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫");
    }
  });

  root.querySelector('#refresh').addEventListener('click', ()=> location.reload());

  function orderCard(o){
    const clientTotal = calcTotalFromItems(o);
    const total = Math.max(typeof o.total === 'number' ? o.total : 0, clientTotal);
    const created = o.createdAt ? new Date(o.createdAt) : new Date();
    const itemLines = (o.items || []).map(i=>`${i.name} √ó${i.qty}`).join(', ');
    const card = el(`
      <div class="p-5 rounded-2xl bg-white border flex flex-col gap-2" data-id="${o.id}">
        <div class="flex items-center justify-between gap-4">
          <div class="text-lg font-semibold">#${o.id} ‚Äî ${o.name}</div>
          <div class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${o.status}</div>
        </div>
        <div class="text-sm text-gray-600">
          ${created.toLocaleString()} ¬∑ –ò—Ç–æ–≥: <b>${total} —Ä—É–±.</b>${o._source==='local' ? ' ¬∑ <span class="text-red-500">–ª–æ–∫–∞–ª—å–Ω–æ</span>' : ''}
        </div>
        <div>üìç ${o.address}</div>
        <div>‚òéÔ∏è ${o.phone}</div>
        <div>üßæ ${itemLines || '‚Äî'}</div>
        <div>‚è∞ ${o.deliverByTime && o.deliverTime ? ('–∫ ' + o.deliverTime) : '–∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ'}</div>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <label class="text-sm">–°—Ç–∞—Ç—É—Å:</label>
          <select class="border rounded-xl p-2" data-k="status">
            ${['–Ω–æ–≤—ã–π','–≥–æ—Ç–æ–≤–∏—Ç—Å—è','–≤ –ø—É—Ç–∏','–≥–æ—Ç–æ–≤','–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
          </select>
          <button type="button" class="px-3 py-2 rounded-xl border" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm">–û–∂–∏–¥–∞–Ω–∏–µ (–º–∏–Ω):</label>
          <input type="number" min="0" class="border rounded-xl p-2 w-24" data-k="eta" value="${o.etaMinutes??''}" />
          <button type="button" class="px-3 py-2 rounded-xl border" data-act="set-eta">OK</button>
        </div>
        <div class="mt-2 text-right">
          <button type="button" class="px-3 py-2 rounded-xl border bg-red-50 hover:bg-red-100" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `);

    card.addEventListener('click', async (e)=>{
      const act = e.target.dataset.act;
      if (!act) return;
      if (act === 'save'){
        const status = card.querySelector('[data-k="status"]').value;
        await ycCall("update", { id: o.id, patch: { status } });
        showToast(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`);
      }
      if (act === 'set-eta'){
        const etaMinutes = Number(card.querySelector('[data-k="eta"]').value || 0);
        await ycCall("update", { id: o.id, patch: { etaMinutes } });
        showToast(`ETA –∑–∞–∫–∞–∑–∞ #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`);
      }
      if (act === 'delete'){
        if (!card.dataset.confirm){
          card.dataset.confirm = '1';
          e.target.textContent = '–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?';
          setTimeout(()=>{
            if (card && card.dataset.confirm === '1'){
              delete card.dataset.confirm;
              e.target.textContent = '–£–¥–∞–ª–∏—Ç—å';
            }
          }, 3000);
          return;
        }
        await ycCall("delete", { id: o.id });
        card.remove();
        showToast(`–ó–∞–∫–∞–∑ #${o.id} —É–¥–∞–ª—ë–Ω`);
      }
    });

    return card;
  }

  async function load(){
    const res = await ycCall("list");
    const unique = new Map();

    if (!res.error && Array.isArray(res.orders) && res.orders.length > 0) {
      res.orders.forEach(o => unique.set(String(o.id), o));
      lastOrdersMap = new Map(unique);
    } else if (lastOrdersMap.size > 0) {
      lastOrdersMap.forEach((v,k)=> unique.set(k,v));
    } else {
      const data = store.load();
      data.orders.forEach(o => unique.set(String(o.id), o));
    }

    list.innerHTML = '';
    if (unique.size === 0) {
      list.innerHTML = `<div class="p-5 rounded-2xl bg-white border text-gray-500 col-span-full">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>`;
      return;
    }

    const currentIds = new Set();
    [...unique.values()].forEach(o => {
      const idStr = String(o.id);
      currentIds.add(idStr);
      if (!seenIds.has(idStr)) {
        showToast("–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #" + o.id);
        if (soundEnabled){ playBeep(); setTimeout(()=>playBeep(), 250); }
      }
      list.appendChild(orderCard(o));
    });

    seenIds.clear();
    currentIds.forEach(id => seenIds.add(id));
  }

  load();
  setInterval(()=>{ if (location.hash === '#/dashboard') load(); }, 5000);

  return root;
}

function router(){
  const app = document.getElementById('app');
  app.innerHTML = '';
  if (location.hash === '#/dashboard') {
    app.classList.remove('phone-shell');
    app.appendChild(DashboardView());
  } else {
    app.classList.add('phone-shell');
    app.appendChild(OrderView());
  }
}
window.addEventListener('hashchange', router);
router();

/* –ø–∏–Ω */
const dashBtn  = document.getElementById('openDashboard');
const pinModal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const pinOk    = document.getElementById('pinOk');
const pinCancel= document.getElementById('pinCancel');
const pinError = document.getElementById('pinError');

function showPin(){ pinError.classList.add('hidden'); pinInput.value=''; pinModal.classList.remove('hidden'); pinModal.classList.add('flex'); setTimeout(()=>pinInput.focus(),0); }
function hidePin(){ pinModal.classList.add('hidden'); pinModal.classList.remove('flex'); }

function tryEnter(){
  if (pinInput.value === ALLOWED_PIN){
    hidePin();
    location.hash = '#/dashboard';
  } else {
    pinError.classList.remove('hidden');
    pinInput.focus();
  }
}

dashBtn.addEventListener('click', (e)=>{ e.preventDefault(); showPin(); });
pinOk.addEventListener('click', tryEnter);
pinCancel.addEventListener('click', hidePin);
pinInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') tryEnter(); if (e.key==='Escape') hidePin(); });
pinModal.addEventListener('click', (e)=>{ if (e.target===pinModal) hidePin(); });

document.getElementById('hardRefresh').addEventListener('click', ()=> location.reload());
</script>
</body>
</html>
