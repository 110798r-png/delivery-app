<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–Ø–º–∞–ú–æ—Ç–æ ‚Äî –æ–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; background:#f9fafb; }
    *, *::before, *::after { box-sizing:border-box; }
    img { max-width:100%; display:block; }
    .hidden{ display:none }
    .phone-shell{ width:min(100vw,540px); margin:0 auto; padding:0 .35rem; }

    .toast{ position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; padding:.75rem 1rem; border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.2); opacity:.95; z-index:9999 }

    .glass-panel{ background:radial-gradient(circle at 10% 20%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.45) 45%, rgba(255,255,255,.25) 100%);
      backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.4); box-shadow:0 14px 40px rgba(15,23,42,.12) }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .sticky-top{ position:sticky; top:.5rem; z-index:30 }

    .menu-card{ display:flex; gap:.75rem; align-items:center; background:#fff; border:1px solid #edf2f7; border-radius:1.25rem; padding:1rem; min-height:6.4rem }
    .menu-card-img{ width:110px; height:70px; border-radius:.75rem; background:#eee; object-fit:cover }

    .confirm-bar{
      position:fixed; left:50%; transform:translateX(-50%); bottom:0;
      width:min(540px, 100vw); background:#fff; border-top:1px solid #e5e7eb;
      padding:.6rem .9rem; z-index:50; box-shadow:0 -10px 25px rgba(15,23,42,.06);
    }

    #catPager{ display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; touch-action: pan-x pinch-zoom; }
    .cat-panel{ flex:0 0 100%; scroll-snap-align:start; scroll-snap-stop: always; padding:0; }
    .v-scroll{ overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action: pan-y; }

    /* –õ–∏—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ (sheet) */
    .sheet{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:80; }
    .sheet.open{ display:block }
    .sheet-panel{ position:absolute; top:0; right:0; width:min(92vw,420px); height:100%; background:#fff; padding:16px; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.25); }

    /* –ë–ª–æ–∫-–∫–Ω–æ–ø–∫–∏ */
    .block-btn{ border-radius:1.25rem; padding:1rem; box-shadow:0 8px 24px rgba(15,23,42,.08); transition:transform .12s ease; }
    .block-btn:active{ transform:scale(.98); }
    .soft{ background:linear-gradient(180deg, #ffffff 0%, #f6f8fb 100%); border:1px solid #eef2f7; }

    /* –†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä */
    .promo{ border-radius:1.25rem; background:linear-gradient(135deg,#1f2937 0%,#111827 100%); color:#fff; padding:16px;
            box-shadow:0 12px 32px rgba(17,24,39,.35) }
  </style>
</head>
<body>
  <div class="w-full py-3">
    <header id="appHeader" class="phone-shell flex items-center justify-between mb-3 sm:mb-4">
      <div class="leading-tight">
        <div class="text-2xl font-extrabold tracking-tight">–Ø–º–∞–ú–æ—Ç–æ</div>
        <div class="text-[12px] text-gray-600 -mt-0.5">—Å—É—à–∏ ‚Ä¢ —Ä–æ–ª–ª—ã ‚Ä¢ —Ñ–∞—Å—Ç—Ñ—É–¥</div>
      </div>
      <button id="profileBtn" class="px-3 py-2 rounded-xl border bg-white" aria-label="profile">üë§</button>
    </header>
    <main id="app" class="phone-shell"></main>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
/* ===== Base ===== */
const PROFILE_LS_KEY = 'client_profile_v1';
const CLIENT_HISTORY_KEY = 'orders_client_history_v1';
const SUPPORT_CHAT_KEY = 'support_chat_v1';

if (!location.hash || location.hash === "#/" || location.hash === "#") location.hash = "#/order";

const el = (html)=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; };
const showToast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2200); };
const money = (x)=> `${x} —Ä—É–±.`;
const setBodyScrollLock = (on)=> document.body.style.overflow = on ? 'hidden' : '';

function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_LS_KEY))||{} }catch{ return {} } }
function saveProfile(p){ localStorage.setItem(PROFILE_LS_KEY, JSON.stringify(p||{})) }

function loadHistory(){ try{ return JSON.parse(localStorage.getItem(CLIENT_HISTORY_KEY))||[] }catch{ return [] } }
function saveHistory(list){ localStorage.setItem(CLIENT_HISTORY_KEY, JSON.stringify(list||[])) }

function loadChat(){ try{ return JSON.parse(localStorage.getItem(SUPPORT_CHAT_KEY))||[] }catch{ return [] } }
function saveChat(list){ localStorage.setItem(SUPPORT_CHAT_KEY, JSON.stringify(list||[])) }

/* ===== Menu data (–≤–∫–ª—é—á–∞—è ¬´–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã¬ª) ===== */
const MENU_CATEGORIES = [
  { key:'burgers', title:'–ë—É—Ä–≥–µ—Ä—ã', items:[
    { name:'–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä', price:280, img:'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
    { name:'–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price:340, img:'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä',  price:200, img:'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price:250, img:'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
    { name:'–ß–∏–∑–±—É—Ä–≥–µ—Ä', price:220 }
  ]},
  { key:'twisters', title:'–¢–≤–∏—Å—Ç–µ—Ä—ã', items:[ { name:'–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price:200 }, { name:'–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å', price:250 } ]},
  { key:'drinks',  title:'–ù–∞–ø–∏—Ç–∫–∏', items:[ { name:'–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price:100 }, { name:'–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price:100 }, { name:'–°–ø—Ä–∞–π—Ç', price:100 }, { name:'–≠—Å–ø—Ä–µ—Å—Å–æ', price:120 } ]},
  { key:'sushi',   title:'–°—É—à–∏ / —Ä–æ–ª–ª—ã', items:[ { name:'–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price:350 }, { name:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price:390 }, { name:'–ê–ª—è—Å–∫–∞', price:350 } ]},
  { key:'semi',    title:'–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã', items:[ { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 6 —à—Ç.', price:160 }, { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 9 —à—Ç.', price:210 }, { name:'–°—Ç—Ä–∏–ø—Å—ã', price:190 } ]},
];

/* ===== –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ –ø–æ X (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞) ===== */
function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2 }
function animateScrollX(el, to, {duration=280, onStart, onEnd}={}){
  const from = el.scrollLeft; const diff = to - from; if (diff===0){ onStart&&onStart(); onEnd&&onEnd(); return; }
  const startTs = performance.now(); onStart&&onStart();
  function step(ts){ const t=Math.min(1,(ts-startTs)/duration); el.scrollLeft = from + diff*easeInOutCubic(t); t<1?requestAnimationFrame(step):onEnd&&onEnd(); }
  requestAnimationFrame(step);
}

/* ===== ORDER (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª: 1 —Å–≤–∞–π–ø = 1 –∫–∞—Ç–µ–≥–æ—Ä–∏—è) ===== */
function OrderView(){
  const root=el(`
    <div class="relative">
      <section class="sticky-top mb-2">
        <div class="glass-panel rounded-2xl px-3 py-3">
          <div id="categoryBar" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
        </div>
      </section>
      <section><div id="catPager" class="no-scrollbar"></div></section>
      <div id="confirmBar" class="confirm-bar">
        <div class="flex items-center justify-between gap-3">
          <div class="text-base"><span class="text-gray-600">–ò—Ç–æ–≥–æ:</span> <b id="totalVal">0 —Ä—É–±.</b></div>
          <button id="confirmBtn" class="px-4 py-3 rounded-xl bg-black text-white disabled:opacity-40 disabled:cursor-not-allowed">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </div>
  `);

  const categoryBar=root.querySelector('#categoryBar');
  const catPager=root.querySelector('#catPager');
  const confirmBar=root.querySelector('#confirmBar');
  const totalEl=root.querySelector('#totalVal');
  const confirmBtn=root.querySelector('#confirmBtn');

  setBodyScrollLock(true);

  const counts={}; const scrollMemory=new Map();
  let activeIdx=0, isAnimating=false;
  const panelW = ()=> catPager.getBoundingClientRect().width || 1;

  // —á–∏–ø—ã
  MENU_CATEGORIES.forEach((cat,idx)=>{
    categoryBar.appendChild(el(`<button type="button" class="px-3 py-1.5 rounded-full border text-sm whitespace-nowrap ${idx===0?'bg-black text-white border-black':'bg-white/50'}" data-idx="${idx}">${cat.title}</button>`));
  });
  function highlightChip(idx){
    categoryBar.querySelectorAll('button').forEach((b,i)=>{
      const on=i===idx; b.classList.toggle('bg-black',on); b.classList.toggle('text-white',on); b.classList.toggle('border-black',on);
      if(on) b.scrollIntoView({inline:'center', block:'nearest', behavior:'smooth'});
    });
  }
  function goToIndex(idx,{animate=true}={}){
    idx=Math.max(0,Math.min(MENU_CATEGORIES.length-1,idx));
    const target = Math.round(panelW()*idx);
    highlightChip(idx);
    if(!animate){ catPager.scrollLeft=target; activeIdx=idx; return }
    isAnimating=true; const prevSnap=catPager.style.scrollSnapType; catPager.style.scrollSnapType='none';
    const old=catPager.children[activeIdx]?.querySelector('.v-scroll'); if(old){ scrollMemory.set(MENU_CATEGORIES[activeIdx].key, old.scrollTop); }
    animateScrollX(catPager, target, { duration:280, onEnd(){
      const box=catPager.children[idx]?.querySelector('.v-scroll'); if(box){ box.scrollTop = scrollMemory.get(MENU_CATEGORIES[idx].key)||0; }
      activeIdx=idx; isAnimating=false; catPager.style.scrollSnapType=prevSnap||'x mandatory';
    }});
  }
  categoryBar.addEventListener('click', e=>{ const b=e.target.closest('button[data-idx]'); if(!b||isAnimating) return; goToIndex(+b.dataset.idx,{animate:true}) });

  // –ø–∞–Ω–µ–ª–∏
  function buildPanels(){
    catPager.innerHTML='';
    MENU_CATEGORIES.forEach((cat, idx)=>{
      const panel=el(`<div class="cat-panel"></div>`), vbox=el(`<div class="v-scroll px-0.5"></div>`), list=el(`<div class="grid gap-3"></div>`);
      cat.items.forEach(it=>{
        const q=counts[it.name]||0;
        list.appendChild(el(`
          <div class="menu-card">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm">${it.name}</div>
              <div class="text-xs text-gray-500 mt-1">${money(it.price)}</div>
              <div class="flex items-center gap-3 mt-3">
                <button type="button" class="w-8 h-8 rounded-xl border" data-name="${it.name}" data-act="dec">‚àí</button>
                <div class="w-6 text-center text-sm" data-q="${it.name}">${q}</div>
                <button type="button" class="w-8 h-8 rounded-xl bg-black text-white" data-name="${it.name}" data-act="inc">+</button>
              </div>
            </div>
            <img src="${it.img||'https://placehold.co/110x70?text=food'}" class="menu-card-img" alt="">
          </div>`));
      });
      list.appendChild(el(`<div class="h-24"></div>`));
      vbox.appendChild(list); panel.appendChild(vbox); catPager.appendChild(panel);

      // Pointer-—Å–≤–∞–π–ø: 1 –∂–µ—Å—Ç = ¬±1 –∏–Ω–¥–µ–∫—Å
      let down=false, used=false, sx=0, sy=0, locked=null;
      const PIX_LOCK=10, THRESH = ()=> Math.max(40, panelW()*0.25);
      vbox.addEventListener('pointerdown',e=>{ if(isAnimating) return; down=true; used=false; sx=e.clientX; sy=e.clientY; locked=null; vbox.setPointerCapture(e.pointerId); });
      vbox.addEventListener('pointermove',e=>{
        if(!down||used||isAnimating) return;
        const dx=e.clientX-sx, dy=e.clientY-sy;
        if(locked===null){
          if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>PIX_LOCK) locked='x';
          else if(Math.abs(dy)>Math.abs(dx) && Math.abs(dy)>PIX_LOCK) locked='y';
        }
        if(locked==='x'){
          e.preventDefault();
          if(Math.abs(dx)>=THRESH()){ used=true; const next = dx<0?activeIdx+1:activeIdx-1; goToIndex(next,{animate:true}); }
        }
      }, {passive:false});
      const endPtr = (e)=>{ down=false; used=false; locked=null; try{ vbox.releasePointerCapture?.(e.pointerId); }catch{} };
      ['pointerup','pointercancel','pointerleave'].forEach(evt=> vbox.addEventListener(evt,endPtr));
    });

    if(!catPager._plusMinusBound){
      catPager.addEventListener('click', e=>{
        const act=e.target?.dataset?.act; if(!act) return;
        const name=e.target.dataset.name;
        if(act==='inc') counts[name]=(counts[name]||0)+1; else counts[name]=Math.max(0,(counts[name]||0)-1);
        catPager.querySelectorAll(`[data-q="${CSS.escape(name)}"]`).forEach(n=> n.textContent=counts[name]||0);
        recalcTotal();
      });
      catPager._plusMinusBound=true;
    }

    applyHeights(); setTimeout(applyHeights,60);
  }

  function applyHeights(){
    const headerH=document.getElementById('appHeader').getBoundingClientRect().height;
    const chipsH=root.querySelector('.sticky-top').getBoundingClientRect().height;
    const confirmH=confirmBar.getBoundingClientRect().height;
    const availH=Math.max(240, window.innerHeight - headerH - chipsH - confirmH - 8);
    const first=catPager.querySelector('.menu-card'); const cardH=first?Math.ceil(first.getBoundingClientRect().height):104;
    const h=Math.min(availH, cardH*4 + 12*3 + 4);
    root.querySelectorAll('.v-scroll').forEach(el=> el.style.height=h+'px');
    goToIndex(activeIdx,{animate:false});
  }
  window.addEventListener('resize', applyHeights);

  catPager.addEventListener('scroll', ()=>{
    if (isAnimating) return;
    if (catPager._scrollTimer) clearTimeout(catPager._scrollTimer);
    catPager._scrollTimer = setTimeout(()=>{
      const idx = Math.round(catPager.scrollLeft / (catPager.getBoundingClientRect().width||1));
      if(idx!==activeIdx){ highlightChip(idx); activeIdx=idx; }
    }, 80);
  });

  function recalcTotal(){
    let sum=0; MENU_CATEGORIES.forEach(cat=>cat.items.forEach(it=> sum += (counts[it.name]||0)*it.price ));
    totalEl.textContent=money(sum); confirmBtn.disabled = sum<=0; return sum;
  }

  confirmBtn.addEventListener('click', ()=>{
    const items=[]; MENU_CATEGORIES.forEach(cat=>cat.items.forEach(it=>{ const q=counts[it.name]||0; if(q>0) items.push({name:it.name, qty:q, price:it.price}); }));
    if(!items.length){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã'); return }
    const total = items.reduce((s,i)=>s+i.price*i.qty,0);
    const prof=loadProfile();
    if(!prof.name || !prof.phone || !prof.address){ showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –∞–¥—Ä–µ—Å'); location.hash='#/profile'; return }
    // –î–æ–±–∞–≤–∏–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    const list=loadHistory();
    list.unshift({ id: Date.now().toString().slice(-6), createdAt: Date.now(), items, total, status:'–Ω–æ–≤—ã–π' });
    saveHistory(list.slice(0,50));
    showToast('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    // –æ–±–Ω—É–ª–∏–º –≤—ã–±–æ—Ä
    Object.keys(counts).forEach(k=> counts[k]=0); catPager.querySelectorAll('[data-q]').forEach(n=> n.textContent='0'); recalcTotal();
  });

  buildPanels(); highlightChip(0); requestAnimationFrame(()=> goToIndex(0,{animate:false})); recalcTotal();
  root.cleanup = ()=> setBodyScrollLock(false);
  return root;
}

/* ===== –õ–∏—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ (–æ–±—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç) ===== */
function openHistorySheet(){
  let sheet=document.getElementById('historySheet');
  if(!sheet){
    sheet = el(`<div id="historySheet" class="sheet">
      <div class="sheet-panel">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
          <div class="flex gap-2">
            <button id="histClear" class="px-3 py-1.5 rounded-xl border text-sm">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <button id="histClose" class="px-3 py-1.5 rounded-xl border text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <div id="historyList" class="grid gap-2"></div>
      </div>
    </div>`);
    document.body.appendChild(sheet);
    sheet.addEventListener('click',e=>{ if(e.target===sheet) sheet.classList.remove('open') });
    sheet.querySelector('#histClose').onclick=()=> sheet.classList.remove('open');
    sheet.querySelector('#histClear').onclick=()=>{
      if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')){
        saveHistory([]); renderHistory();
      }
    };
  }
  function renderHistory(){
    const box=sheet.querySelector('#historyList'); const list=loadHistory();
    box.innerHTML='';
    if(!list.length){ box.innerHTML='<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>'; return }
    list.forEach((o,idx)=>{
      const items=o.items?.map(i=>`${i.name} √ó${i.qty}`).join(', ')||'‚Äî';
      const card=el(`<div class="p-3 rounded-xl border bg-white flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-sm font-semibold">#${o.id||'‚Äî'} ¬∑ ${o.status||''}</div>
          <div class="text-xs text-gray-500">${o.createdAt? new Date(o.createdAt).toLocaleString():''}</div>
          <div class="text-sm mt-1">${money(o.total||0)}</div>
          <div class="text-xs text-gray-600 mt-1 truncate">${items}</div>
        </div>
        <button class="text-xs text-red-500" data-del>–£–¥–∞–ª–∏—Ç—å</button>
      </div>`);
      card.querySelector('[data-del]').onclick=()=>{
        const cur=loadHistory(); cur.splice(idx,1); saveHistory(cur); renderHistory();
      };
      box.appendChild(card);
    });
  }
  renderHistory();
  sheet.classList.add('open');
}

/* ===== –ü–û–î–î–ï–†–ñ–ö–ê (—á–∞—Ç —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏, –ª–æ–∫–∞–ª—å–Ω–æ) ===== */
function SupportView(){
  const root=el(`
    <div class="grid gap-3 pb-24">
      <section class="glass-panel rounded-2xl p-4">
        <h2 class="text-lg font-semibold">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
        <p class="text-xs text-gray-600">–ü–∏—à–∏—Ç–µ –Ω–∞–º –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–π—Ç–µ —Ñ–æ—Ç–æ. –¢–µ–ª.: <a href="tel:+798989932108" class="underline">+7 989 899 32 108</a>, –ø–æ—á—Ç–∞: <a href="mailto:sabirbis@bk.ru" class="underline">sabirbis@bk.ru</a></p>
      </section>
      <section class="rounded-2xl bg-white border p-0 overflow-hidden">
        <div id="chatList" class="p-3 space-y-2 max-h-[55vh] overflow-auto"></div>
        <div class="border-t p-2 flex items-center gap-2">
          <input type="file" id="chatAttach" accept="image/*" multiple class="hidden">
          <button id="attachBtn" class="px-3 py-2 rounded-xl border">üìé</button>
          <input id="chatInput" class="flex-1 border rounded-xl p-2" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶">
          <button id="sendBtn" class="px-3 py-2 rounded-xl bg-black text-white">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>
    </div>
  `);

  const chatList=root.querySelector('#chatList');
  const input=root.querySelector('#chatInput');
  const send=root.querySelector('#sendBtn');
  const attachBtn=root.querySelector('#attachBtn');
  const attach=root.querySelector('#chatAttach');

  function render(){
    const msgs=loadChat();
    chatList.innerHTML='';
    msgs.forEach(m=>{
      const bubble=el(`<div class="max-w-[85%] ${m.role==='user'?'ml-auto':''}">
        <div class="rounded-2xl px-3 py-2 ${m.role==='user'?'bg-black text-white':'bg-gray-100'} shadow">
          <div class="text-sm whitespace-pre-wrap">${m.text||''}</div>
          ${m.images?.length? `<div class="mt-2 grid grid-cols-3 gap-2">${m.images.map(src=>`<img src="${src}" class="w-full h-20 object-cover rounded-xl border">`).join('')}</div>`:''}
          <div class="text-[10px] opacity-70 mt-1">${new Date(m.ts).toLocaleTimeString()}</div>
        </div>
      </div>`);
      chatList.appendChild(bubble);
    });
    chatList.scrollTop = chatList.scrollHeight;
  }

  attachBtn.onclick=()=> attach.click();
  send.onclick=()=>{
    const text=(input.value||'').trim(); const files=[...attach.files||[]];
    if(!text && !files.length){ return }
    const images=[];
    if(files.length){
      // —á–∏—Ç–∞–µ–º –∫–∞–∫ dataURL, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –∏ —Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
      let pending=files.length;
      files.forEach(f=>{
        const fr=new FileReader();
        fr.onload=()=>{ images.push(fr.result); if(--pending===0) commit(); };
        fr.readAsDataURL(f);
      });
    }else commit();

    function commit(){
      const msgs=loadChat();
      msgs.push({ role:'user', text, images, ts:Date.now() });
      saveChat(msgs); input.value=''; attach.value=''; render();
      // —ç–º—É–ª–∏—Ä—É–µ–º –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å)
      setTimeout(()=>{
        const ms=loadChat(); ms.push({ role:'agent', text:'–°–ø–∞—Å–∏–±–æ! –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è üëå', images:[], ts:Date.now() }); saveChat(ms); render();
      }, 600);
    }
  };

  render();
  return root;
}

/* ===== –ü–†–û–§–ò–õ–¨: –¥–≤–µ –±–ª–æ–∫-–∫–Ω–æ–ø–∫–∏ + –±–∞–Ω–Ω–µ—Ä + —Å—Ç—Ä–æ–∫–∏ ===== */
function ProfileView(){
  const p=Object.assign({ name:'', phone:'', address:'', paymentMethod:'' }, loadProfile());
  const last4 = loadHistory().slice(0,4);

  const root=el(`
    <div class="grid gap-4 pb-24">
      <div class="grid grid-cols-2 gap-3">
        <!-- –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è -->
        <button class="block-btn soft text-left" id="profileEdit">
          <div class="text-2xl mb-1">üë§</div>
          <div class="text-sm font-semibold mb-1">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
          <div class="text-xs text-gray-600 leading-snug">
            ${p.name? `–ò–º—è: ${p.name}<br>`:''}
            ${p.phone? `–¢–µ–ª.: ${p.phone}<br>`:''}
            ${p.address? `–ê–¥—Ä–µ—Å: ${p.address}<br>`:''}
            ${p.paymentMethod? `–û–ø–ª–∞—Ç–∞: ${p.paymentMethod}`:''}
            ${(!p.name&&!p.phone&&!p.address&&!p.paymentMethod)?'–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è':''}
          </div>
        </button>

        <!-- –ë–ª–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ -->
        <button class="block-btn soft text-left" id="historyOpen">
          <div class="text-2xl mb-1">üßæ</div>
          <div class="text-sm font-semibold mb-1">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="space-y-1">
            ${ last4.length ? last4.map(o=>`
              <div class="text-[11px] text-gray-600 truncate">#${o.id} ¬∑ ${money(o.total||0)} ¬∑ ${new Date(o.createdAt).toLocaleDateString()}</div>
            `).join('') : `<div class="text-xs text-gray-500">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`}
          </div>
        </button>
      </div>

      <!-- –†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä -->
      <section class="promo">
        <div class="text-sm opacity-80">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π –≤–∫—É—Å</div>
        <div class="text-xl font-semibold mt-1">–°–∫–∏–¥–∫–∞ 10% –Ω–∞ –ø–µ—Ä–≤—ã–µ —Ä–æ–ª–ª—ã</div>
        <div class="text-xs opacity-80 mt-1">–û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –æ–Ω–ª–∞–π–Ω ‚Äî –±—ã—Å—Ç—Ä–µ–µ –∏ –≤—ã–≥–æ–¥–Ω–µ–µ.</div>
      </section>

      <!-- –¢—Ä–∏ —Å—Ç—Ä–æ–∫–∏ -->
      <section class="rounded-2xl bg-white border">
        <button id="goSupport" class="w-full text-left px-4 py-3 border-b">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        <button id="goLegal"   class="w-full text-left px-4 py-3 border-b">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
        <button id="goDev"     class="w-full text-left px-4 py-3">–û —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–µ</button>
      </section>

      <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è -->
      <section class="glass-panel rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="grid gap-3">
          <input id="pName" class="border rounded-xl p-3" placeholder="–ò–º—è" value="${p.name||''}">
          <input id="pPhone" class="border rounded-xl p-3" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7‚Ä¶)" value="${p.phone||''}">
          <input id="pAddr" class="border rounded-xl p-3" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" value="${p.address||''}">
          <select id="pPay" class="border rounded-xl p-3">
            <option value="">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã‚Ä¶</option>
            <option value="–ù–∞–ª–∏—á–Ω—ã–µ" ${p.paymentMethod==='–ù–∞–ª–∏—á–Ω—ã–µ'?'selected':''}>–ù–∞–ª–∏—á–Ω—ã–µ</option>
            <option value="–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞" ${p.paymentMethod==='–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞'?'selected':''}>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
            <option value="–ü–µ—Ä–µ–≤–æ–¥" ${p.paymentMethod==='–ü–µ—Ä–µ–≤–æ–¥'?'selected':''}>–ü–µ—Ä–µ–≤–æ–¥</option>
          </select>
          <button id="pSave" class="px-4 py-3 rounded-xl bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </section>
    </div>
  `);

  // –ù–∞–≤–∏–≥–∞—Ü–∏–∏
  root.querySelector('#historyOpen').onclick = ()=> openHistorySheet();
  root.querySelector('#profileEdit').onclick = ()=>{
    root.querySelector('#pName').focus();
    showToast('–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª');
  };
  root.querySelector('#goSupport').onclick = ()=> { location.hash = '#/support' };
  root.querySelector('#goLegal').onclick = ()=> alert('–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ.');
  root.querySelector('#goDev').onclick   = ()=> alert('–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞: sabirbis@bk.ru');

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
  root.querySelector('#pSave').onclick = ()=>{
    const p2={ name:root.querySelector('#pName').value.trim(),
               phone:root.querySelector('#pPhone').value.trim(),
               address:root.querySelector('#pAddr').value.trim(),
               paymentMethod:root.querySelector('#pPay').value||'' };
    saveProfile(p2); showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  };

  return root;
}

/* ===== Router ===== */
function router(){
  const app=document.getElementById('app');
  if (app.firstChild && typeof app.firstChild.cleanup === 'function') { try{ app.firstChild.cleanup(); }catch{} }
  app.innerHTML='';
  const hash=location.hash;
  if(hash==='#/profile'){ app.classList.add('phone-shell'); app.appendChild(ProfileView()) }
  else if(hash==='#/support'){ app.classList.add('phone-shell'); app.appendChild(SupportView()) }
  else { app.classList.add('phone-shell'); app.appendChild(OrderView()) }
}
window.addEventListener('hashchange', router);
router();

/* Header actions */
document.getElementById('profileBtn').onclick=()=>{ location.hash='#/profile' };
</script>
</body>
</html>
