<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <!-- –≤–∞–∂–Ω–æ–µ: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∑—É–º –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω—ã -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>üçü –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑ (–∫–ª–∏–µ–Ω—Ç + —Ç–∞–±–ª–æ)</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <style>
    .toast{
      position:fixed; right:1rem; bottom:1rem;
      background:#111; color:#fff;
      padding:.75rem 1rem; border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.2);
      opacity:.95; z-index:9999
    }
    .hidden{ display:none }
    body{ background:#f9fafb; }

    /* –∫–æ–Ω—Ç–µ–Ω—Ç–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω ‚Äî –∫–∞–∫ –Ω–∞ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–Ω–µ */
    .phone-shell{
      width: 100%;
      max-width: 460px;    /* –∫–ª—é—á–µ–≤–æ–µ –º–µ—Å—Ç–æ */
      margin: 0 auto;
    }

    /* –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
    #menuScroll{
      max-height: 15.5rem;        /* ~2 –∫–∞—Ä—Ç–æ—á–∫–∏ */
      overflow-y: auto;
      padding-right: .25rem;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∫–æ–ª–æ–Ω–∫–∞ */
    #menuGrid{
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    /* –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ (–∫–∞–∫ —É —Ç–µ–±—è) */
    .menu-card{
      display: flex;
      gap: .75rem;
      align-items: center;
      background: #fff;
      border: 1px solid #edf2f7;
      border-radius: 1.25rem;
      padding: 1rem;
      min-height: 6.4rem;
    }
    .menu-card-body{
      flex: 1 1 auto;
      min-width: 0;
    }
    .menu-card-img{
      width: 110px;
      height: 70px;
      border-radius: .75rem;
      background: #eee;
      flex: 0 0 auto;
      object-fit: cover;
    }

    /* —á—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª –∏–Ω–ø—É—Ç—ã */
    input, select, textarea, button { font-size: 16px; }

    /* —á—É—Ç—å –º–µ–Ω—å—à–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö */
    @media (max-width: 640px) {
      header h1 { font-size: 1.4rem; }
    }

    /* –Ω–∞ –±–æ–ª—å—à–∏—Ö ‚Äî –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ç–∫—É 2‚Äì4 –≤ —Ä—è–¥,
       –ù–û —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —ç–∫—Ä–∞–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–æ–π,
       —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –≤–∏–¥ */
    @media (min-width: 1024px) {
      /* —Å–Ω–∏–º–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 460px, –¥–∞—ë–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É */
      .phone-shell{
        max-width: 100%;
      }
      #menuScroll{
        max-height: none;    /* –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø—É—Å—Ç—å –≤—Å—ë –≤–∏–¥–Ω–æ —Å—Ä–∞–∑—É */
        overflow-y: visible;
      }
      #menuGrid{
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      .menu-card{
        min-height: 7rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="w-full max-w-6xl mx-auto px-3 sm:px-6 py-6">
    <!-- —à–∞–ø–∫–∞ -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 gap-3">
      <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">üçü –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑</h1>
      <nav class="flex gap-2 items-center">
        <a id="toClient" href="#/order" class="px-3 py-2 rounded-xl border text-sm sm:text-base">–ö–ª–∏–µ–Ω—Ç</a>
        <button id="openDashboard" type="button" class="px-3 py-2 rounded-xl border text-sm sm:text-base">–¢–∞–±–ª–æ</button>
        <button id="hardRefresh" type="button" class="px-3 py-2 rounded-xl border text-sm sm:text-base">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </nav>
    </header>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–∏–Ω-–∫–æ–¥–∞ -->
    <div id="pinModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
      <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow">
        <h3 class="text-lg font-semibold mb-3">–í—Ö–æ–¥ –≤ —Ç–∞–±–ª–æ</h3>
        <p class="text-sm text-gray-600 mb-3">–í–≤–µ–¥–∏—Ç–µ –ø–∏–Ω-–∫–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <input id="pinInput" type="password" class="w-full border rounded-xl p-3 mb-4" placeholder="–ü–∏–Ω-–∫–æ–¥" />
        <div class="flex gap-2 justify-end">
          <button id="pinCancel" type="button" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
          <button id="pinOk" type="button" class="px-3 py-2 rounded-xl border bg-black text-white">–í–æ–π—Ç–∏</button>
        </div>
        <p id="pinError" class="text-sm text-red-600 mt-2 hidden">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∏–Ω</p>
      </div>
    </div>

    <main id="app"></main>

    <p class="mt-6 text-sm text-gray-500">
      –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –Ø–Ω–¥–µ–∫—Å Cloud.
      –¢–∞–±–ª–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥.
    </p>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
/* ====== –ù–ê–°–¢–†–û–ô–ö–ò ====== */
const ALLOWED_PIN = "65Vafuza";
/* –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–∞ vercel / localhost ‚Üí —Ö–æ–¥–∏–º –Ω–∞ /api/order,
   –∏–Ω–∞—á–µ ‚Üí –ø—Ä—è–º–æ –≤ —Ç–≤–æ–π —è–Ω–¥–µ–∫—Å */
const API_BASE = (
  location.hostname.endsWith('.vercel.app') ||
  location.hostname === 'localhost'
) ? '/api/order'
  : 'https://d5d1ec44lv5uk5k7k9to.bixf7e87.apigw.yandexcloud.net/order';

/* —Å—Ä–∞–∑—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ */
if (!location.hash || location.hash === "#/" || location.hash === "#") {
  location.hash = "#/order";
}

/* ====== clientId ====== */
function getClientId() {
  const KEY = 'yc_client_id_v1';
  let cid = localStorage.getItem(KEY);
  if (!cid) {
    cid = 'cid-' + Math.random().toString(36).slice(2) + Date.now();
    localStorage.setItem(KEY, cid);
  }
  return cid;
}

/* ====== —É—Ç–∏–ª–∏—Ç—ã ====== */
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), 2500);
}
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function money(x){ return x + ' —Ä—É–±.' }

/* ====== –ª–æ–∫–∞–ª—å–Ω—ã–π –æ—Ñ—Ñ–ª–∞–π–Ω ====== */
const LS_KEY = 'orders_yc_fallback_v1';
const store = {
  load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{orders:[], nextId:1}; }catch{ return {orders:[], nextId:1}; } },
  save(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
};

/* ====== –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É ====== */
async function ycCall(op, extra={}) {
  try {
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ op, ...extra })
    });
    return await res.json();
  } catch (e) {
    console.warn("YC error:", e);
    return { error: "network" };
  }
}

/* ====== –º–µ–Ω—é —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ ====== */
const MENU_CATEGORIES = [
  {
    key: 'burgers',
    title: '–ë—É—Ä–≥–µ—Ä—ã',
    items: [
      { name: '–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä', price: 280, img: 'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
      { name: '–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price: 340, img: 'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
      { name: '–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä', price: 200, img: 'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
      { name: '–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price: 250, img: 'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
    ]
  },
  {
    key: 'twisters',
    title: '–¢–≤–∏—Å—Ç–µ—Ä—ã',
    items: [
      { name: '–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price: 200 },
      { name: '–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å', price: 250 },
    ]
  },
  {
    key: 'drinks',
    title: '–ù–∞–ø–∏—Ç–∫–∏',
    items: [
      { name: '–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price: 100 },
      { name: '–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price: 100 },
      { name: '–°–ø—Ä–∞–π—Ç', price: 100 },
      { name: '–≠—Å–ø—Ä–µ—Å—Å–æ', price: 120 },
      { name: '–ë–∞–Ω–∞–Ω–æ–≤—ã–π —Ä–∞—Ñ', price: 180 },
      { name: '–ß–∞–π —á—ë—Ä–Ω—ã–π', price: 70 },
    ]
  },
  {
    key: 'sushi',
    title: '–°—É—à–∏ / —Ä–æ–ª–ª—ã',
    items: [
      { name: '–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price: 350 },
      { name: '–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price: 390 },
      { name: '–ê–ª—è—Å–∫–∞', price: 350 },
    ]
  },
  {
    key: 'potato',
    title: '–ö–∞—Ä—Ç–æ—à–∫–∞',
    items: [
      { name: '–§—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏–π', price: 150 },
      { name: '–§—Ä–∏ –±–æ–ª—å—à–æ–π', price: 180 },
      { name: '–ü–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏ –º–∞–ª–µ–Ω—å–∫–∏–π', price: 160 },
      { name: '–ü–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏ –±–æ–ª—å—à–æ–π', price: 200 },
    ]
  },
];

/* ====== –≠–ö–†–ê–ù –ö–õ–ò–ï–ù–¢–ê ====== */
function OrderView(){
  const root = el(`
    <div class="phone-shell grid gap-4 sm:gap-6">
      <section class="p-4 sm:p-5 rounded-2xl bg-white border">
        <h2 class="text-lg sm:text-xl font-semibold mb-3">–ú–µ–Ω—é</h2>
        <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div id="categoryBar" class="flex gap-2 overflow-x-auto pb-2 -mx-1 px-1">
          ${MENU_CATEGORIES.map((cat,idx)=>`
            <button data-cat="${cat.key}" class="whitespace-nowrap px-3 py-2 rounded-full border ${idx===0?'bg-black text-white':''}">
              ${cat.title}
            </button>
          `).join('')}
        </div>
        <!-- –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div id="menuScroll" class="mt-3">
          <div id="menuGrid"></div>
        </div>
      </section>

      <section class="p-4 sm:p-5 rounded-2xl bg-white border">
        <h2 class="text-lg sm:text-xl font-semibold mb-4">–î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
        <form class="grid gap-4" id="orderForm">
          <input class="border rounded-xl p-3" placeholder="–ò–º—è" name="name" required />
          <input class="border rounded-xl p-3" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä +7...)" name="phone" required />
          <input class="border rounded-xl p-3" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" name="address" required />
          <label class="flex items-center gap-3">
            <input type="checkbox" name="deliverByTime" />
            <span>–î–æ—Å—Ç–∞–≤–∏—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–∏</span>
          </label>
          <input class="border rounded-xl p-3 hidden" type="time" name="deliverTime" />
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div class="text-lg"><span class="font-semibold">–ò—Ç–æ–≥–æ:</span> <span id="total">0 —Ä—É–±.</span></div>
            <button id="sendBtn" class="px-4 py-2 rounded-xl border bg-black text-white flex-shrink-0" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
          </div>
        </form>
      </section>

      <section id="result"></section>
    </div>
  `);

  const categoryBar = root.querySelector('#categoryBar');
  const menuGrid = root.querySelector('#menuGrid');
  const menuScroll = root.querySelector('#menuScroll');
  const form = root.querySelector('#orderForm');
  const totalEl = root.querySelector('#total');
  const deliverChk = form.deliverByTime;
  const deliverTime = form.deliverTime;
  const sendBtn = root.querySelector('#sendBtn');

  const counts = {};
  let currentCategory = MENU_CATEGORIES[0].key;

  function recalcTotal(){
    let sum = 0;
    for (const cat of MENU_CATEGORIES){
      for (const item of cat.items){
        const q = counts[item.name] || 0;
        sum += item.price * q;
      }
    }
    totalEl.textContent = money(sum);
  }

  function renderCategory(catKey){
    currentCategory = catKey;
    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    categoryBar.querySelectorAll('button').forEach(btn=>{
      btn.classList.remove('bg-black','text-white');
      if (btn.dataset.cat === catKey){
        btn.classList.add('bg-black','text-white');
      }
    });
    const cat = MENU_CATEGORIES.find(c=>c.key===catKey);
    menuGrid.innerHTML = '';
    cat.items.forEach(item=>{
      const q = counts[item.name] || 0;
      const card = el(`
        <div class="menu-card">
          <div class="menu-card-body">
            <div class="text-base sm:text-lg font-medium">${item.name}</div>
            <div class="inline-flex items-center mt-2 px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${money(item.price)}</div>
            <div class="flex items-center gap-3 mt-3">
              <button type="button" class="w-9 h-9 rounded-xl border flex items-center justify-center" data-act="dec">‚àí</button>
              <div class="w-6 text-center" data-q>${q}</div>
              <button type="button" class="w-9 h-9 rounded-xl border bg-black text-white flex items-center justify-center" data-act="inc">+</button>
            </div>
          </div>
          <img src="${item.img || 'https://placehold.co/110x70?text=food'}" alt="" class="menu-card-img">
        </div>
      `);
      const qEl = card.querySelector('[data-q]');
      card.addEventListener('click', e=>{
        if (e.target.dataset.act === 'inc'){
          counts[item.name] = (counts[item.name] || 0) + 1;
          qEl.textContent = counts[item.name];
          recalcTotal();
        }
        if (e.target.dataset.act === 'dec'){
          counts[item.name] = Math.max(0, (counts[item.name] || 0) - 1);
          qEl.textContent = counts[item.name];
          recalcTotal();
        }
      });
      menuGrid.appendChild(card);
    });
  }

  renderCategory(currentCategory);

  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
  categoryBar.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-cat]');
    if (!btn) return;
    renderCategory(btn.dataset.cat);
  });

  // —Å–≤–∞–π–ø –ø–æ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤ ‚Üí –ª–∏—Å—Ç–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  let touchStartX = 0;
  menuScroll.addEventListener('touchstart', e=>{
    touchStartX = e.touches[0].clientX;
  }, {passive:true});
  menuScroll.addEventListener('touchend', e=>{
    const dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) < 50) return;
    const idx = MENU_CATEGORIES.findIndex(c=>c.key===currentCategory);
    if (dx < 0 && idx < MENU_CATEGORIES.length - 1){
      renderCategory(MENU_CATEGORIES[idx+1].key);
    } else if (dx > 0 && idx > 0){
      renderCategory(MENU_CATEGORIES[idx-1].key);
    }
  });

  // –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏
  deliverChk.addEventListener('change', ()=>{
    deliverTime.classList.toggle('hidden', !deliverChk.checked);
    if (!deliverChk.checked) deliverTime.value='';
  });

  function resetAll(){
    for (const key in counts) delete counts[key];
    renderCategory(currentCategory);
    totalEl.textContent = '0 —Ä—É–±.';
    form.reset();
    deliverTime.classList.add('hidden');
  }

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (sendBtn.disabled) return;
    sendBtn.disabled = true;
    sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';

    const items = [];
    for (const cat of MENU_CATEGORIES){
      for (const item of cat.items){
        const qty = counts[item.name] || 0;
        if (qty > 0){
          items.push({ name: item.name, qty });
        }
      }
    }

    if (!items.length){
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã');
      sendBtn.disabled = false;
      sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
      return;
    }

    const total = items.reduce((s,i)=>{
      let price = 0;
      for (const c of MENU_CATEGORIES){
        const f = c.items.find(it=>it.name===i.name);
        if (f){ price = f.price; break; }
      }
      return s + price * i.qty;
    }, 0);

    const payload = {
      clientId: getClientId(),
      name: form.name.value.trim(),
      phone: form.phone.value.trim(),
      address: form.address.value.trim(),
      deliverByTime: form.deliverByTime.checked,
      deliverTime: form.deliverTime.value || null,
      items
    };

    const res = await ycCall("create", { data: payload });

    // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≤ –ª–æ–∫–∞–ª
    if (res.error){
      const data = store.load();
      const id = data.nextId++;
      const now = Date.now();
      const order = { id, ...payload, total, status:'–Ω–æ–≤—ã–π', createdAt:now, updatedAt:now, _source:'local' };
      data.orders.unshift(order); store.save(data);
      showToast('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)');
      resetAll();
      sendBtn.disabled = false;
      sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
      return;
    }

    const o = res.order || { id: '‚Äî', status: '–Ω–æ–≤—ã–π', total };
    root.querySelector('#result').innerHTML = `
      <div class="p-4 sm:p-5 rounded-2xl bg-white border">
        <div class="text-lg sm:text-xl font-semibold mb-2">–°–ø–∞—Å–∏–±–æ! –ó–∞–∫–∞–∑ #${o.id} –ø—Ä–∏–Ω—è—Ç.</div>
        <div class="text-gray-700">
          –°—Ç–∞—Ç—É—Å: <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${o.status}</span>
          ¬∑ –ò—Ç–æ–≥: <b>${o.total} —Ä—É–±.</b>
        </div>
      </div>`;
    showToast(res.dedup ? '–ó–∞–∫–∞–∑ —É–∂–µ –±—ã–ª, –ø–æ–∫–∞–∑–∞–ª–∏ –µ–≥–æ' : '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');

    resetAll();
    sendBtn.disabled = false;
    sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
  });

  return root;
}

/* ====== –¢–ê–ë–õ–û (—Å —É–¥–∞–ª–µ–Ω–∏–µ–º) ====== */
function DashboardView(){
  const root = el(`
    <div class="grid gap-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h2>
        <div class="flex gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border" id="enableSound">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
          <button type="button" class="px-3 py-2 rounded-xl border" id="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="grid gap-4" id="list"></div>
    </div>
  `);

  const list = root.querySelector('#list');
  let audioCtx = null;
  let soundEnabled = false;

  function playBeep(duration = 0.35, freq = 880) {
    if (!audioCtx || !soundEnabled) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.35, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  root.querySelector('#enableSound').addEventListener('click', async () => {
    try {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      soundEnabled = true;
      playBeep(); setTimeout(()=>playBeep(), 200);
      showToast("–ó–≤—É–∫ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤–∫–ª—é—á—ë–Ω");
      root.querySelector('#enableSound').textContent = "üîî –ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω";
    } catch (e) {
      showToast("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–∞–ª –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫");
    }
  });

  root.querySelector('#refresh').addEventListener('click', ()=> location.reload());

  const seenIds = new Set();

  function orderCard(o){
    const created = o.createdAt ? new Date(o.createdAt) : new Date();
    const itemLines = (o.items || []).map(i=>`${i.name} √ó${i.qty}`).join(', ');
    const card = el(`
      <div class="p-5 rounded-2xl bg-white border" data-id="${o.id}">
        <div class="flex items-center justify-between gap-4">
          <div class="text-lg font-semibold">#${o.id} ‚Äî ${o.name}</div>
          <div class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${o.status}</div>
        </div>
        <div class="text-sm text-gray-600 mt-1">
          ${created.toLocaleString()} ¬∑ –ò—Ç–æ–≥: <b>${o.total} —Ä—É–±.</b>${o._source==='local' ? ' ¬∑ <span class="text-red-500">–ª–æ–∫–∞–ª—å–Ω–æ</span>' : ''}
        </div>
        <div class="mt-2">üìç ${o.address}</div>
        <div class="mt-1">‚òéÔ∏è ${o.phone}</div>
        <div class="mt-2">üßæ ${itemLines || '‚Äî'}</div>
        <div class="mt-2">‚è∞ ${o.deliverByTime && o.deliverTime ? ('–∫ ' + o.deliverTime) : '–∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ'}</div>
        <div class="mt-4 flex flex-wrap gap-3 items-center">
          <div class="flex items-center gap-2">
            <label class="text-sm">–°—Ç–∞—Ç—É—Å:</label>
            <select class="border rounded-xl p-2" data-k="status">
              ${['–Ω–æ–≤—ã–π','–≥–æ—Ç–æ–≤–∏—Ç—Å—è','–≤ –ø—É—Ç–∏','–≥–æ—Ç–æ–≤','–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
            </select>
            <button type="button" class="px-3 py-2 rounded-xl border" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm">–û–∂–∏–¥–∞–Ω–∏–µ (–º–∏–Ω):</label>
            <input type="number" min="0" class="border rounded-xl p-2 w-24" data-k="eta" value="${o.etaMinutes??''}" />
            <button type="button" class="px-3 py-2 rounded-xl border" data-act="set-eta">OK</button>
          </div>
          <button type="button" class="ml-auto px-3 py-2 rounded-xl border bg-red-50 hover:bg-red-100" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `);

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
    card.addEventListener('click', async (e)=>{
      const act = e.target.dataset.act;
      if (!act) return;

      if (act === 'save'){
        const status = card.querySelector('[data-k="status"]').value;
        await ycCall("update", { id: o.id, patch: { status } });
        showToast(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`);
      }

      if (act === 'set-eta'){
        const etaMinutes = Number(card.querySelector('[data-k="eta"]').value || 0);
        await ycCall("update", { id: o.id, patch: { etaMinutes } });
        showToast(`ETA –∑–∞–∫–∞–∑–∞ #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`);
      }

      if (act === 'delete'){
        if (!card.dataset.confirm){
          card.dataset.confirm = '1';
          e.target.textContent = '–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?';
          setTimeout(()=>{
            if (card && card.dataset.confirm === '1'){
              delete card.dataset.confirm;
              e.target.textContent = '–£–¥–∞–ª–∏—Ç—å';
            }
          }, 3000);
          return;
        }
        await ycCall("delete", { id: o.id });
        card.remove();
        showToast(`–ó–∞–∫–∞–∑ #${o.id} —É–¥–∞–ª—ë–Ω`);
      }
    });

    return card;
  }

  async function load(){
    const res = await ycCall("list");
    list.innerHTML = '';

    const unique = new Map();
    if (!res.error && Array.isArray(res.orders)) {
      res.orders.forEach(o => unique.set(String(o.id), o));
    } else {
      const data = store.load();
      data.orders.forEach(o => unique.set(String(o.id), o));
    }

    if (unique.size === 0) {
      list.innerHTML = `<div class="p-5 rounded-2xl bg-white border text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>`;
      return;
    }

    const currentIds = new Set();
    [...unique.values()].forEach(o => {
      const idStr = String(o.id);
      currentIds.add(idStr);

      if (!seenIds.has(idStr)) {
        showToast("–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #" + o.id);
        if (soundEnabled){ playBeep(); setTimeout(()=>playBeep(), 250); }
      }

      list.appendChild(orderCard(o));
    });

    seenIds.clear();
    currentIds.forEach(id => seenIds.add(id));
  }

  load();
  setInterval(()=>{ if (location.hash === '#/dashboard') load(); }, 5000);

  return root;
}

/* ====== –†–û–£–¢–ï–† ====== */
function router(){
  const app = document.getElementById('app'); app.innerHTML='';
  if (location.hash==='#/dashboard') app.appendChild(DashboardView());
  else app.appendChild(OrderView());
}
window.addEventListener('hashchange', router);
router();

/* ====== –ü–ò–ù ====== */
const dashBtn = document.getElementById('openDashboard');
const pinModal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const pinOk = document.getElementById('pinOk');
const pinCancel = document.getElementById('pinCancel');
const pinError = document.getElementById('pinError');

function showPin(){ pinError.classList.add('hidden'); pinInput.value=''; pinModal.classList.remove('hidden'); pinModal.classList.add('flex'); setTimeout(()=>pinInput.focus(),0); }
function hidePin(){ pinModal.classList.add('hidden'); pinModal.classList.remove('flex'); }

function tryEnter(){
  if (pinInput.value === ALLOWED_PIN){
    hidePin();
    location.hash = '#/dashboard';
  } else {
    pinError.classList.remove('hidden');
    pinInput.focus();
  }
}

dashBtn.addEventListener('click', (e)=>{ e.preventDefault(); showPin(); });
pinOk.addEventListener('click', tryEnter);
pinCancel.addEventListener('click', hidePin);
pinInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') tryEnter(); if (e.key==='Escape') hidePin(); });
pinModal.addEventListener('click', (e)=>{ if (e.target===pinModal) hidePin(); });

/* ====== –û–ë–ù–û–í–ò–¢–¨ ====== */
document.getElementById('hardRefresh').addEventListener('click', ()=> location.reload());
</script>
</body>
</html>
