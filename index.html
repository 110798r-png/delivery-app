<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
  <title>–Ø–º–∞–ú–æ—Ç–æ ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; background:#f9fafb; }
    *, *::before, *::after { box-sizing:border-box; }
    img { max-width:100%; display:block; }
    .hidden{ display:none }
    .phone-shell{ width:min(100vw,540px); margin:0 auto; padding:0 .35rem; }

    .toast{ position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; padding:.75rem 1rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.2); opacity:.95; z-index:9999 }

    .glass-panel{ background:radial-gradient(circle at 10% 20%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.45) 45%, rgba(255,255,255,.25) 100%); backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.4); box-shadow:0 14px 40px rgba(15,23,42,.12) }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .sticky-top{ position:sticky; top:.5rem; z-index:30 }

    .menu-card{ display:flex; gap:.75rem; align-items:center; background:#fff; border:1px solid #edf2f7; border-radius:1.25rem; padding:1rem; min-height:6.4rem }
    .menu-card-img{ width:110px; height:70px; border-radius:.75rem; background:#eee; object-fit:cover }

    .confirm-bar{ position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:min(540px, 100%); background:#fff; border-top:1px solid #e5e7eb; padding:.6rem .9rem; z-index:50; box-shadow:0 -10px 25px rgba(15,23,42,.06) }

    #catPager{ display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; touch-action: pan-x pinch-zoom; }
    .cat-panel{ flex:0 0 100%; scroll-snap-align:start; scroll-snap-stop: always; padding:0; }
    .v-scroll{ overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action: pan-y; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:90 }
    .modal.open{ display:flex }

    .app-header{ position:sticky; top:0; z-index:100; }
    button[data-act], #profileBtn, #payOk, #payCancel, #backBtn { touch-action: manipulation; }
    .badge{ display:inline-flex; align-items:center; gap:.35rem; border-radius:.6rem; padding:.15rem .5rem; font-size:.75rem; background:#f1f5f9; color:#334155 }
    .badge.red{ background:#fee2e2; color:#991b1b }

    .card{ border-radius:1.25rem; background:#fff; border:1px solid #edf2f7; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .card-tall{ min-height: 140px; }
    .rowlink{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:16px 18px; font-weight:600 }

    /* –∑–æ–Ω–∞ 4-—Ç–∞–ø–æ–≤ (–Ω–µ–≤–∏–¥–∏–º–∞—è) */
    #tabloTapZone{ height:64px; display:flex; justify-content:flex-end; align-items:center; }
    #tabloTapHot{ width:120px; height:48px; border-radius:12px; }

    /* —á–∏–ø —Å—Ç–∞—Ç—É—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
    .chip{ display:inline-flex; align-items:center; padding:.15rem .55rem; border-radius:.7rem; font-size:.75rem; background:#eef2ff; color:#1f2937 }
  </style>
</head>
<body>
  <div class="w-full py-3">
    <header id="appHeader" class="phone-shell flex items-center justify-between mb-3 sm:mb-4 app-header">
      <div class="leading-tight">
        <div class="text-2xl font-extrabold tracking-tight">–Ø–º–∞–ú–æ—Ç–æ</div>
      </div>
      <a id="profileBtn" href="#/profile" class="px-3 py-2 rounded-xl border bg-white" aria-label="profile" role="button">üë§</a>
      <button id="backBtn" class="hidden px-3 py-2 rounded-xl border bg-white select-none" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
    </header>
    <main id="app" class="phone-shell"></main>
  </div>

  <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ + –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã -->
  <div id="payModal" class="modal">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm space-y-3 shadow-xl" role="dialog" aria-modal="true">
      <h3 class="text-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
      <div id="paySummary" class="text-sm bg-gray-50 border rounded-xl p-3 max-h-48 overflow-auto"></div>
      <div class="grid gap-1">
        <label class="text-sm text-gray-600" for="paySelect">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
        <select id="paySelect" class="border rounded-xl p-3 w-full">
          <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
          <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
          <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
        </select>
      </div>
      <div class="flex justify-end gap-2">
        <button id="payCancel" type="button" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
        <button id="payOk" type="button" class="px-3 py-2 rounded-xl bg-black text-white">–û–ö</button>
      </div>
    </div>
  </div>

  <!-- ¬´–ö–ª—é—á¬ª –ø–µ—Ä–µ–¥ —Ç–∞–±–ª–æ -->
  <div id="pinModal" class="modal">
    <div class="bg-white rounded-2xl p-5 w-full max-w-xs space-y-3 shadow-xl text-center">
      <h3 class="text-lg font-semibold">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á</h3>
      <input id="pinInput" class="border rounded-xl p-3 w-full text-center" placeholder="–≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á" inputmode="text">
      <div class="flex justify-end gap-2">
        <button id="pinCancel" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
        <button id="pinOk" class="px-3 py-2 rounded-xl bg-black text-white">–û–ö</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
/* –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç */
document.addEventListener('DOMContentLoaded', ()=>{ if (!location.hash || location.hash==='#' || location.hash==='#/') location.hash='#/order'; });

/* ===== –•—Ä–∞–Ω–∏–ª–∏—â–∞ ===== */
const PROFILE_LS_KEY     = 'client_profile_v1';
const CLIENT_HISTORY_KEY = 'orders_client_history_v1';
const UNAVAILABLE_LS_KEY = 'orders_unavailable_v1';
const DASHBOARD_LS_KEY   = 'dashboard_orders_v1';
const TABLO_PIN_OK       = 'TABLO_PIN_OK';
const DRAFT_CART_KEY     = 'draft_cart_v1';

const el = (html)=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; };
const showToast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1800); };
const TOST_SELECT = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä';
const money = (x)=> `${x} —Ä—É–±.`;
const setBodyScrollLock = (on)=> document.body.style.overflow = on ? 'hidden' : '';

function safeParse(k, f){ try{ const v=JSON.parse(localStorage.getItem(k)||'null'); if(v==null) return f; if(Array.isArray(f)) return Array.isArray(v)?v:[]; if(typeof f==='object') return v&&typeof v==='object'?v:{}; return v; }catch{ return f } }
function loadProfile(){ return safeParse(PROFILE_LS_KEY, {}); }
function saveProfile(p){ localStorage.setItem(PROFILE_LS_KEY, JSON.stringify(p||{})); }
function loadHistory(){ return safeParse(CLIENT_HISTORY_KEY, []); }
function saveHistory(list){ localStorage.setItem(CLIENT_HISTORY_KEY, JSON.stringify(Array.isArray(list)?list:[])); }
function loadUnavailable(){ return safeParse(UNAVAILABLE_LS_KEY, []); }
function saveUnavailable(items){ localStorage.setItem(UNAVAILABLE_LS_KEY, JSON.stringify(Array.isArray(items)?items:[])); }
function loadDash(){ return safeParse(DASHBOARD_LS_KEY, []); }
function saveDash(list){ localStorage.setItem(DASHBOARD_LS_KEY, JSON.stringify(Array.isArray(list)?list:[])); }

/* —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –º–µ–∂–¥—É —Ç–∞–±–ª–æ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π –∫–ª–∏–µ–Ω—Ç–∞ */
function syncOrderStatus(id, status){
  let hist = loadHistory();
  let changed = false;
  for (let i=0;i<hist.length;i++){
    if (String(hist[i].id) === String(id)){
      if (hist[i].status !== status){
        hist[i] = { ...hist[i], status };
        changed = true;
      }
      break;
    }
  }
  if (changed) saveHistory(hist);
}

const MENU_CATEGORIES = [
  { key:'burgers', title:'–ë—É—Ä–≥–µ—Ä—ã', items:[
    { name:'–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä', price:280, img:'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
    { name:'–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price:340, img:'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä',  price:200, img:'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price:250, img:'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
    { name:'–ß–∏–∑–±—É—Ä–≥–µ—Ä', price:220 }
  ]},
  { key:'twisters', title:'–¢–≤–∏—Å—Ç–µ—Ä—ã', items:[ { name:'–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price:200 }, { name:'–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å', price:250 } ]},
  { key:'drinks',  title:'–ù–∞–ø–∏—Ç–∫–∏', items:[ { name:'–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price:100 }, { name:'–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price:100 }, { name:'–°–ø—Ä–∞–π—Ç', price:100 }, { name:'–≠—Å–ø—Ä–µ—Å—Å–æ', price:120 } ]},
  { key:'sushi',   title:'–°—É—à–∏ / —Ä–æ–ª–ª—ã', items:[ { name:'–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price:350 }, { name:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price:390 }, { name:'–ê–ª—è—Å–∫–∞', price:350 } ]},
  { key:'semi',    title:'–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã', items:[ { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 6 —à—Ç.', price:160 }, { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 9 —à—Ç.', price:210 }, { name:'–°—Ç—Ä–∏–ø—Å—ã', price:190 } ]},
];

/* ===== –∞–Ω–∏–º–∞—Ü–∏—è/—Ç–∞–ø—ã (+/‚àí) ===== */
function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2 }
function animateScrollX(el, to, {duration=280, onEnd}={}){ const from=el.scrollLeft; const diff=to-from; if(!diff){ onEnd&&onEnd(); return; } const start=performance.now(); function step(ts){ const t=Math.min(1,(ts-start)/duration); el.scrollLeft=from+diff*easeInOutCubic(t); if(t<1) requestAnimationFrame(step); else onEnd&&onEnd(); } requestAnimationFrame(step); }
function bindTapIncDec(catPager, counts, recalcTotal){
  let downX=0, downY=0, pressedEl=null;
  catPager.addEventListener('pointerdown',(e)=>{ const btn=e.target.closest('button[data-act]'); if(!btn) return; pressedEl=btn; downX=e.clientX; downY=e.clientY; });
  catPager.addEventListener('pointerup',(e)=>{ if(!pressedEl) return; const dx=Math.abs(e.clientX-downX), dy=Math.abs(e.clientY-downY); const btn=pressedEl; if(dx<6&&dy<6){ const act=btn.dataset.act, name=btn.dataset.name; if(act==='inc') counts[name]=(counts[name]||0)+1; if(act==='dec') counts[name]=Math.max(0,(counts[name]||0)-1); catPager.querySelectorAll(`[data-q="${CSS.escape(name)}"]`).forEach(n=>n.textContent=counts[name]||0); recalcTotal(); catPager._ignoreNextClickTs=Date.now(); } pressedEl=null; });
  ['pointercancel','pointerleave'].forEach(evt=> catPager.addEventListener(evt, ()=>{ pressedEl=null; }));
}

/* ===== Order ===== */
function OrderView(){
  const root=el(`
    <div class="relative">
      <section class="sticky-top mb-2">
        <div class="glass-panel rounded-2xl px-3 py-3">
          <div id="categoryBar" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
        </div>
      </section>
      <section><div id="catPager" class="no-scrollbar"></div></section>
      <div id="confirmBar" class="confirm-bar">
        <div class="flex items-center justify-between gap-3">
          <div class="text-base"><span class="text-gray-600">–ò—Ç–æ–≥–æ:</span> <b id="totalVal">0 —Ä—É–±.</b></div>
          <button id="confirmBtn" class="px-4 py-3 rounded-xl bg-black text-white disabled:opacity-40 disabled:cursor-not-allowed" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </div>
  `);
  const categoryBar=root.querySelector('#categoryBar'); const catPager=root.querySelector('#catPager'); const confirmBar=root.querySelector('#confirmBar'); const totalEl=root.querySelector('#totalVal'); const confirmBtn=root.querySelector('#confirmBtn');
  setBodyScrollLock(true);

  const counts={}; const scrollMemory=new Map(); let activeIdx=0, isAnimating=false; let unavailableClient=new Set(loadUnavailable());
  const panelW = ()=> catPager.getBoundingClientRect().width || 1;

  MENU_CATEGORIES.forEach((cat,idx)=> categoryBar.appendChild(el(`<button type="button" class="px-3 py-1.5 rounded-full border text-sm whitespace-nowrap ${idx===0?'bg-black text-white border-black':'bg-white/50'}" data-idx="${idx}">${cat.title}</button>`)));
  function highlightChip(idx){ categoryBar.querySelectorAll('button').forEach((b,i)=>{ const on=i===idx; b.classList.toggle('bg-black',on); b.classList.toggle('text-white',on); b.classList.toggle('border-black',on); if(on) b.scrollIntoView({inline:'center', block:'nearest', behavior:'smooth'}); }); }
  function goToIndex(idx,{animate=true}={}){ idx=Math.max(0,Math.min(MENU_CATEGORIES.length-1,idx)); const target=Math.round(panelW()*idx); highlightChip(idx); if(!animate){ catPager.scrollLeft=target; activeIdx=idx; return } isAnimating=true; const prevSnap=catPager.style.scrollSnapType; catPager.style.scrollSnapType='none'; const old=catPager.children[activeIdx]?.querySelector('.v-scroll'); if(old){ scrollMemory.set(MENU_CATEGORIES[activeIdx].key, old.scrollTop); } animateScrollX(catPager, target, { duration:280, onEnd(){ const box=catPager.children[idx]?.querySelector('.v-scroll'); if(box){ box.scrollTop = scrollMemory.get(MENU_CATEGORIES[idx].key)||0; } activeIdx=idx; isAnimating=false; catPager.style.scrollSnapType=prevSnap||'x mandatory'; }}); }
  categoryBar.addEventListener('click', e=>{ const b=e.target.closest('button[data-idx]'); if(!b||isAnimating) return; goToIndex(+b.dataset.idx,{animate:true}) });

  function buildPanels(){
    catPager.innerHTML='';
    MENU_CATEGORIES.forEach((cat)=>{
      const panel=el(`<div class="cat-panel"></div>`), vbox=el(`<div class="v-scroll px-0.5"></div>`), list=el(`<div class="grid gap-3"></div>`);
      cat.items.forEach(it=>{
        const q=counts[it.name]||0; const disabled=unavailableClient.has(it.name);
        list.appendChild(el(`
          <div class="menu-card ${disabled?'opacity-50':''}">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm flex items-center gap-2">${it.name}${disabled?'<span class="badge red">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>':''}</div>
              <div class="text-xs text-gray-500 mt-1">${money(it.price)}</div>
              <div class="flex items-center gap-3 mt-3">
                <button type="button" class="w-8 h-8 rounded-xl border" data-name="${it.name}" data-act="dec" ${disabled?'disabled':''}>‚àí</button>
                <div class="w-6 text-center text-sm" data-q="${it.name}">${q}</div>
                <button type="button" class="w-8 h-8 rounded-xl bg-black text-white" data-name="${it.name}" data-act="inc" ${disabled?'disabled':''}>+</button>
              </div>
            </div>
            <img src="${it.img||'https://placehold.co/110x70?text=food'}" class="menu-card-img" alt="">
          </div>`));
      });
      list.appendChild(el(`<div class="h-24"></div>`));
      vbox.appendChild(list); panel.appendChild(vbox); catPager.appendChild(panel);

      // —Å–≤–∞–π–ø –ø–∞–Ω–µ–ª–∏
      let down=false, used=false, sx=0, sy=0, locked=null; const PIX_LOCK=10, THRESH=()=>Math.max(40, panelW()*0.25);
      vbox.addEventListener('pointerdown',e=>{ if(isAnimating) return; down=true; used=false; sx=e.clientX; sy=e.clientY; locked=null; vbox.setPointerCapture?.(e.pointerId); });
      vbox.addEventListener('pointermove',e=>{ if(!down||used||isAnimating) return; const dx=e.clientX-sx, dy=e.clientY-sy; if(locked===null){ if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>PIX_LOCK) locked='x'; else if(Math.abs(dy)>Math.abs(dx)&&Math.abs(dy)>PIX_LOCK) locked='y'; } if(locked==='x'){ e.preventDefault(); if(Math.abs(dx)>=THRESH()){ used=true; const next=dx<0?activeIdx+1:activeIdx-1; goToIndex(next,{animate:true}); } } }, {passive:false});
      ['pointerup','pointercancel','pointerleave'].forEach(evt=> vbox.addEventListener(evt,()=>{ down=false; used=false; locked=null; }));
    });

    // –ø—Ä–∏–º–µ–Ω—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫ ¬´–ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑¬ª
    const draft = safeParse(DRAFT_CART_KEY, null);
    if (draft && typeof draft==='object'){
      Object.entries(draft).forEach(([name,q])=>{
        const n = catPager.querySelector(`[data-q="${CSS.escape(name)}"]`);
        if (n){ n.textContent = Number(q)||0; }
      });
      sessionStorage.removeItem(DRAFT_CART_KEY);
    }

    if(!catPager._pmBound){
      catPager.addEventListener('click', e=>{ if (catPager._ignoreNextClickTs && Date.now()-catPager._ignoreNextClickTs < 200){ e.preventDefault(); e.stopPropagation(); return; } const act=e.target?.dataset?.act; if(!act) return; const name=e.target.dataset.name; if(act==='inc') counts[name]=(counts[name]||0)+1; else counts[name]=Math.max(0,(counts[name]||0)-1); catPager.querySelectorAll(`[data-q="${CSS.escape(name)}"]`).forEach(n=> n.textContent=counts[name]||0); recalcTotal(); });
      catPager.addEventListener('keydown', (e)=>{ const btn=e.target.closest('button[data-act]'); if(!btn) return; if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); }});
      catPager._pmBound=true;
    }

    applyHeights(); setTimeout(applyHeights,60);
    recalcTotal(); // –Ω–∞ —Å–ª—É—á–∞–π —á–µ—Ä–Ω–æ–≤–∏–∫–∞
  }

  function applyHeights(){ const headerH=document.getElementById('appHeader').getBoundingClientRect().height; const chipsH=root.querySelector('.sticky-top').getBoundingClientRect().height; const confirmH=confirmBar.getBoundingClientRect().height; const availH=Math.max(240, window.innerHeight - headerH - chipsH - confirmH - 8); const first=catPager.querySelector('.menu-card'); const cardH=first?Math.ceil(first.getBoundingClientRect().height):104; const h=Math.min(availH, cardH*4 + 12*3 + 4); root.querySelectorAll('.v-scroll').forEach(el=> el.style.height=h+'px'); goToIndex(activeIdx,{animate:false}); }
  window.addEventListener('resize', applyHeights);

  catPager.addEventListener('scroll', ()=>{ if (isAnimating) return; if (catPager._scrollTimer) clearTimeout(catPager._scrollTimer); catPager._scrollTimer = setTimeout(()=>{ const idx = Math.round(catPager.scrollLeft / (catPager.getBoundingClientRect().width||1)); if(idx!==activeIdx){ highlightChip(idx); activeIdx=idx; } }, 80); });

  function recalcTotal(){
    let sum=0;
    catPager.querySelectorAll('[data-q]').forEach(n=>{
      const name=n.getAttribute('data-q'); const q=Number(n.textContent||'0')||0;
      if(q>0){
        for(const cat of MENU_CATEGORIES){ const it = cat.items.find(x=>x.name===name); if(it){ sum += q*it.price; break; } }
      }
    });
    totalEl.textContent=money(sum);
    confirmBtn.disabled = sum<=0;
    return sum;
  }

  // —Å—Ç—Ä–æ–≥–∞—è –∑–∞—â–∏—Ç–∞: –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
  confirmBtn.addEventListener('click', ()=>{
    const items=[]; MENU_CATEGORIES.forEach(cat=>cat.items.forEach(it=>{
      const q = Number(root.querySelector(`[data-q="${CSS.escape(it.name)}"]`)?.textContent||'0')||0;
      if(q>0) items.push({name:it.name, qty:q, price:it.price});
    }));
    if(!items.length){ showToast(TOST_SELECT); return; }

    if (confirmBtn._busy) return; confirmBtn._busy=true; confirmBtn.disabled=true;

    const sumBox = document.getElementById('paySummary');
    let total=0; sumBox.innerHTML = items.map(i=>{ total += i.qty*i.price; return `<div class="flex items-center justify-between"><div class="truncate">${i.name} √ó${i.qty}</div><div class="ml-2 whitespace-nowrap">${money(i.qty*i.price)}</div></div>`; }).join('');
    sumBox.insertAdjacentHTML('beforeend', `<div class="mt-2 pt-2 border-t flex items-center justify-between font-semibold"><div>–ò—Ç–æ–≥–æ</div><div>${money(total)}</div></div>`);
    const prof=loadProfile(); const sel=document.getElementById('paySelect'); sel.value = prof.paymentMethod||'cash';
    document.getElementById('payModal').classList.add('open');
  });

  buildPanels();
  highlightChip(0); requestAnimationFrame(()=> goToIndex(0,{animate:false}));

  // –æ—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
  root.resetCartDom = function(){
    catPager.querySelectorAll('[data-q]').forEach(n=> n.textContent='0');
    totalEl.textContent = money(0);
    confirmBtn.disabled = true;
  };
  root.cleanup = ()=> setBodyScrollLock(false);
  return root;
}

/* ===== –ü—Ä–æ—Ñ–∏–ª—å ===== */
function ProfileHubView(){
  const p=Object.assign({ name:'', phone:'', address:'', paymentMethod:'cash' }, loadProfile());
  const list = loadHistory();
  const activeOrder = (Array.isArray(list)?list:[]).find(o => (o.status||'–Ω–æ–≤—ã–π')!=='–∑–∞–≤–µ—Ä—à—ë–Ω' && (o.status||'–Ω–æ–≤—ã–π')!=='–æ—Ç–º–µ–Ω—ë–Ω');
  const last2 = (Array.isArray(list)?list:[]).slice(0,2);

  const rightCardContent = activeOrder
    ? `
      <div class="text-sm font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑</div>
      <div class="border rounded-lg p-2 text-[12px] leading-tight">
        <div>#${activeOrder.id} ¬∑ <span class="chip">${activeOrder.status||'–Ω–æ–≤—ã–π'}</span></div>
        <div>${money(activeOrder.total||0)}</div>
        <div>${new Date(activeOrder.createdAt).toLocaleDateString()}</div>
      </div>`
    : `
      <div class="text-sm font-semibold mb-2">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
      <div class="grid grid-cols-1 gap-2">
        ${
          last2.length
            ? last2.map(o=>`
              <div class="border rounded-lg p-2 text-[12px] leading-tight">
                <div>#${o.id} ¬∑ <span class="chip">${o.status||'‚Äî'}</span></div>
                <div>${money(o.total||0)}</div>
                <div>${new Date(o.createdAt).toLocaleDateString()}</div>
              </div>`).join('')
            : `<div class="text-xs text-gray-500">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`
        }
      </div>`;

  const rightCardBtnId = activeOrder ? 'activeBtn' : 'historyBtn';

  const root=el(`
    <div class="grid gap-4 pb-24">

      <section class="grid grid-cols-2 gap-3">
        <button class="card card-tall p-4 text-left" id="profileEditBtn">
          <div class="flex gap-3">
            <div class="w-14 h-14 rounded-lg bg-gray-300 grid place-items-center text-2xl font-bold text-white">–Ø</div>
            <div class="min-w-0">
              <div class="text-base font-semibold truncate">${p.name || '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å'}</div>
              <div class="text-xs text-gray-600 mt-1 truncate">${p.address || '–ê–¥—Ä–µ—Å: –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
              <div class="text-[11px] text-gray-500 mt-1 truncate">${p.phone ? '–¢–µ–ª.: '+p.phone : '–¢–µ–ª–µ—Ñ–æ–Ω: –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
            </div>
          </div>
        </button>

        <button class="card card-tall p-4 text-left" id="${rightCardBtnId}">
          ${rightCardContent}
        </button>
      </section>

      <section class="card p-5">
        <div class="text-2xl font-extrabold tracking-tight">–ó–î–ï–°–¨ –ë–£–î–ï–¢ –ë–õ–û–ö –ü–û–î –†–ï–ö–õ–ê–ú–£</div>
      </section>

      <section class="grid gap-2">
        <button class="rowlink text-left" id="reviewsBtn">–û—Ç–∑—ã–≤—ã</button>
        <button class="rowlink text-left" id="supportBtn">–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</button>
        <button class="rowlink text-left" id="feedbackBtn">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</button>
      </section>

      <section class="card p-4 text-sm leading-relaxed">
        <div class="text-base font-semibold mb-2">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div class="text-xs text-gray-600">
          –ê–¥—Ä–µ—Å: —Å. –ö–æ—Å—è–∫–∏–Ω–æ, —É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞, 26<br>
          –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 08:00‚Äì23:00
        </div>
      </section>

      <section id="tabloTapZone">
        <div id="tabloTapHot" aria-label="tablo-tap-hot"></div>
      </section>

    </div>
  `);

  root.querySelector('#profileEditBtn').onclick = ()=> location.hash = '#/profile-edit';
  (activeOrder ? root.querySelector('#activeBtn') : root.querySelector('#historyBtn')).onclick = ()=> location.hash = '#/history';
  root.querySelector('#supportBtn').onclick     = ()=> alert('–ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —á–∞—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏.');
  root.querySelector('#reviewsBtn').onclick     = ()=> alert('–ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —ç–∫—Ä–∞–Ω –æ—Ç–∑—ã–≤–æ–≤.');
  root.querySelector('#feedbackBtn').onclick    = ()=> location.hash = '#/contact';
  return root;
}

/* ===== –≠–∫—Ä–∞–Ω ¬´–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å¬ª ===== */
function ContactView(){
  const p=Object.assign({ phone:'', }, loadProfile());
  const root=el(`
    <div class="grid gap-4 pb-24">
      <div class="flex items-center gap-3">
        <button id="backOnly" class="px-3 py-2 rounded-xl border bg-white" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
        <div class="text-lg font-semibold">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
      </div>
      <section class="card p-4 text-sm grid gap-2">
        <div>–ü–æ—á—Ç–∞: <a class="underline" href="mailto:sabirbis@bk.ru">sabirbis@bk.ru</a></div>
        <div>–¢–µ–ª.: <a class="underline" href="tel:+79899932108">+7 989 993-21-08</a></div>
        ${ p.phone ? `<div class="text-xs text-gray-500">–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ: ${p.phone}</div>` : '' }
      </section>
    </div>
  `);
  root.querySelector('#backOnly').onclick = ()=> history.length ? history.back() : (location.hash='#/profile');
  return root;
}

/* ===== –ò—Å—Ç–æ—Ä–∏—è / –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ (–∫—Ä—É–ø–Ω—ã–µ –∫–∞—Ä—Ç—ã –∫–∞–∫ –≤ –º–∞–∫–µ—Ç–µ) ===== */
function HistoryView(){
  const root=el(`
    <div class="grid gap-4 pb-24">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
        <button id="back" class="px-3 py-2 rounded-xl border">–ù–∞–∑–∞–¥</button>
      </div>
      <div id="historyList" class="grid gap-4"></div>
    </div>
  `);
  const box=root.querySelector('#historyList');

  function cardFor(o, idx){
    const d = o.createdAt? new Date(o.createdAt): new Date();
    const items = (o.items||[]).map(i=>`
      <div class="flex items-center justify-between text-sm">
        <div class="truncate mr-3">${i.name}</div>
        <div class="whitespace-nowrap">${i.qty} √ó ${money(i.price||0)}</div>
      </div>`).join('');
    const elCard = el(`
      <section class="bg-white border rounded-2xl p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500">${d.toLocaleDateString()}, ${d.toLocaleTimeString().slice(0,5)}</div>
          <div class="chip">${o.status||'–Ω–æ–≤—ã–π'}</div>
        </div>
        <div class="text-3xl font-extrabold tracking-tight mt-1">‚Ññ ${o.id||'‚Äî'}</div>
        <div class="mt-3 grid gap-2">${items||'<div class="text-sm text-gray-400">‚Äî</div>'}</div>
        <div class="mt-3 pt-3 border-t flex items-center justify-between font-semibold">
          <div>–ò—Ç–æ–≥–æ</div><div>${money(o.total||0)}</div>
        </div>
        <button class="mt-3 w-full rounded-xl bg-red-600 text-white py-3 font-semibold" data-repeat>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </section>
    `);
    elCard.querySelector('[data-repeat]').onclick = ()=>{
      const draft = {};
      (o.items||[]).forEach(i=>{ draft[i.name] = (draft[i.name]||0) + (i.qty||0); });
      sessionStorage.setItem(DRAFT_CART_KEY, JSON.stringify(draft));
      location.hash = '#/order';
      showToast('–ü–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É');
    };
    return elCard;
  }

  function render(){
    const list=loadHistory();
    box.innerHTML='';
    if(!Array.isArray(list)||!list.length){
      box.innerHTML='<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
      return;
    }
    list.forEach((o, idx)=> box.appendChild(cardFor(o, idx)) );
  }

  root.querySelector('#back').onclick=()=> history.length ? history.back() : (location.hash='#/profile');
  render(); return root;
}

/* ===== –¢–∞–±–ª–æ ===== */
function DashboardView(){
  const root=el(`
    <div class="grid gap-4 max-w-6xl pb-24">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h2>
      </div>
      <div class="p-4 rounded-2xl bg-white border">
        <h3 class="font-semibold mb-3">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <p class="text-sm text-gray-500 mb-3">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–∫–æ–π, —á–µ–≥–æ –ù–ï–¢ ‚Äî –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Ç–æ–≤–∞—Ä —Å—Ç–∞–Ω–µ—Ç —Å–µ—Ä—ã–º –∏ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å.</p>
        <div id="stockList" class="grid gap-2 md:grid-cols-3"></div>
        <div class="mt-3"><button id="saveStock" class="px-3 py-2 rounded-xl border bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </div>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="list"></div>
      <div><button class="px-3 py-2 rounded-xl border" onclick="location.hash='#/profile'">–ù–∞–∑–∞–¥</button></div>
    </div>
  `);
  const list=root.querySelector('#list'); const stockList=root.querySelector('#stockList'); let unavailable=new Set(loadUnavailable()); let dashOrders=loadDash();

  function renderStock(){ stockList.innerHTML=''; MENU_CATEGORIES.forEach(cat=>cat.items.forEach(item=>{ const row=el(`<label class="flex items-center gap-2 text-sm"><input type="checkbox" value="${item.name}" ${unavailable.has(item.name)?'checked':''} /><span>${item.name}</span></label>`); stockList.appendChild(row); })) }
  renderStock();
  root.querySelector('#saveStock').onclick=()=>{ const checked=[...stockList.querySelectorAll('input[type=checkbox]:checked')].map(i=>i.value); saveUnavailable(checked); unavailable=new Set(checked); showToast('–ù–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

  function orderCard(o){
    const clientTotal=(o.items||[]).reduce((s,i)=> s + (i.price||0)*(i.qty||0),0);
    const total=Math.max(typeof o.total==='number'?o.total:0, clientTotal);
    const created=o.createdAt? new Date(o.createdAt): new Date();
    const itemLines=(o.items||[]).map(i=>`${i.name} √ó${i.qty}`).join(', ');
    const card=el(`<div class="p-5 rounded-2xl bg-white border flex flex-col gap-2" data-id="${o.id}">
      <div class="flex items-center justify-between gap-4">
        <div class="text-lg font-semibold">#${o.id} ‚Äî ${o.name||''}</div>
        <div class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${o.status||'–Ω–æ–≤—ã–π'}</div>
      </div>
      <div class="text-sm text-gray-600">${created.toLocaleString()} ¬∑ –ò—Ç–æ–≥: <b>${total} —Ä—É–±.</b></div>
      <div>üßæ ${itemLines||'‚Äî'}</div>
      <div class="mt-3 flex flex-wrap gap-2 items-center">
        <label class="text-sm">–°—Ç–∞—Ç—É—Å:</label>
        <select class="border rounded-xl p-2" data-k="status">
          ${['–Ω–æ–≤—ã–π','–≥–æ—Ç–æ–≤–∏—Ç—Å—è','–≤ –ø—É—Ç–∏','–≥–æ—Ç–æ–≤','–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].map(s=>`<option ${s===(o.status||'–Ω–æ–≤—ã–π')?'selected':''}>${s}</option>`).join('')}
        </select>
        <button type="button" class="px-3 py-2 rounded-xl border" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div class="mt-2 text-right">
        <button type="button" class="px-3 py-2 rounded-xl border bg-red-50 hover:bg-red-100" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>`);
    card.addEventListener('click',(e)=>{
      const act=e.target.dataset.act; if(!act) return;
      if(act==='save'){
        const status=card.querySelector('[data-k="status"]').value;
        const i=dashOrders.findIndex(x=>String(x.id)===String(o.id));
        if(i>=0){ dashOrders[i]={...dashOrders[i], status}; saveDash(dashOrders); syncOrderStatus(o.id, status); showToast(`–°—Ç–∞—Ç—É—Å #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`); }
      }
      if(act==='delete'){
        if(!card.dataset.confirm){ card.dataset.confirm='1'; e.target.textContent='–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?'; setTimeout(()=>{ if(card&&card.dataset.confirm==='1'){ delete card.dataset.confirm; e.target.textContent='–£–¥–∞–ª–∏—Ç—å' }},3000); return }
        dashOrders=dashOrders.filter(x=>String(x.id)!==String(o.id)); saveDash(dashOrders); card.remove(); showToast(`–ó–∞–∫–∞–∑ #${o.id} —É–¥–∞–ª—ë–Ω —Å —Ç–∞–±–ª–æ`);
      }
    });
    return card;
  }
  function load(){ const unique=new Map(); dashOrders.forEach(o=>unique.set(String(o.id),o)); list.innerHTML=''; if(unique.size===0){ list.innerHTML=`<div class="p-5 rounded-2xl bg-white border text-gray-500 col-span-full">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>`; return } [...unique.values()].forEach(o=> list.appendChild(orderCard(o)) ); }
  load(); return root;
}

/* ===== 4-—Ç–∞–ø –∑–æ–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–æ—Ñ–∏–ª—è ===== */
function bindTabloTapZone(){
  const hot = document.getElementById('tabloTapHot');
  if (!hot || hot._bound) return;
  hot._bound = true;

  let taps = 0, first = 0, timer = null;
  const windowMs = 1200;
  function reset(){ taps = 0; first = 0; if (timer){ clearTimeout(timer); timer = null; } }
  function handle
