<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–Ø–º–∞Moto ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="icon" href="data:,">
  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; background:#f9fafb; }
    *, *::before, *::after { box-sizing:border-box; }
    img { max-width:100%; display:block; }
    .hidden{ display:none }
    .phone-shell{ width:min(100vw,540px); margin:0 auto; padding:0 .35rem; }

    .toast{ position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; padding:.75rem 1rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.2); opacity:.95; z-index:9999 }

    .glass-panel{ background:radial-gradient(circle at 10% 20%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.45) 45%, rgba(255,255,255,.25) 100%); backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.4); box-shadow:0 14px 40px rgba(15,23,42,.12) }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .sticky-top{ position:sticky; top:.5rem; z-index:30 }

    .menu-card{ display:flex; gap:.75rem; align-items:center; background:#fff; border:1px solid #edf2f7; border-radius:var(--card-radius, 1.25rem); padding:1rem; min-height:var(--card-min-h, 6.4rem) }
    .menu-card-img{ width:var(--img-w,110px); height:var(--img-h,70px); border-radius:var(--img-radius,.75rem); background:#eee; object-fit:cover }

    .confirm-bar{ position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:min(540px, 100%); background:#fff; border-top:1px solid #e5e7eb; padding:.6rem .9rem; z-index:50; box-shadow:0 -10px 25px rgba(15,23,42,.06) }

    #catPager{ display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; touch-action: pan-x pinch-zoom; }
    .cat-panel{ flex:0 0 100%; scroll-snap-align:start; scroll-snap-stop: always; padding:0; }
    .v-scroll{ overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action: pan-y; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:90 }
    .modal.open{ display:flex }

    .app-header{ position:sticky; top:0; z-index:100; }

    button[data-act], #profileBtn, #payOk, #payCancel, #backBtn { touch-action: manipulation; }
    .badge{ display:inline-flex; align-items:center; gap:.35rem; border-radius:.6rem; padding:.15rem .5rem; font-size:.75rem; background:#f1f5f9; color:#334155 }
    .badge.red{ background:#fee2e2; color:#991b1b }

    .card{ border-radius:1.25rem; background:#fff; border:1px solid #edf2f7; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .card-tall{ min-height: 164px; }
    .rowlink{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:16px 18px; font-weight:600 }

    #tabloTapZone{ height:64px; display:flex; justify-content:flex-end; align-items:center; }
    #tabloTapHot{ width:140px; height:52px; border-radius:12px; }

    .chip{ display:inline-block; padding:.2rem .6rem; border-radius:999px; font-size:.75rem; }

    /* --- –ö—Ä–∞—Å–Ω–∞—è —à–∞–ø–∫–∞ --- */
    .brand-strip{ background:#e50000; color:#fff; }
    .brand-title{ font-weight:900; font-size:24px; line-height:1; letter-spacing:.2px; }
    .brand-sub{ font-size:11px; line-height:1; opacity:.9; margin-top:2px; letter-spacing:.3px }
    .brand-wrap{ display:flex; align-items:center; gap:10px; }
    .sushi-icon{ width:36px; height:36px; border-radius:999px; display:grid; place-items:center; background:#000; }
    .sushi-icon svg{ width:24px; height:24px; }
    .header-row{ padding:10px 12px; }
    .header-ghost{ height:8px; }
  </style>
</head>
<body>
  <div class="w-full">
    <!-- –ö—Ä–∞—Å–Ω–∞—è —à–∞–ø–∫–∞ -->
    <div class="brand-strip">
      <div class="phone-shell header-row flex items-center justify-between">
        <div class="brand-wrap">
          <div class="sushi-icon" aria-hidden="true">
            <!-- simple ‚Äú—Å—É—à–∏‚Äù icon -->
            <svg viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" fill="#fff"/>
              <circle cx="12" cy="12" r="7" fill="#e50000"/>
              <circle cx="12" cy="12" r="4" fill="#000"/>
            </svg>
          </div>
          <div class="leading-tight">
            <div class="brand-title" id="brandTitle">–Ø–º–∞Moto</div>
            <div class="brand-sub">—Å—É—à–∏ ‚Ä¢ —Ä–æ–ª–ª—ã ‚Ä¢ —Ñ–∞—Å—Ç—Ñ—É–¥</div>
          </div>
        </div>
        <a id="profileBtn" href="#/profile" class="px-3 py-2 rounded-xl border bg-white text-black" aria-label="–ü—Ä–æ—Ñ–∏–ª—å" role="button" title="–ü—Ä–æ—Ñ–∏–ª—å">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor"/></svg>
        </a>
        <button id="backBtn" class="hidden px-3 py-2 rounded-xl border bg-white select-none" aria-label="–ù–∞–∑–∞–¥" title="–ù–∞–∑–∞–¥">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
    <div class="header-ghost"></div>

    <main id="app" class="phone-shell"></main>
  </div>

  <!-- –û–ø–ª–∞—Ç–∞ -->
  <div id="payModal" class="modal">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm space-y-3 shadow-xl" role="dialog" aria-modal="true">
      <h3 class="text-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
      <div id="paySummary" class="text-sm bg-gray-50 border rounded-xl p-3 max-h-48 overflow-auto"></div>
      <div class="grid gap-1">
        <label class="text-sm text-gray-600" for="paySelect">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
        <select id="paySelect" class="border rounded-xl p-3 w-full">
          <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
          <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
          <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
        </select>
      </div>
      <div class="flex justify-end gap-2">
        <button id="payCancel" type="button" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
        <button id="payOk" type="button" class="px-3 py-2 rounded-xl bg-black text-white">–û–ö</button>
      </div>
    </div>
  </div>

  <!-- –ö–ª—é—á –¥–ª—è —Ç–∞–±–ª–æ -->
  <div id="pinModal" class="modal">
    <div class="bg-white rounded-2xl p-5 w-full max-w-xs space-y-3 shadow-xl text-center">
      <h3 class="text-lg font-semibold">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á</h3>
      <input id="pinInput" class="border rounded-2xl p-3 w-full text-center" placeholder="–≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á" inputmode="text">
      <div class="flex justify-end gap-2">
        <button id="pinCancel" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
        <button id="pinOk" class="px-3 py-2 rounded-xl bg-black text-white">–û–ö</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <audio id="orderDing" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@main/ding.mp3" type="audio/mpeg">
  </audio>

<script>
/* ====== –ö–û–ù–°–¢–ê–ù–¢–´ ====== */
const API_URL = 'https://d5d1ec44lv5uk5k7k9to.bixf7e87.apigw.yandexcloud.net';
const CONFIG_REMOTE_URL = ''; // <- –µ—Å–ª–∏ –ø–æ–ª–æ–∂–∏—à—å JSON –º–µ–Ω—é –≤ Object Storage (public), —É–∫–∞–∂–∏ —Å—é–¥–∞ URL

/* ===== RPC ===== */
async function rpc(payload){
  if(!API_URL) throw new Error('API_URL empty');
  const res = await fetch(`${API_URL}/rpc`, {
    method: 'POST',
    headers: { 'content-type':'application/json' },
    body: JSON.stringify(payload||{})
  });
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error(`RPC ${res.status}: ${t}`);
  }
  return res.json();
}

/* ===== –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ===== */
document.addEventListener('DOMContentLoaded', function(){
  if (!location.hash || location.hash==='#' || location.hash==='#/') location.hash='#/order';
});

/* ===== –∫–ª—é—á–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â ===== */
const PROFILE_LS_KEY     = 'client_profile_v1';
const CLIENT_HISTORY_KEY = 'orders_client_history_v1';
const UNAVAILABLE_LS_KEY = 'orders_unavailable_v1';
const DASHBOARD_LS_KEY   = 'dashboard_orders_v1';
const CONFIG_LS_KEY      = 'app_config_v1';
const TABLO_PIN_OK       = 'TABLO_PIN_OK';
const WANT_DASH          = 'WANT_DASH';
const SOUND_ON_KEY       = 'sound_on_v1';

/* ===== —É—Ç–∏–ª–∏—Ç—ã ===== */
const el = (html)=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; };
const showToast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1800); };
const money = (x)=> `${x} —Ä—É–±.`;
const setBodyScrollLock = (on)=> document.body.style.overflow = on ? 'hidden' : '';
function safeParse(k, f){ try{ const v=JSON.parse(localStorage.getItem(k)||'null'); if(v==null) return f; if(Array.isArray(f)) return Array.isArray(v)?v:[]; if(typeof f==='object') return v&&typeof v==='object'?v:{}; return v; }catch{ return f } }
function loadProfile(){ return safeParse(PROFILE_LS_KEY, {}); }
function saveProfile(p){ localStorage.setItem(PROFILE_LS_KEY, JSON.stringify(p||{})); }
function loadHistory(){ return safeParse(CLIENT_HISTORY_KEY, []); }
function saveHistory(list){ localStorage.setItem(CLIENT_HISTORY_KEY, JSON.stringify(Array.isArray(list)?list:[])); }
function loadUnavailable(){ return safeParse(UNAVAILABLE_LS_KEY, []); }
function saveUnavailable(items){ localStorage.setItem(UNAVAILABLE_LS_KEY, JSON.stringify(Array.isArray(items)?items:[])); }
function loadDash(){ return safeParse(DASHBOARD_LS_KEY, []); }
function saveDash(list){ localStorage.setItem(DASHBOARD_LS_KEY, JSON.stringify(Array.isArray(list)?list:[])); }

/* ===== –∫–æ–Ω—Ñ–∏–≥ (–º–µ–Ω—é) ===== */
const DEFAULT_CONFIG = {
  brandTitle: '–Ø–º–∞Moto',
  theme: { cardRadius:20, imgRadius:12, imgW:110, imgH:70, cardMinH:104, showPrice:true },
  menu: [
    { key:'burgers', title:'–ë—É—Ä–≥–µ—Ä—ã', items:[
      { name:'–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä', price:280, img:'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
      { name:'–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price:440, img:'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
      { name:'–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä',  price:200, img:'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
      { name:'–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price:250, img:'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
      { name:'–ß–∏–∑–±—É—Ä–≥–µ—Ä', price:220 }
    ]},
    { key:'twisters', title:'–¢–≤–∏—Å—Ç–µ—Ä—ã', items:[
      { name:'–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price:200 },
      { name:'–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π —Å –∫–∞—Ä—Ç–æ—à–∫–æ–π', price:220 },
      { name:'–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å', price:250 },
      { name:'–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å —Å –∫–∞—Ä—Ç–æ—à–∫–æ–π', price:280 }
    ]},
    { key:'drinks',  title:'–ù–∞–ø–∏—Ç–∫–∏', items:[
      { name:'–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price:100 }, { name:'–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price:100 }, { name:'–î–æ–±—Ä—ã–π –ª–∞–π–º', price:100 },
      { name:'—Ñ–¥—ç—Ç-—É–∞–π—Ç', price:100 }, { name:'–†–∞—Ñ –±–∞–Ω–∞–Ω', price:100 }, { name:'–≠—Å–ø—Ä–µ—Å—Å–æ', price:100 }
    ]},
    { key:'sushi',   title:'–°—É—à–∏ / —Ä–æ–ª–ª—ã', items:[ { name:'–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price:350 }, { name:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price:390 }, { name:'–ê–ª—è—Å–∫–∞', price:350 } ]},
    { key:'semi',    title:'–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã', items:[ { name:'–ö—É—Ä–∑–µ —Å –º—è—Å–æ–º', price:160 }, { name:'–ö—É—Ä–∑–µ —Å —Ç–≤–æ—Ä–æ–≥–æ–º ', price:210 }, { name:'—Ö–∏–Ω–∫–∞–ª —Å–ª–æ–µ–Ω–Ω—ã–π', price:190 }, { name:'–•–∏–Ω–∫–∞–ª —Ç–æ–Ω–∫–∏–π', price:190 }, { name:'–•–∏–Ω–∫–∞–ª —Ç–æ–ª—Å—Ç—ã–π', price:190 } ]}
  ]
};
function loadConfig(){ return safeParse(CONFIG_LS_KEY, DEFAULT_CONFIG); }
function saveConfig(cfg){ localStorage.setItem(CONFIG_LS_KEY, JSON.stringify(cfg||DEFAULT_CONFIG)); }
function applyTheme(theme){
  const r = document.documentElement;
  r.style.setProperty('--card-radius',  (theme.cardRadius||20)+'px');
  r.style.setProperty('--img-radius',   (theme.imgRadius||12)+'px');
  r.style.setProperty('--img-w',        (theme.imgW||110)+'px');
  r.style.setProperty('--img-h',        (theme.imgH||70)+'px');
  r.style.setProperty('--card-min-h',   (theme.cardMinH||104)+'px');
  document.getElementById('brandTitle').textContent = (loadConfig().brandTitle || '–Ø–º–∞Moto');
}
let MENU_CATEGORIES = loadConfig().menu.slice();
applyTheme(loadConfig().theme);

/* –û–±–ª–∞—á–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é) */
async function fetchRemoteConfig(){
  if(!CONFIG_REMOTE_URL) return null;
  try{
    const res = await fetch(CONFIG_REMOTE_URL, { cache:'no-cache' });
    if(!res.ok) return null;
    const json = await res.json();
    if(json && json.menu){
      saveConfig(json);
      applyTheme(json.theme||{});
      MENU_CATEGORIES = json.menu.slice();
    }
    return json;
  }catch{ return null }
}
async function publishRemoteConfig(cfg){
  // –°–¥–µ–ª–∞–π –Ω–∞ –±—ç–∫–µ RPC op:'config_set' –∏–ª–∏ –¥–∞–π pre-signed PUT. –•—É–∫ –æ—Å—Ç–∞–≤–ª—è—é:
  try{ await rpc({ op:'config_set', config: cfg }); showToast('–ú–µ–Ω—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ'); }catch{ showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ'); }
}

/* ===== –∞–Ω–∏–º–∞—Ü–∏–∏ ===== */
function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2 }
function animateScrollX(el, to, {duration=280, onEnd}={}){ const from=el.scrollLeft; const diff=to-from; if(!diff){ onEnd&&onEnd(); return; } const start=performance.now(); function step(ts){ const t=Math.min(1,(ts-start)/duration); el.scrollLeft=from+diff*easeInOutCubic(t); if(t<1) requestAnimationFrame(step); else onEnd&&onEnd(); } requestAnimationFrame(step); }

/* ===== —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ + —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –±–µ–π–¥–∂–∞ ===== */
function syncOrderStatus(id, status){
  let hist = loadHistory(); let changed = false;
  for (let i=0;i<hist.length;i++){
    if (String(hist[i].id) === String(id)){
      if (hist[i].status !== status){ hist[i] = { ...hist[i], status }; changed = true; }
      break;
    }
  }
  if (changed){ saveHistory(hist); window.dispatchEvent(new CustomEvent('orders:history-updated')); }
}

/* ===== Order ===== */
function OrderView(){
  const cfg = loadConfig(); applyTheme(cfg.theme); MENU_CATEGORIES = cfg.menu.slice();

  const root=el(`
    <div class="relative">
      <section class="sticky-top mb-2">
        <div class="glass-panel rounded-2xl px-3 py-3">
          <div id="categoryBar" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
        </div>
      </section>
      <section><div id="catPager" class="no-scrollbar"></div></section>
      <div id="confirmBar" class="confirm-bar">
        <div class="flex items-center justify-between gap-3">
          <div class="text-base">
            <span class="text-gray-600">–ò—Ç–æ–≥–æ:</span> <b id="totalVal">0 —Ä—É–±.</b>
            <!-- —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
            <button id="cartBadge" class="ml-2 align-middle w-9 h-9 rounded-lg border bg-white grid place-items-center hidden" title="–ú–æ–∏ –∑–∞–∫–∞–∑—ã">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6h15l-1.5 9h-12L6 6Zm0 0L5 3H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="20" r="1.6" fill="currentColor"/><circle cx="18" cy="20" r="1.6" fill="currentColor"/></svg>
            </button>
          </div>
          <button id="confirmBtn" class="px-4 py-3 rounded-xl bg-black text-white disabled:opacity-40 disabled:cursor-not-allowed" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </div>
  `);

  const categoryBar=root.querySelector('#categoryBar'); 
  const catPager=root.querySelector('#catPager');
  const totalEl=root.querySelector('#totalVal');
  const confirmBtn=root.querySelector('#confirmBtn'); 
  const cartBadge=root.querySelector('#cartBadge');

  setBodyScrollLock(true);
  const scrollMemory=new Map(); let activeIdx=0, isAnimating=false; let unavailableClient=new Set(loadUnavailable());
  const panelW=()=> catPager.getBoundingClientRect().width || 1;

  loadConfig().menu.forEach((cat,idx)=> categoryBar.appendChild(el(`<button type="button" class="px-3 py-1.5 rounded-full border text-sm whitespace-nowrap ${idx===0?'bg-black text-white border-black':'bg-white/50'}" data-idx="${idx}">${cat.title}</button>`)));
  function highlightChip(idx){ categoryBar.querySelectorAll('button').forEach((b,i)=>{ const on=i===idx; b.classList.toggle('bg-black',on); b.classList.toggle('text-white',on); b.classList.toggle('border-black',on); if(on) b.scrollIntoView({inline:'center', block:'nearest', behavior:'smooth'}); }); }
  function goToIndex(idx,{animate=true}={}){ idx=Math.max(0,Math.min(loadConfig().menu.length-1,idx)); const target=Math.round(panelW()*idx); highlightChip(idx); if(!animate){ catPager.scrollLeft=target; activeIdx=idx; return } isAnimating=true; const prevSnap=catPager.style.scrollSnapType; catPager.style.scrollSnapType='none'; const old=catPager.children[activeIdx]?.querySelector('.v-scroll'); if(old){ scrollMemory.set(loadConfig().menu[activeIdx].key, old.scrollTop); } animateScrollX(catPager, target, { duration:280, onEnd(){ const box=catPager.children[idx]?.querySelector('.v-scroll'); if(box){ box.scrollTop = scrollMemory.get(loadConfig().menu[idx].key)||0; } activeIdx=idx; isAnimating=false; catPager.style.scrollSnapType=prevSnap||'x mandatory'; }}); }
  categoryBar.addEventListener('click', e=>{ const b=e.target.closest('button[data-idx]'); if(!b||isAnimating) return; goToIndex(+b.dataset.idx,{animate:true}) });

  function buildPanels(){
    catPager.innerHTML='';
    const cfg = loadConfig();
    cfg.menu.forEach((cat)=>{
      const panel=el(`<div class="cat-panel"></div>`), vbox=el(`<div class="v-scroll px-0.5"></div>`), list=el(`<div class="grid gap-3"></div>`);
      cat.items.forEach(it=>{
        const q=(window.__orderCounts?.[it.name]||0); const disabled=unavailableClient.has(it.name);
        const row = el(`
          <div class="menu-card ${disabled?'opacity-50':''}">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm flex items-center gap-2">${it.name}${disabled?'<span class="badge red">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>':''}</div>
              ${ cfg.theme.showPrice ? `<div class="text-xs text-gray-500 mt-1">${money(it.price||0)}</div>` : '' }
              <div class="flex items-center gap-3 mt-3">
                <button type="button" class="w-8 h-8 rounded-xl border" data-name="${it.name}" data-act="dec" ${disabled?'disabled':''}>‚àí</button>
                <div class="w-6 text-center text-sm" data-q="${it.name}">${q}</div>
                <button type="button" class="w-8 h-8 rounded-xl bg-black text-white" data-name="${it.name}" data-act="inc" ${disabled?'disabled':''}>+</button>
              </div>
            </div>
            <img src="${it.img||'https://placehold.co/110x70?text=food'}" class="menu-card-img" alt="">
          </div>`);
        const minusBtn = row.querySelector('button[data-act="dec"]');
        const plusBtn  = row.querySelector('button[data-act="inc"]');
        function adjust(delta){
          const name = it.name;
          const targetBtn = delta>0 ? plusBtn : minusBtn;
          if (targetBtn.disabled) return;
          if(!window.__orderCounts) window.__orderCounts = {};
          window.__orderCounts[name] = Math.max(0, (window.__orderCounts[name]||0) + delta);
          row.querySelector(`[data-q="${CSS.escape(name)}"]`).textContent = window.__orderCounts[name]||0;
          recalcTotal();
        }
        minusBtn.onclick = ()=>adjust(-1);
        plusBtn.onclick  = ()=>adjust(+1);
        [minusBtn,plusBtn].forEach(b=> b.addEventListener('keydown',(e)=>{ if((e.key==='Enter'||e.key===' ')&&!b.disabled){ e.preventDefault(); b.click(); }}));
        list.appendChild(row);
      });
      list.appendChild(el(`<div class="h-24"></div>`));
      vbox.appendChild(list); panel.appendChild(vbox); catPager.appendChild(panel);

      // —Å–≤–∞–π–ø
      let down=false, used=false, sx=0, sy=0, locked=null; const PIX_LOCK=10, THRESH=()=>Math.max(40, (catPager.getBoundingClientRect().width||1)*0.25);
      vbox.addEventListener('pointerdown',e=>{ if(isAnimating) return; down=true; used=false; sx=e.clientX; sy=e.clientY; locked=null; vbox.setPointerCapture?.(e.pointerId); });
      vbox.addEventListener('pointermove',e=>{ if(!down||used||isAnimating) return; const dx=e.clientX-sx, dy=e.clientY-sy;
        if(locked===null){ if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>PIX_LOCK) locked='x'; else if(Math.abs(dy)>Math.abs(dx)&&Math.abs(dy)>PIX_LOCK) locked='y'; }
        if(locked==='x'){ e.preventDefault(); if(Math.abs(dx)>=THRESH()){ used=true; const next=dx<0?activeIdx+1:activeIdx-1; goToIndex(next,{animate:true}); } } }, {passive:false});
      ['pointerup','pointercancel','pointerleave'].forEach(evt=> vbox.addEventListener(evt,()=>{ down=false; used=false; locked=null; }));
    });

    applyHeights(); setTimeout(applyHeights,60);
  }

  // –∫–ª–∏–∫–∏ (–ü–ö)
  catPager.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn || btn.disabled) return;
    const name = btn.dataset.name;
    const delta = btn.dataset.act === 'inc' ? +1 : -1;
    const cur = parseInt(catPager.querySelector(`[data-q="${CSS.escape(name)}"]`)?.textContent||'0',10) || 0;
    const next = Math.max(0, cur + delta);
    catPager.querySelectorAll(`[data-q="${CSS.escape(name)}"]`).forEach(n=> n.textContent = String(next));
    if(!window.__orderCounts) window.__orderCounts = {};
    window.__orderCounts[name] = next;
    recalcTotal();
  });

  function applyHeights(){
    try{
      const headerH = document.querySelector('.brand-strip')?.getBoundingClientRect().height || 0;
      const chipsH  = root.querySelector('.sticky-top')?.getBoundingClientRect().height || 0;
      const confirmH= root.querySelector('#confirmBar')?.getBoundingClientRect().height || 0;
      const availH = Math.max(240, window.innerHeight - headerH - chipsH - confirmH - 8);
      const first  = root.querySelector('.menu-card');
      const cardH  = first ? Math.ceil(first.getBoundingClientRect().height) : 104;
      const h = Math.min(availH, cardH*4 + 12*3 + 4);
      root.querySelectorAll('.v-scroll').forEach(el=> el.style.height=h+'px');
      goToIndex(activeIdx,{animate:false});
    }catch(err){}
  }
  window.addEventListener('resize', applyHeights);

  catPager.addEventListener('scroll', ()=>{
    if (isAnimating) return;
    if (catPager._scrollTimer) clearTimeout(catPager._scrollTimer);
    catPager._scrollTimer = setTimeout(()=>{ const idx = Math.round(catPager.scrollLeft / (catPager.getBoundingClientRect().width||1)); if(idx!==activeIdx){ highlightChip(idx); activeIdx=idx; } }, 80);
  });

  function recalcTotal(){
    const cfg = loadConfig();
    const counts = window.__orderCounts || {};
    let sum=0;
    cfg.menu.forEach(cat=>cat.items.forEach(it=> sum += (counts[it.name]||0)*(it.price||0) ));
    totalEl.textContent = money(sum);
    confirmBtn.disabled = sum<=0;
    return sum;
  }

  function updateCartBadge(){
    const list = loadHistory();
    const active = (Array.isArray(list)?list:[]).find(o=>!['–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].includes(o.status||''));
    if(active){ cartBadge.classList.remove('hidden'); }
    else { cartBadge.classList.add('hidden'); }
  }
  cartBadge.addEventListener('click', ()=> location.hash='#/history');
  updateCartBadge();
  window.addEventListener('orders:history-updated', updateCartBadge);

  confirmBtn.addEventListener('click', ()=>{
    const cfg = loadConfig();
    const counts = window.__orderCounts || {};
    const items=[]; cfg.menu.forEach(cat=>cat.items.forEach(it=>{ const q=(counts[it.name]||0); if(q>0) items.push({name:it.name, qty:q, price:it.price||0}); }));
    if(!items.length){ return; } // –±–µ–∑ —Ç–æ—Å—Ç–∞
    if (confirmBtn._busy) return; 
    confirmBtn._busy=true; 
    confirmBtn.disabled=true;

    const sumBox = document.getElementById('paySummary');
    let total=0; sumBox.innerHTML = items.map(i=>{ total += i.qty*(i.price||0); return `<div class="flex items-center justify-between"><div class="truncate">${i.name} √ó${i.qty}</div><div class="ml-2 whitespace-nowrap">${money(i.qty*(i.price||0))}</div></div>`; }).join('');
    sumBox.insertAdjacentHTML('beforeend', `<div class="mt-2 pt-2 border-t flex items-center justify-between font-semibold"><div>–ò—Ç–æ–≥–æ</div><div>${money(total)}</div></div>`);
    const prof=loadProfile(); const sel=document.getElementById('paySelect'); sel.value = prof.paymentMethod||'cash';
    document.getElementById('payModal').classList.add('open');
  });

  function resetCounts(){
    window.__orderCounts = {};
    catPager.querySelectorAll('[data-q]').forEach(n=> n.textContent='0');
    totalEl.textContent=money(0);
    confirmBtn.disabled = true;
  }

  (function bindPayModal(){
    const m=document.getElementById('payModal'); const ok=document.getElementById('payOk'); const cancel=document.getElementById('payCancel'); const sel=document.getElementById('paySelect');
    const close=()=> m.classList.remove('open');
    const finalize = ()=>{ confirmBtn._busy=false; confirmBtn.disabled=false; };
    const onCancel = (e)=>{ if(e){ e.preventDefault(); e.stopPropagation(); } close(); finalize(); };
    const onOk = async (e)=>{
      if(e){ e.preventDefault(); e.stopPropagation(); }
      const cfg = loadConfig();
      const counts = window.__orderCounts || {};
      const itemsSel=[]; let total=0;
      cfg.menu.forEach(cat=>cat.items.forEach(it=>{
        const q=(counts[it.name]||0);
        if(q>0){ itemsSel.push({name:it.name, qty:q, price:it.price||0}); total+=q*(it.price||0); }
      }));
      if(!itemsSel.length){ close(); finalize(); return; } // –±–µ–∑ —Ç–æ—Å—Ç–∞
      const order = { id: Date.now().toString().slice(-6), createdAt: Date.now(), items: itemsSel, total, pay: sel.value||'cash', status:'–Ω–æ–≤—ã–π' };
      // –ª–æ–∫–∞–ª—å–Ω–æ
      const history = loadHistory(); history.unshift(order); saveHistory(history.slice(0,50));
      const dash = loadDash(); dash.unshift(order); saveDash(dash.slice(0,200));
      const p=loadProfile(); p.paymentMethod = sel.value||'cash'; saveProfile(p);

      // –≤ –æ–±–ª–∞–∫–æ
      try{
        const clientId = (p.phone||'web') + '-' + (order.id||'');
        rpc({ op:'create', data:{ clientId, items:itemsSel, total, pay: sel.value||'cash' } }).catch(console.warn);
      }catch(e){ console.warn('RPC error', e); }

      close(); finalize(); resetCounts();
      window.dispatchEvent(new CustomEvent('orders:history-updated'));
    };
    ['click','pointerup','touchend'].forEach(ev=> ok.addEventListener(ev, onOk, {passive:false}));
    ['click','pointerup','touchend'].forEach(ev=> cancel.addEventListener(ev, onCancel, {passive:false}));
    m.onclick=(e)=>{ if(e.target===m) onCancel(e); };
  })();

  buildPanels();
  requestAnimationFrame(()=>{ highlightChip(0); goToIndex(0,{animate:false}); });
  root.cleanup = ()=> setBodyScrollLock(false);
  return root;
}

/* ===== –ü—Ä–æ—Ñ–∏–ª—å / –•–∞–± ===== */
function ProfileHubView(){
  const p=Object.assign({ name:'', phone:'', address:'', paymentMethod:'cash' }, loadProfile());
  const root=el(`
    <div class="grid gap-4 pb-28">
      <section class="grid grid-cols-2 gap-3">
        <button class="card card-tall p-4 text-left" id="profileEditBtn">
          <div class="flex items-start justify-between">
            <div class="min-w-0">
              <div class="text-base font-semibold truncate">${p.name || '–ò–º—è –§–∞–º–∏–ª–∏—è'}</div>
              <div class="text-xs text-gray-600 mt-2 truncate">${p.phone || '+7 ___ ___-__-__'}</div>
            </div>
            <svg width="22" height="22" viewBox="0 0 24 24" class="text-red-500"><circle cx="12" cy="12" r="10" fill="currentColor" opacity=".1"/></svg>
          </div>
        </button>
        <button class="card card-tall p-4 text-left flex items-center justify-between" id="ordersBtn">
          <div class="text-base font-semibold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
          <div class="flex items-center gap-3">
            <svg width="28" height="28" viewBox="0 0 24 24"><path d="M7 4h10l1 4H6l1-4Zm-1 6h12l-1.2 8.4A3 3 0 0 1 13.84 21h-3.68A3 3 0 0 1 7.2 18.4L6 10Z" fill="#ff6f00"/></svg>
            <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
        </button>
      </section>

      <section class="card p-5">
        <div class="text-2xl font-extrabold tracking-tight">–ó–î–ï–°–¨ –ë–£–î–ï–¢ –ë–õ–û–ö –ü–û–î –†–ï–ö–õ–ê–ú–£</div>
      </section>

      <section class="grid gap-2">
        <button class="rowlink text-left flex items-center justify-between" id="feedbackBtn">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
          <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </section>

      <section id="tabloTapZone">
        <div id="tabloTapHot" aria-label="tablo-tap-hot"></div>
      </section>
    </div>
  `);

  root.querySelector('#profileEditBtn').onclick = ()=> location.hash = '#/profile-edit';
  root.querySelector('#ordersBtn').onclick      = ()=> location.hash = '#/history';
  root.querySelector('#feedbackBtn').onclick    = ()=> location.hash = '#/contact';
  return root;
}

/* ===== –ö–æ–Ω—Ç–∞–∫—Ç—ã ===== */
function ContactView(){
  const p=Object.assign({ phone:'', }, loadProfile());
  const root=el(`
    <div class="grid gap-4 pb-24">
      <div class="flex items-center gap-3">
        <button id="backOnly" class="px-3 py-2 rounded-xl border bg-white" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
        <div class="text-lg font-semibold">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
      </div>
      <section class="card p-4 text-sm grid gap-2">
        <div>–ü–æ—á—Ç–∞: <a class="underline" href="mailto:sabirbis@bk.ru">sabirbis@bk.ru</a></div>
        <div>–¢–µ–ª.: <a class="underline" href="tel:+79899932108">+7 989 993-21-08</a></div>
        ${ p.phone ? `<div class="text-xs text-gray-500">–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ: ${p.phone}</div>` : '' }
      </section>
    </div>
  `);
  root.querySelector('#backOnly').onclick = ()=> history.length ? history.back() : (location.hash='#/profile');
  return root;
}

/* ===== –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è ===== */
function ProfileEditView(){ 
  const p=Object.assign({ name:'', phone:'', address:'', paymentMethod:'cash' }, loadProfile());
  const root=el(`
    <div class="grid gap-4 pb-24">
      <section class="glass-panel rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="grid gap-3">
          <input id="pName" class="border rounded-xl p-3" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" value="${p.name||''}">
          <input id="pPhone" class="border rounded-xl p-3" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7‚Ä¶)" value="${p.phone||''}">
          <input id="pAddr" class="border rounded-xl p-3" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" value="${p.address||''}">
          <div class="text-sm font-medium mt-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
          <select id="paydef" class="border rounded-xl p-3">
            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
            <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
            <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
          </select>
          <div class="flex gap-2">
            <button id="pSave" class="px-4 py-3 rounded-xl bg-black text-white flex-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="pBack" class="px-4 py-3 rounded-xl border flex-1">–ù–∞–∑–∞–¥</button>
          </div>
        </div>
      </section>
    </div>
  `);
  root.querySelector('#paydef').value = p.paymentMethod;
  root.querySelector('#pSave').onclick=()=>{ const p2={ name:root.querySelector('#pName').value.trim(), phone:root.querySelector('#pPhone').value.trim(), address:root.querySelector('#pAddr').value.trim(), paymentMethod:root.querySelector('#paydef').value }; saveProfile(p2); showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); location.hash='#/profile'; };
  root.querySelector('#pBack').onclick=()=> history.length ? history.back() : (location.hash='#/profile');
  return root;
}

/* ===== –ò—Å—Ç–æ—Ä–∏—è ===== */
function HistoryView(){ 
  const root=el(`
    <div class="grid gap-3 pb-24">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
        <div class="flex gap-2">
          <button id="clearAll" class="px-3 py-2 rounded-xl border">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
          <button id="back" class="px-3 py-2 rounded-xl border">–ù–∞–∑–∞–¥</button>
        </div>
      </div>
      <div id="historyList" class="grid gap-3"></div>
    </div>
  `);
  const box=root.querySelector('#historyList');
  function cardView(o, idx){
    const items=o.items||[];
    const active = !['–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].includes(o.status||'–Ω–æ–≤—ã–π');
    const chipClass = active ? 'bg-yellow-200 text-yellow-800' : 'bg-gray-200 text-gray-700';
    const outerBg = active ? 'bg-yellow-50 border-yellow-200' : 'bg-white';
    const elCard = el(`
      <div class="card p-4 ${outerBg}">
        <div class="flex items-center justify-between">
          <div class="text-2xl font-extrabold">‚Ññ ${o.id||'‚Äî'}</div>
          <span class="chip ${chipClass}">${o.status||'–Ω–æ–≤—ã–π'}</span>
        </div>
        <div class="text-xs text-gray-500 mt-1">${o.createdAt? new Date(o.createdAt).toLocaleString():''}</div>
        <div class="mt-3 grid gap-2">
          ${ items.map(i=>`
            <div class="flex items-center justify-between text-sm">
              <div class="truncate mr-2">${i.name}</div>
              <div class="whitespace-nowrap">${i.qty} √ó ${i.price} ‚ÇΩ</div>
            </div>
          `).join('') }
        </div>
        <div class="mt-3 border-t pt-2 flex items-center justify-between">
          <div class="font-semibold">–ò—Ç–æ–≥–æ: ${money(o.total||0)}</div>
          <div class="flex gap-2">
            <button class="px-3 py-2 rounded-xl border" data-repeat>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <button class="px-3 py-2 rounded-xl border text-red-600" data-del>–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      </div>
    `);
    elCard.querySelector('[data-repeat]').onclick=()=>{
      sessionStorage.setItem('repeat_order_items', JSON.stringify(items));
      sessionStorage.setItem('open_pay_after_repeat','1');
      location.hash='#/order';
    };
    elCard.querySelector('[data-del]').onclick=()=>{
      const cur=loadHistory(); cur.splice(idx,1); saveHistory(cur); render(); window.dispatchEvent(new CustomEvent('orders:history-updated'));
    };
    return elCard;
  }
  function render(){
    const list=loadHistory(); box.innerHTML='';
    if(!Array.isArray(list)||!list.length){ box.innerHTML='<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>'; return }
    list.forEach((o,idx)=> box.appendChild(cardView(o, idx)));
  }
  root.querySelector('#clearAll').onclick=()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')){ saveHistory([]); render(); window.dispatchEvent(new CustomEvent('orders:history-updated')); } };
  root.querySelector('#back').onclick=()=> history.length ? history.back() : (location.hash='#/profile');
  render(); return root;
}

/* ===== –¢–∞–±–ª–æ ===== */
function DashboardView(){ 
  const root=el(`
    <div class="grid gap-4 max-w-6xl pb-24">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-2">
          <h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h2>
          <button id="soundToggle" class="px-3 py-1.5 rounded-xl border bg-white" title="–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">üîî –ó–≤—É–∫</button>
        </div>
        <div class="flex items-center gap-2">
          <a href="#/builder" class="px-3 py-2 rounded-xl border bg-white" title="–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</a>
          <button id="btnClearAll" class="px-3 py-2 rounded-xl border bg-red-50 text-red-700">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
      </div>

      <div class="p-4 rounded-2xl bg-white border">
        <div class="flex items-center gap-2 flex-wrap mb-3">
          <h3 class="font-semibold">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>
          <button id="cfgPull" class="px-2 py-1 rounded-lg border">–û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é –∏–∑ –æ–±–ª–∞–∫–∞</button>
          <button id="cfgPush" class="px-2 py-1 rounded-lg border">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º–µ–Ω—é</button>
        </div>
        <p class="text-sm text-gray-500 mb-3">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–∫–æ–π, —á–µ–≥–æ –ù–ï–¢ ‚Äî –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Ç–æ–≤–∞—Ä —Å—Ç–∞–Ω–µ—Ç —Å–µ—Ä—ã–º –∏ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å.</p>
        <div id="stockList" class="grid gap-2 md:grid-cols-3"></div>
        <div class="mt-3"><button id="saveStock" class="px-3 py-2 rounded-xl border bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </div>

      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="list"></div>
      <div><button class="px-3 py-2 rounded-xl border" onclick="location.hash='#/profile'">–ù–∞–∑–∞–¥</button></div>
    </div>
  `);

  const list=root.querySelector('#list'); const stockList=root.querySelector('#stockList');
  let unavailable=new Set(loadUnavailable()); let dashOrders=loadDash();
  let knownIds = new Set(dashOrders.map(o=>String(o.id)));
  const ding = document.getElementById('orderDing');
  const soundBtn = root.querySelector('#soundToggle');
  const soundOn = ()=> localStorage.getItem(SOUND_ON_KEY)==='1';
  const setSound = (on)=>{ localStorage.setItem(SOUND_ON_KEY, on?'1':'0'); soundBtn.classList.toggle('bg-green-50', on); soundBtn.classList.toggle('border-green-600', on); };

  setSound(soundOn());
  soundBtn.onclick = ()=> setSound(!soundOn());

  // –Ω–∞–ª–∏—á–∏–µ
  function renderStock(){ stockList.innerHTML=''; loadConfig().menu.forEach(cat=>cat.items.forEach(item=>{ const row=el(`<label class="flex items-center gap-2 text-sm"><input type="checkbox" value="${item.name}" ${unavailable.has(item.name)?'checked':''} /><span>${item.name}</span></label>`); stockList.appendChild(row); })) }
  renderStock();
  root.querySelector('#saveStock').onclick=()=>{ const checked=[...stockList.querySelectorAll('input[type=checkbox]:checked')].map(i=>i.value); saveUnavailable(checked); unavailable=new Set(checked); showToast('–ù–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

  root.querySelector('#cfgPull').onclick = async ()=>{ const j=await fetchRemoteConfig(); if(j) { showToast('–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞'); } else { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ–Ω—é'); } };
  root.querySelector('#cfgPush').onclick = async ()=>{ await publishRemoteConfig(loadConfig()); };

  // –∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞
  function orderCard(o){
    const clientTotal=(o.items||[]).reduce((s,i)=> s + (i.price||0)*(i.qty||0),0);
    const total=Math.max(typeof o.total==='number'?o.total:0, clientTotal);
    const created=o.createdAt? new Date(o.createdAt): new Date();
    const colorMap = {
      '–Ω–æ–≤—ã–π':'bg-yellow-50 border-yellow-300','–≥–æ—Ç–æ–≤–∏—Ç—Å—è':'bg-blue-50 border-blue-300','–≤ –ø—É—Ç–∏':'bg-purple-50 border-purple-300',
      '–≥–æ—Ç–æ–≤':'bg-green-50 border-green-300','–∑–∞–≤–µ—Ä—à—ë–Ω':'bg-gray-100 border-gray-300','–æ—Ç–º–µ–Ω—ë–Ω':'bg-red-50 border-red-300'
    };
    const statusColor = colorMap[o.status] || 'bg-white border-gray-200';
    const itemsHtml = (o.items||[]).map(i => `<div class="flex justify-between text-lg"><div>${i.name}</div><div class="font-semibold">${i.qty} √ó ${i.price}</div></div>`).join('');
    const card=el(`
      <div class="p-6 rounded-3xl border-2 ${statusColor} shadow-sm flex flex-col gap-3 transition-transform hover:scale-[1.01]" data-id="${o.id}">
        <div class="flex items-center justify-between">
          <div class="text-2xl font-extrabold tracking-tight">#${o.id||'‚Äî'}</div>
          <span class="px-3 py-1 rounded-full text-sm font-medium border bg-white/50">${o.status||'–Ω–æ–≤—ã–π'}</span>
        </div>
        <div class="text-gray-600 text-sm">${created.toLocaleString()}</div>
        <div class="mt-2 grid gap-1 text-lg">${itemsHtml||'‚Äî'}</div>
        <div class="mt-3 flex items-center justify-between text-xl font-bold">
          <div>–ò—Ç–æ–≥–æ:</div><div>${total} ‚ÇΩ</div>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <label class="text-sm">–°—Ç–∞—Ç—É—Å:</label>
          <select class="border rounded-xl p-2 text-sm" data-k="status">
            ${['–Ω–æ–≤—ã–π','–≥–æ—Ç–æ–≤–∏—Ç—Å—è','–≤ –ø—É—Ç–∏','–≥–æ—Ç–æ–≤','–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].map(s=>`<option ${s===(o.status||'–Ω–æ–≤—ã–π')?'selected':''}>${s}</option>`).join('')}
          </select>
          <button type="button" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-100" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="px-3 py-2 rounded-xl border bg-red-50 hover:bg-red-100 text-red-600 ml-auto" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `);

    card.addEventListener('click', async (e)=>{
      const act=e.target.dataset.act; if(!act) return;
      if(act==='save'){
        const status=card.querySelector('[data-k="status"]').value;
        const i=dashOrders.findIndex(x=>String(x.id)===String(o.id));
        if(i>=0){ dashOrders[i]={...dashOrders[i], status}; saveDash(dashOrders); syncOrderStatus(o.id, status); showToast(`–°—Ç–∞—Ç—É—Å #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`); }
        try{ rpc({op:'update', id:o.id, patch:{status}}).catch(()=>{}); }catch{}
      }
      if(act==='delete'){
        if(!card.dataset.confirm){ card.dataset.confirm='1'; e.target.textContent='–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?'; setTimeout(()=>{ if(card&&card.dataset.confirm==='1'){ delete card.dataset.confirm; e.target.textContent='–£–¥–∞–ª–∏—Ç—å' }},3000); return }
        dashOrders=dashOrders.filter(x=>String(x.id)!==String(o.id)); saveDash(dashOrders); card.remove(); showToast(`–ó–∞–∫–∞–∑ #${o.id} —É–¥–∞–ª—ë–Ω`);
        try{ rpc({op:'delete', id:o.id}).catch(()=>{}); }catch{}
      }
    });

    return card;
  }

  function load(){
    const unique=new Map(); dashOrders.forEach(o=>unique.set(String(o.id),o));
    // –∑–≤—É–∫ –Ω–∞ –Ω–æ–≤—ã–µ
    const incoming = [...unique.keys()].filter(id=>!knownIds.has(id));
    if(incoming.length && soundOn()){ ding.currentTime = 0; ding.play().catch(()=>{}); }
    knownIds = new Set(unique.keys());

    list.innerHTML='';
    if(unique.size===0){ list.innerHTML=`<div class="p-5 rounded-2xl bg-white border text-gray-500 col-span-full">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>`; return }
    [...unique.values()].forEach(o=> list.appendChild(orderCard(o)) );
  }

  // –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ
  root.querySelector('#btnClearAll').onclick = async ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã?')) return;
    const ids = (dashOrders||[]).map(o=>o.id);
    dashOrders = []; saveDash(dashOrders); load();
    try{
      // –ï—Å–ª–∏ —Ä–µ–∞–ª–∏–∑—É–µ—à—å –Ω–∞ –±—ç–∫–µ:
      await rpc({ op:'clear' });
    }catch{
      // fallback ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ –æ–¥–Ω–æ–º—É
      for(const id of ids){ try{ await rpc({op:'delete', id}); }catch{} }
    }
  };

  async function loadOrdersFromCloud(){
    try{
      const res = await rpc({ op:'list' });
      if (Array.isArray(res.orders)){
        saveDash(res.orders);
        dashOrders = res.orders.slice();
        load();
      }
    }catch(e){ console.warn('loadOrdersFromCloud', e); }
  }
  load();            
  loadOrdersFromCloud();
  setInterval(loadOrdersFromCloud, 5000);

  return root;
}

/* ===== –ö–û–ù–°–¢–†–£–ö–¢–û–† (–º–µ–Ω—é) ===== */
function BuilderView(){
  const cfg = loadConfig();
  const root = el(`
    <div class="grid gap-4 pb-28">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –º–µ–Ω—é</h2>
        <div class="flex gap-2">
          <button id="exportBtn" class="px-3 py-2 rounded-xl border">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
          <label class="px-3 py-2 rounded-xl border cursor-pointer">
            –ò–º–ø–æ—Ä—Ç JSON<input id="importInput" type="file" accept="application/json" class="hidden">
          </label>
          <button id="backBtn2" class="px-3 py-2 rounded-xl border">–ù–∞–∑–∞–¥</button>
        </div>
      </div>

      <section class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–æ–≤–∞—Ä—ã</h3>
          <div class="flex gap-2">
            <button id="addCatBtn" class="px-3 py-2 rounded-xl border">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
            <button id="cloudPull" class="px-3 py-2 rounded-xl border">–û–±–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
            <button id="cloudPush" class="px-3 py-2 rounded-xl border">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
          </div>
        </div>
        <div id="catsBox" class="grid gap-4"></div>
      </section>

      <div class="flex gap-2">
        <button id="applyBtn" class="px-4 py-3 rounded-xl bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é</button>
      </div>
    </div>
  `);

  const catsBox = root.querySelector('#catsBox');
  function render(){
    catsBox.innerHTML='';
    cfg.menu.forEach((cat, cidx)=>{
      const catCard = el(`
        <div class="border rounded-2xl p-3 bg-white">
          <div class="flex items-center justify-between">
            <input value="${cat.title}" class="border rounded-xl p-2 font-semibold w-1/2" data-k="title">
            <div class="flex gap-2">
              <button class="px-2 py-1 rounded-lg border" data-act="up">‚Üë</button>
              <button class="px-2 py-1 rounded-lg border" data-act="down">‚Üì</button>
              <button class="px-2 py-1 rounded-lg border text-red-600" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <div class="text-xs text-gray-500 mt-1">key: <code>${cat.key}</code></div>
          <div class="mt-3">
            <button class="px-3 py-2 rounded-xl border" data-act="addItem">+ –¢–æ–≤–∞—Ä</button>
          </div>
          <div class="mt-3 grid gap-2" data-items></div>
        </div>
      `);
      const itemsBox = catCard.querySelector('[data-items]');
      cat.items.forEach((it, iidx)=>{
        const row = el(`
          <div class="grid grid-cols-12 gap-2 border rounded-xl p-2">
            <input class="col-span-5 border rounded-lg p-2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${it.name||''}" data-k="name">
            <input class="col-span-2 border rounded-lg p-2" type="number" placeholder="–¶–µ–Ω–∞" value="${it.price||0}" data-k="price">
            <input class="col-span-4 border rounded-lg p-2" placeholder="URL —Ñ–æ—Ç–æ" value="${it.img||''}" data-k="img">
            <div class="col-span-1 flex items-center gap-1 justify-end">
              <button class="px-2 py-1 rounded-md border" data-act="iUp">‚Üë</button>
              <button class="px-2 py-1 rounded-md border" data-act="iDown">‚Üì</button>
              <button class="px-2 py-1 rounded-md border text-red-600" data-act="iDel">‚úï</button>
            </div>
          </div>
        `);
        row.addEventListener('input', (e)=>{
          const k=e.target.dataset.k;
          if(k==='price') cat.items[iidx][k]=Number(e.target.value||0);
          else cat.items[iidx][k]=e.target.value;
        });
        row.addEventListener('click',(e)=>{
          const act=e.target.dataset.act; if(!act) return;
          if(act==='iDel'){ cat.items.splice(iidx,1); render(); }
          if(act==='iUp' && iidx>0){ const t=cat.items[iidx-1]; cat.items[iidx-1]=cat.items[iidx]; cat.items[iidx]=t; render(); }
          if(act==='iDown' && iidx<cat.items.length-1){ const t=cat.items[iidx+1]; cat.items[iidx+1]=cat.items[iidx]; cat.items[iidx]=t; render(); }
        });
        itemsBox.appendChild(row);
      });

      catCard.addEventListener('input',(e)=>{ if(e.target.dataset.k==='title'){ cat.title=e.target.value; }});
      catCard.addEventListener('click',(e)=>{
        const act=e.target.dataset.act; if(!act) return;
        if(act==='del'){ if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')){ cfg.menu.splice(cidx,1); render(); } }
        if(act==='up' && cidx>0){ const t=cfg.menu[cidx-1]; cfg.menu[cidx-1]=cfg.menu[cidx]; cfg.menu[cidx]=t; render(); }
        if(act==='down' && cidx<cfg.menu.length-1){ const t=cfg.menu[cidx+1]; cfg.menu[cidx+1]=cfg.menu[cidx]; cfg.menu[cidx]=t; render(); }
        if(act==='addItem'){ cat.items.push({name:'–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä', price:0, img:''}); render(); }
      });

      catsBox.appendChild(catCard);
    });
  }
  render();

  root.querySelector('#addCatBtn').onclick=()=>{
    const id = 'cat'+(Date.now().toString().slice(-5));
    cfg.menu.push({ key:id, title:'–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è', items:[] });
    render();
  };

  root.querySelector('#cloudPull').onclick = async ()=>{ const j=await fetchRemoteConfig(); if(j){ showToast('–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞'); location.reload(); } else showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ–Ω—é'); };
  root.querySelector('#cloudPush').onclick = async ()=>{ await publishRemoteConfig(cfg); };

  root.querySelector('#exportBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='yamamoto-config.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  root.querySelector('#importInput').onchange=(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const fr=new FileReader(); fr.onload=()=>{ try{ const json=JSON.parse(fr.result); saveConfig(json); showToast('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω—Ñ–∏–≥'); location.reload(); }catch{ alert('–ù–µ–≤–µ—Ä–Ω—ã–π JSON'); } };
    fr.readAsText(f);
  };

  root.querySelector('#applyBtn').onclick=()=>{
    saveConfig(cfg);
    applyTheme(cfg.theme);
    MENU_CATEGORIES = cfg.menu.slice();
    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    history.length ? history.back() : (location.hash='#/dashboard');
  };
  root.querySelector('#backBtn2').onclick=()=> history.length ? history.back() : (location.hash='#/dashboard');
  return root;
}

/* ===== 4-—Ç–∞–ø –∑–æ–Ω–∞ ===== */
function bindTabloTapZone(){
  const hot = document.getElementById('tabloTapHot');
  if (!hot || hot._bound) return; hot._bound = true;
  let taps = 0, first = 0, timer = null;
  const windowMs = 1200;
  function reset(){ taps = 0; first = 0; if (timer){ clearTimeout(timer); timer = null; } }
  function handler(){
    const now = Date.now();
    if (!first) first = now; taps++;
    if (now - first > windowMs){ reset(); taps = 1; first = now; }
    if (taps >= 4){
      reset();
      document.getElementById('payModal')?.classList.remove('open');
      if (sessionStorage.getItem(TABLO_PIN_OK) === '1'){ location.hash = '#/dashboard'; }
      else { sessionStorage.setItem(WANT_DASH,'1'); document.getElementById('pinModal').classList.add('open'); }
    }else{ if (timer) clearTimeout(timer); timer = setTimeout(reset, windowMs); }
  }
  ['click','pointerup','touchend'].forEach(ev => hot.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); handler(); }, {passive:false}));
}

/* ===== Router ===== */
function mount(view){ const app=document.getElementById('app'); if(app.firstChild && typeof app.firstChild.cleanup==='function'){ try{ app.firstChild.cleanup(); }catch{} } app.innerHTML=''; app.classList.add('phone-shell'); app.appendChild(view); }
function realRouter(){
  const h=location.hash.split('?')[0];
  if(h==='#/profile'){ mount(ProfileHubView()); bindTabloTapZone(); }
  else if(h==='#/profile-edit') mount(ProfileEditView());
  else if(h==='#/history') mount(HistoryView());
  else if(h==='#/contact') mount(ContactView());
  else if(h==='#/dashboard') mount(DashboardView());
  else if(h==='#/builder') mount(BuilderView());
  else mount(OrderView());
}
function router(){
  const h=location.hash.split('?')[0];
  const profileBtn=document.getElementById('profileBtn'); const backBtn=document.getElementById('backBtn');
  const showBack=(h==='#/profile'||h==='#/history'||h==='#/profile-edit'||h==='#/contact'||h==='#/builder');
  if(showBack){ profileBtn.classList.add('hidden'); backBtn.classList.remove('hidden'); } else { backBtn.classList.add('hidden'); profileBtn.classList.remove('hidden'); }

  if(h==='#/dashboard' && sessionStorage.getItem(TABLO_PIN_OK)!=='1'){
    sessionStorage.setItem(WANT_DASH,'1');
    document.getElementById('pinModal').classList.add('open');
    const app=document.getElementById('app'); if(app) app.innerHTML='';
    return;
  }
  if(h==='#/profile'){ document.getElementById('payModal')?.classList.remove('open'); }
  realRouter();
}
window.addEventListener('hashchange', ()=>{ try{ router(); }catch(e){ console.error(e); }});
try{ router(); }catch(e){ console.error(e); }

/* Header + PIN */
document.addEventListener('DOMContentLoaded', async ()=>{
  const profileBtn=document.getElementById('profileBtn');
  const goProfile=(e)=>{ if(e){ e.preventDefault(); e.stopPropagation(); } location.hash='#/profile'; };
  ['click','pointerup','touchend'].forEach(ev=> profileBtn.addEventListener(ev, goProfile, {passive:false}));

  const backBtn=document.getElementById('backBtn');
  const goOrder=(e)=>{ if(e){ e.preventDefault(); e.stopPropagation(); } history.length ? history.back() : (location.hash='#/order'); };
  ['click','pointerup','touchend'].forEach(ev=> backBtn.addEventListener(ev, goOrder, {passive:false}));

  bindTabloTapZone();

  // –ø–æ–¥—Ç—è–Ω—É—Ç—å –º–µ–Ω—é –∏–∑ –æ–±–ª–∞–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω URL)
  await fetchRemoteConfig().catch(()=>{});

  const pinM=document.getElementById('pinModal'); const pinOk=document.getElementById('pinOk'); const pinCancel=document.getElementById('pinCancel'); const pinInput=document.getElementById('pinInput');
  pinOk.onclick=(e)=>{
    e&&e.preventDefault();
    if((pinInput.value||'').length>0){
      sessionStorage.setItem(TABLO_PIN_OK,'1');
      pinM.classList.remove('open');
      if (sessionStorage.getItem(WANT_DASH)==='1'){ sessionStorage.removeItem(WANT_DASH); location.hash='#/dashboard'; }
      else { router(); }
    } else { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á'); }
  };
  pinCancel.onclick=()=>{ pinM.classList.remove('open'); sessionStorage.removeItem(WANT_DASH); location.hash='#/profile'; };
  pinM.onclick=(e)=>{ if(e.target===pinM) pinCancel.onclick(); };
});
</script>
</body>
</html>
