<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>üçü –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; background:#f9fafb; }
    *, *::before, *::after { box-sizing:border-box; }
    img { max-width:100%; display:block; }
    .hidden{ display:none }
    .phone-shell{ width:min(100vw,540px); margin:0 auto; padding:0 .35rem; }

    .toast{ position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; padding:.75rem 1rem; border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.2); opacity:.95; z-index:9999 }

    /* Glass + UI */
    .glass-panel{ background:radial-gradient(circle at 10% 20%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.45) 45%, rgba(255,255,255,.25) 100%);
      backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.4); box-shadow:0 14px 40px rgba(15,23,42,.12) }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .sticky-top{ position:sticky; top:.5rem; z-index:40 }

    /* –ø—Ä–∞–≤—ã–π —Ö—ç–Ω–¥–ª –∏—Å—Ç–æ—Ä–∏–∏ (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –±—ã–ª–æ) */
    .sheet{ position:fixed; inset:0; z-index:85; background:rgba(0,0,0,.2); display:none; }
    .sheet.open{ display:block }
    .sheet-panel{ position:absolute; top:0; right:0; height:100%; width:min(92vw,360px); background:#fff; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.2); overflow:auto }
    .history-handle{ position:fixed; top:40%; right:max(0, calc((100vw - 540px)/2 - 2px)); transform:translateY(-50%);
      writing-mode:vertical-rl; text-orientation:mixed; background:#0f172a; color:#fff; border-radius:10px 0 0 10px; padding:.5rem .35rem; z-index:70; font-size:.8rem }

    /* ===== —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∏–∑ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è ===== */
    .checkout-bar{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: .75rem;
      width: min(540px, 96vw);
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 1rem;
      padding: .6rem .75rem;
      box-shadow: 0 14px 35px rgba(15,23,42,.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      z-index: 60;
    }
    .checkout-btn{
      background:#000; color:#fff; border-radius:.9rem; padding:.75rem 1rem; font-weight:600;
    }

    /* –≤–Ω—É—Ç—Ä–∏ OrderView: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª —É —Å–ø–∏—Å–∫–∞ */
    #menuScroll{
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .cat-section-title{
      font-size:.95rem; font-weight:600; margin: .25rem 0 .35rem;
    }

    /* –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ–Ω—é */
    .menu-card{ display:flex; gap:.75rem; align-items:center; background:#fff; border:1px solid #edf2f7; border-radius:1.25rem; padding:1rem; min-height:6.4rem }
    .menu-card.disabled{ opacity:.5 }
    .menu-card-img{ width:110px; height:70px; border-radius:.75rem; background:#eee; object-fit:cover }
  </style>
</head>
<body>
  <div class="w-full py-6">
    <!-- Header -->
    <header class="phone-shell flex items-center justify-between mb-4 sm:mb-6 gap-3">
      <div class="flex items-center gap-3">
        <button id="burgerBtn" class="px-3 py-2 rounded-xl border" aria-label="menu">‚ò∞</button>
        <h1 class="text-xl sm:text-2xl font-bold">üçü –û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑</h1>
      </div>
      <nav class="flex gap-2 items-center">
        <!-- –º–µ–Ω—é-–±—É—Ä–≥–µ—Ä (drawer) –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–ª–µ–≤–∞ -->
      </nav>
    </header>

    <!-- Drawer -->
    <div id="drawer" class="drawer" style="position:fixed; inset:0; z-index:90; background:rgba(0,0,0,.35); display:none;">
      <div class="drawer-panel" style="position:absolute; top:0; left:0; height:100%; width:min(88vw,320px); background:#fff; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.2)">
        <div class="flex items-center justify-between mb-3">
          <div class="text-lg font-semibold">–ú–µ–Ω—é</div>
          <button id="drawerClose" class="px-2 py-1 rounded-lg border">‚úï</button>
        </div>
        <div class="grid gap-2">
          <a href="#/profile" class="px-3 py-3 rounded-xl border hover:bg-gray-50">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
          <button id="drawerPay" class="px-3 py-3 rounded-xl border hover:bg-gray-50 text-left">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</button>
          <button id="drawerLegal" class="px-3 py-3 rounded-xl border hover:bg-gray-50 text-left">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
          <a href="tel:+798989932108" class="px-3 py-3 rounded-xl border hover:bg-gray-50">–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞: +7 989 899 32 108</a>
        </div>
      </div>
    </div>

    <!-- Pin modal (tablo) -->
    <div id="pinModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
      <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow">
        <h3 class="text-lg font-semibold mb-3">–í—Ö–æ–¥ –≤ —Ç–∞–±–ª–æ</h3>
        <p class="text-sm text-gray-600 mb-3">–í–≤–µ–¥–∏—Ç–µ –ø–∏–Ω-–∫–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
        <input id="pinInput" type="password" class="w-full border rounded-xl p-3 mb-4" placeholder="–ü–∏–Ω-–∫–æ–¥" />
        <div class="flex gap-2 justify-end">
          <button id="pinCancel" type="button" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
          <button id="pinOk" type="button" class="px-3 py-2 rounded-xl border bg-black text-white">–í–æ–π—Ç–∏</button>
        </div>
        <p id="pinError" class="text-sm text-red-600 mt-2 hidden">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∏–Ω</p>
      </div>
    </div>

    <!-- Screens -->
    <main id="app" class="phone-shell"></main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <!-- Order confirm modal -->
  <div id="orderConfirmModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[99]">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm max-h-[90vh] overflow-y-auto shadow-lg space-y-4">
      <h3 class="text-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑</h3>
      <div id="orderConfirmList" class="space-y-2 text-sm"></div>
      <div id="orderConfirmTotal" class="text-base font-medium pt-1"></div>
      <div id="orderConfirmClient" class="text-sm text-gray-500"></div>
      <div class="flex gap-2 justify-end pt-2">
        <button id="orderConfirmCancel" type="button" class="px-3 py-2 rounded-xl border">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button id="orderConfirmOk" type="button" class="px-3 py-2 rounded-xl bg-black text-white">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Payment modal -->
  <div id="paymentModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[98]">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm shadow-lg space-y-3">
      <h3 class="text-lg font-semibold">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
      <div class="grid gap-2">
        <button data-pay="cash" class="px-3 py-3 rounded-xl border hover:bg-gray-50 text-left">–ù–∞–ª–∏—á–Ω—ã–µ</button>
        <button data-pay="card" class="px-3 py-3 rounded-xl border hover:bg-gray-50 text-left">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</button>
        <button data-pay="transfer" class="px-3 py-3 rounded-xl border hover:bg-gray-50 text-left">–ü–µ—Ä–µ–≤–æ–¥</button>
      </div>
      <div class="flex justify-end pt-1">
        <button id="paymentClose" class="px-3 py-2 rounded-xl border">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Right history sheet -->
  <button id="historyHandle" class="history-handle">–ò—Å—Ç–æ—Ä–∏—è</button>
  <div id="historySheet" class="sheet">
    <div class="sheet-panel">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
        <button id="historyClose" class="px-2 py-1 rounded-lg border">‚úï</button>
      </div>
      <div id="historyList" class="grid gap-2"></div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const ALLOWED_PIN = "65Vafuza";
const API_BASE   = "https://d5d1ec44lv5uk5k7k9to.bixf7e87.apigw.yandexcloud.net/order";
const UNAVAILABLE_LS_KEY = 'orders_unavailable_v1';
const CLIENT_HISTORY_KEY = 'orders_client_history_v1';
const PROFILE_LS_KEY = 'client_profile_v1';

if (!location.hash || location.hash === "#/" || location.hash === "#") {
  location.hash = "#/home";
}

/* ===== Helpers ===== */
function getClientId(){
  const KEY='yc_client_id_v1';
  let cid=localStorage.getItem(KEY);
  if(!cid){ cid='cid-'+Math.random().toString(36).slice(2)+Date.now(); localStorage.setItem(KEY,cid); }
  return cid;
}
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2500); }
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function money(x){ return x+' —Ä—É–±.' }

function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_LS_KEY))||{} }catch{ return {} } }
function saveProfile(p){ localStorage.setItem(PROFILE_LS_KEY, JSON.stringify(p||{})) }

/* offline store */
const LS_KEY='orders_yc_fallback_v1';
const store={ load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{orders:[], nextLocalId:1} }catch{ return {orders:[], nextLocalId:1} } },
              save(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)) } };

/* API */
async function ycCall(op, extra={}){
  const payload={ op, ...extra };
  try{
    const res=await fetch(API_BASE,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });
    const text=await res.text(); let data={}; if(text){ try{ data=JSON.parse(text) }catch{ return {error:"bad-json", status:res.status, raw:text} } }
    if(!res.ok) return { error:"http", status:res.status, data };
    return data;
  }catch(e){ return { error:"network", message:e.message } }
}

/* Menu data */
const MENU_CATEGORIES = [
  { key:'burgers', title:'–ë—É—Ä–≥–µ—Ä—ã', items:[
    { name:'–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä', price:280, img:'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
    { name:'–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price:340, img:'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä', price:200, img:'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price:250, img:'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
  ]},
  { key:'twisters', title:'–¢–≤–∏—Å—Ç–µ—Ä—ã', items:[ { name:'–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price:200 }, { name:'–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å', price:250 } ]},
  { key:'drinks', title:'–ù–∞–ø–∏—Ç–∫–∏', items:[ { name:'–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price:100 }, { name:'–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price:100 }, { name:'–°–ø—Ä–∞–π—Ç', price:100 }, { name:'–≠—Å–ø—Ä–µ—Å—Å–æ', price:120 }, { name:'–ë–∞–Ω–∞–Ω–æ–≤—ã–π —Ä–∞—Ñ', price:180 }, { name:'–ß–∞–π —á—ë—Ä–Ω—ã–π', price:70 } ]},
  { key:'sushi', title:'–°—É—à–∏ / —Ä–æ–ª–ª—ã', items:[ { name:'–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price:350 }, { name:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price:390 }, { name:'–ê–ª—è—Å–∫–∞', price:350 } ]},
  { key:'potato', title:'–ö–∞—Ä—Ç–æ—à–∫–∞', items:[ { name:'–§—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏–π', price:150 }, { name:'–§—Ä–∏ –±–æ–ª—å—à–æ–π', price:180 }, { name:'–ü–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏ –º–∞–ª–µ–Ω—å–∫–∏–π', price:160 }, { name:'–ü–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏ –±–æ–ª—å—à–æ–π', price:200 } ]},
  { key:'semi', title:'–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã', items:[ { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 6 —à—Ç.', price:160 }, { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 9 —à—Ç.', price:210 }, { name:'–°—Ç—Ä–∏–ø—Å—ã', price:190 } ]},
];

function findPriceByName(name){ for(const cat of MENU_CATEGORIES){ const f=cat.items.find(i=>i.name===name); if(f) return f.price } return 0 }
function calcTotalFromItems(order){ let sum=0; (order.items||[]).forEach(i=>{ const p=typeof i.price==='number'?i.price:findPriceByName(i.name); sum += p*(i.qty||0) }); return sum }

/* unavailable */
async function fetchUnavailableFromServer(){ const res=await ycCall("getUnavailable",{}); if(!res.error && res && Array.isArray(res.items)) return res.items; return null }
async function saveUnavailableToServer(items){ const res=await ycCall("setUnavailable",{items}); return !res.error }
function loadUnavailableFromLS(){ try{ const raw=localStorage.getItem(UNAVAILABLE_LS_KEY); if(!raw) return []; const arr=JSON.parse(raw); return Array.isArray(arr)?arr:[] }catch{ return [] } }
function saveUnavailableToLS(items){ localStorage.setItem(UNAVAILABLE_LS_KEY, JSON.stringify(items)) }

/* client history */
function loadClientHistory(clientId){ try{ const all=JSON.parse(localStorage.getItem(CLIENT_HISTORY_KEY))||{}; return Array.isArray(all[clientId])?all[clientId]:[] }catch{ return [] } }
function saveClientHistory(clientId, list){ const all=(()=>{ try{ return JSON.parse(localStorage.getItem(CLIENT_HISTORY_KEY))||{} }catch{ return {} } })(); all[clientId]=list; localStorage.setItem(CLIENT_HISTORY_KEY, JSON.stringify(all)) }
function addToClientHistory(clientId, order){ const list=loadClientHistory(clientId); list.unshift(order); saveClientHistory(clientId, list.slice(0,20)) }

/* confirm modal */
const orderConfirm={ _ok:null,_cancel:null,
  open(data){
    const wrap=document.getElementById('orderConfirmModal');
    const list=document.getElementById('orderConfirmList');
    const totalEl=document.getElementById('orderConfirmTotal');
    const clientEl=document.getElementById('orderConfirmClient');
    list.innerHTML='';
    data.items.forEach(it=>{
      const row=document.createElement('div');
      row.className='flex justify-between gap-2';
      row.innerHTML=`<span>${it.name} √ó${it.qty}</span><span>${it.price*it.qty} —Ä—É–±.</span>`;
      list.appendChild(row);
    });
    totalEl.textContent='–ò—Ç–æ–≥–æ: '+data.total+' —Ä—É–±.';
    const p = data.client||{};
    clientEl.textContent = (p.name? p.name+' ¬∑ ':'')+(p.phone? p.phone+' ¬∑ ':'')+(p.address||'')+(p.paymentMethod? ' ¬∑ '+nicePay(p.paymentMethod):'');
    this._ok=data.onOk||null; this._cancel=data.onCancel||null;
    wrap.classList.remove('hidden'); wrap.classList.add('flex');
  },
  close(){ const wrap=document.getElementById('orderConfirmModal'); wrap.classList.add('hidden'); wrap.classList.remove('flex') }
};
(function(){
  const wrap=document.getElementById('orderConfirmModal');
  document.getElementById('orderConfirmOk').onclick=()=>{ const cb=orderConfirm._ok; orderConfirm.close(); if(cb) cb() };
  document.getElementById('orderConfirmCancel').onclick=()=>{ const cb=orderConfirm._cancel; orderConfirm.close(); if(cb) cb() };
  wrap.addEventListener('click',(e)=>{ if(e.target===wrap) orderConfirm.close() });
})();

/* payment modal */
function nicePay(k){ return k==='cash'?'–ù–∞–ª–∏—á–Ω—ã–µ':k==='card'?'–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞':k==='transfer'?'–ü–µ—Ä–µ–≤–æ–¥':'' }
function openPaymentModal(updateLabel){
  const wrap=document.getElementById('paymentModal');
  const close=document.getElementById('paymentClose');
  wrap.classList.remove('hidden'); wrap.classList.add('flex');
  function setPay(k){ const cur=loadProfile(); cur.paymentMethod=k; saveProfile(cur); if(updateLabel) updateLabel(nicePay(k)); wrap.classList.add('hidden'); wrap.classList.remove('flex') }
  wrap.querySelector('[data-pay="cash"]').onclick=()=>setPay('cash');
  wrap.querySelector('[data-pay="card"]').onclick=()=>setPay('card');
  wrap.querySelector('[data-pay="transfer"]').onclick=()=>setPay('transfer');
  close.onclick=()=>{ wrap.classList.add('hidden'); wrap.classList.remove('flex') };
  wrap.onclick=(e)=>{ if(e.target===wrap) close.onclick() };
}

/* ===== Views ===== */
function HomeView(){
  const root=el(`
    <div class="grid gap-6 pb-24">
      <section class="glass-panel rounded-2xl p-6 mt-2 flex flex-col items-center text-center">
        <div class="text-3xl">üçî</div>
        <h2 class="text-xl font-semibold mt-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p class="text-sm text-gray-600 mt-1">–û–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑ –≤ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤</p>
        <button class="mt-4 px-4 py-3 rounded-xl bg-black text-white" id="goMenu">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–µ–Ω—é</button>
      </section>

      <section class="rounded-2xl p-6 bg-white border">
        <h3 class="font-semibold mb-2">–û –Ω–∞—Å</h3>
        <p class="text-sm text-gray-600">–õ–æ–≥–æ—Ç–∏–ø –∏ –∫–æ–ª–ª–∞–∂ –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ. –í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞, –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –º—ã —Å–¥–µ–ª–∞–µ–º —Å–∞–º–∏.</p>
      </section>

      <footer class="rounded-2xl p-6 bg-white border">
        <h3 class="font-semibold mb-3">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <div class="grid gap-2">
          <a href="tel:+798989932108" class="px-3 py-2 rounded-xl border hover:bg-gray-50 w-full text-left">–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞: +7 989 899 32 108</a>
          <button id="legalBtn" class="px-3 py-2 rounded-xl border hover:bg-gray-50 text-left">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
          <button id="devBtn" class="px-3 py-2 rounded-xl border hover:bg-gray-50 text-left">–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º</button>
          <div class="text-xs text-gray-500 mt-2">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: 2025</div>

          <div class="border-t my-3"></div>
          <div class="text-xs text-gray-500">–ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏:</div>
          <div class="flex flex-wrap gap-2">
            <a href="#/order" class="px-3 py-2 rounded-xl border text-sm">–ö–ª–∏–µ–Ω—Ç</a>
            <button id="tabloOpen" class="px-3 py-2 rounded-xl border text-sm">–¢–∞–±–ª–æ</button>
          </div>
        </div>
      </footer>

      <div class="checkout-bar" style="position:static; transform:none; width:100%; border-style:dashed; opacity:.85">
        <div class="text-sm text-gray-500">–ù–∏–∂–Ω—è—è –ø–ª–∞—à–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ ¬´–ú–µ–Ω—é¬ª</div>
      </div>
    </div>
  `);

  root.querySelector('#goMenu').onclick=()=>{ location.hash='#/order' };
  root.querySelector('#legalBtn').onclick=()=> alert('–ó–¥–µ—Å—å –±—É–¥–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
  root.querySelector('#devBtn').onclick=()=> alert('–ü–æ—á—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞: sabirbis@bk.ru');
  root.querySelector('#tabloOpen').onclick=()=> showPin();

  return root;
}

/* –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç */
function ProfileView(){
  const prof=Object.assign({ name:'', phone:'', address:'', deliverByTime:false, deliverTime:'', paymentMethod:'' }, loadProfile());
  const root=el(`
    <div class="grid gap-6 pb-24">
      <section class="glass-panel rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-3">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
        <div class="grid gap-3">
          <input id="pName" class="border rounded-xl p-3" placeholder="–ò–º—è" value="${prof.name||''}">
          <input id="pPhone" class="border rounded-xl p-3" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7‚Ä¶)" value="${prof.phone||''}">
          <input id="pAddr" class="border rounded-xl p-3" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" value="${prof.address||''}">
          <label class="flex items-center gap-3">
            <input id="pByTime" type="checkbox" ${prof.deliverByTime?'checked':''}>
            <span>–î–æ—Å—Ç–∞–≤–ª—è—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–∏</span>
          </label>
          <input id="pTime" class="border rounded-xl p-3 ${prof.deliverByTime?'':'hidden'}" type="time" value="${prof.deliverTime||''}">
          <div class="flex items-center justify-between gap-3">
            <div class="text-sm text-gray-600">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: <b id="pPayVal">${prof.paymentMethod? nicePay(prof.paymentMethod):'–Ω–µ –≤—ã–±—Ä–∞–Ω'}</b></div>
            <button id="pPayBtn" class="px-3 py-2 rounded-xl border">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
          <button id="pSave" class="px-4 py-3 rounded-xl border bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </section>

      <section class="glass-panel rounded-2xl p-5">
        <h3 class="text-lg font-semibold mb-3">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
        <div id="pHistory" class="grid gap-2"></div>
      </section>
    </div>
  `);

  const pName=root.querySelector('#pName'), pPhone=root.querySelector('#pPhone'), pAddr=root.querySelector('#pAddr');
  const pByTime=root.querySelector('#pByTime'), pTime=root.querySelector('#pTime'), pPayVal=root.querySelector('#pPayVal');

  pByTime.addEventListener('change', ()=>{ pTime.classList.toggle('hidden', !pByTime.checked); if(!pByTime.checked) pTime.value='' });
  root.querySelector('#pPayBtn').onclick=()=> openPaymentModal((txt)=> pPayVal.textContent=txt||'–Ω–µ –≤—ã–±—Ä–∞–Ω');
  root.querySelector('#pSave').onclick=()=>{
    saveProfile({ name:pName.value.trim(), phone:pPhone.value.trim(), address:pAddr.value.trim(),
      deliverByTime:pByTime.checked, deliverTime:pTime.value||'', paymentMethod:(loadProfile().paymentMethod||'') });
    showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  };

  // –∏—Å—Ç–æ—Ä–∏—è
  const clientId=getClientId(); const box=root.querySelector('#pHistory');
  const hist=loadClientHistory(clientId);
  if(!hist.length) box.innerHTML='<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
  hist.forEach(o=>{
    const tot=typeof o.total==='number'?o.total:calcTotalFromItems(o);
    const card=el(`
      <div class="p-3 rounded-xl border flex items-start justify-between gap-3 bg-white">
        <div>
          <div class="text-sm font-semibold">#${o.id||'‚Äî'} ${o.status? '¬∑ '+o.status:''}</div>
          <div class="text-xs text-gray-500">${o.createdAt? new Date(o.createdAt).toLocaleString():''}</div>
          <div class="text-sm mt-1">${tot? tot+' —Ä—É–±.':''}</div>
        </div>
        <button type="button" class="text-xs text-red-500" data-del>–£–¥–∞–ª–∏—Ç—å</button>
      </div>`);
    card.querySelector('[data-del]').onclick=()=>{ const cur=loadClientHistory(clientId).filter(x=>x.localUid!==o.localUid); saveClientHistory(clientId,cur); card.remove() };
    box.appendChild(card);
  });

  return root;
}

/* ===== –≠–∫—Ä–∞–Ω –ú–µ–Ω—é: –í–ù–£–¢–†–ï–ù–ù–ò–ô –°–ö–†–û–õ–õ + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π + —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∏–∑ ===== */
function OrderView(){
  const root=el(`
    <div class="relative" id="orderRoot">
      <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
      <section class="sticky-top mb-3">
        <div class="glass-panel rounded-2xl px-3 py-3">
          <h2 class="text-base font-semibold mb-2">ü•ò –ú–µ–Ω—é</h2>
          <div id="categoryBar" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
        </div>
      </section>

      <!-- –í–ù–£–¢–†–ï–ù–ù–ò–ô —Å–∫—Ä–æ–ª–ª —Å–ø–∏—Å–∫–∞ -->
      <section>
        <div id="menuScroll" class="no-scrollbar">
          <div id="menuSections" class="grid gap-3"></div>
        </div>
      </section>

      <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∏–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
      <div class="checkout-bar" id="checkoutBar">
        <div class="text-base"><span class="text-gray-600">–ò—Ç–æ–≥–æ:</span> <b id="totalVal">0 —Ä—É–±.</b></div>
        <button id="checkoutBtn" class="checkout-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>
  `);

  const categoryBar=root.querySelector('#categoryBar');
  const menuScroll=root.querySelector('#menuScroll');
  const sections=root.querySelector('#menuSections');
  const totalVal=root.querySelector('#totalVal');
  const checkoutBtn=root.querySelector('#checkoutBtn');

  const clientId=getClientId();
  const counts={};
  let unavailable=new Set(loadUnavailableFromLS());
  let activeKey = MENU_CATEGORIES[0].key;

  // –≤—ã—Å–æ—Ç–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–∫—Ä–æ–ª–ª–∞: –∑–∞–ø–æ–ª–Ω–∏–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ –º–µ–∂–¥—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –ø–ª–∞—à–∫–æ–π
  function fitHeights(){
    const rectRoot = root.getBoundingClientRect();
    const headerH = root.querySelector('.sticky-top').getBoundingClientRect().height;
    const barH = root.querySelector('#checkoutBar').getBoundingClientRect().height + 12; // + –æ—Ç—Å—Ç—É–ø
    const available = window.innerHeight - (rectRoot.top + headerH + barH + 12);
    menuScroll.style.maxHeight = Math.max(220, available) + 'px';
    menuScroll.style.height = menuScroll.style.maxHeight;
  }
  window.addEventListener('resize', fitHeights);
  setTimeout(fitHeights, 0);

  // sync unavailable
  async function syncUnavailable(){
    const srv=await fetchUnavailableFromServer();
    if(Array.isArray(srv)){
      const srvSet=new Set(srv);
      if(srv.length!==unavailable.size || srv.some(n=>!unavailable.has(n))){
        unavailable=srvSet; saveUnavailableToLS(srv); renderSections();
      }
    }
  }
  syncUnavailable(); setInterval(syncUnavailable, 10000);

  // —á–∏–ø—Å—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  MENU_CATEGORIES.forEach((cat,idx)=>{
    const btn=el(`<button type="button" class="px-3 py-1.5 rounded-full border text-sm whitespace-nowrap ${idx===0?'bg-black text-white border-black':'bg-white/50'}" data-cat="${cat.key}">${cat.title}</button>`);
    categoryBar.appendChild(btn);
  });

  // —Ä–µ–Ω–¥–µ—Ä —Å–µ–∫—Ü–∏–π ‚Äî –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–¥—Ä—è–¥
  function renderSections(){
    sections.innerHTML='';
    MENU_CATEGORIES.forEach(cat=>{
      const sec = el(`<div id="sec-${cat.key}"></div>`);
      // –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º? –æ—Å—Ç–∞–≤–∏–º –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º
      sec.appendChild(el(`<div class="cat-section-title">${cat.title}</div>`));

      cat.items.forEach(item=>{
        const q=counts[item.name]||0; const isOff=unavailable.has(item.name);
        const card=el(`
          <div class="menu-card ${isOff?'disabled':''}">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <div class="text-sm sm:text-base font-medium">${item.name}</div>
                ${isOff?'<span class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full">–Ω–µ—Ç</span>':''}
              </div>
              <div class="inline-flex items-center mt-2 px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${money(item.price)}</div>
              <div class="flex items-center gap-3 mt-3">
                <button type="button" class="w-9 h-9 rounded-xl border" data-act="dec" ${isOff?'disabled':''}>‚àí</button>
                <div class="w-6 text-center" data-q>${q}</div>
                <button type="button" class="w-9 h-9 rounded-xl border bg-black text-white" data-act="inc" ${isOff?'disabled':''}>+</button>
              </div>
            </div>
            <img src="${item.img||'https://placehold.co/110x70?text=food'}" class="menu-card-img" alt="">
          </div>
        `);
        const qEl=card.querySelector('[data-q]');
        card.addEventListener('click',(e)=>{
          if(isOff){ showToast('–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
          if(e.target.dataset.act==='inc'){ counts[item.name]=(counts[item.name]||0)+1; qEl.textContent=counts[item.name]; recalcTotal(); }
          if(e.target.dataset.act==='dec'){ counts[item.name]=Math.max(0,(counts[item.name]||0)-1); qEl.textContent=counts[item.name]; recalcTotal(); }
        });
        sec.appendChild(card);
      });

      sections.appendChild(sec);
    });
    // –ø–µ—Ä–µ—Å—á—ë—Ç –≤—ã—Å–æ—Ç—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
    setTimeout(fitHeights, 0);
    // –æ–±–Ω–æ–≤–∏–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
    highlightActiveChip(activeKey);
    buildObservers();
  }

  function recalcTotal(){
    let sum=0;
    MENU_CATEGORIES.forEach(cat=>cat.items.forEach(item=>{
      const q=counts[item.name]||0; sum += item.price*q;
    }));
    totalVal.textContent = money(sum);
    return sum;
  }

  // –∫–ª–∏–∫ –ø–æ —á–∏–ø—Å–∞–º ‚Üí —Å–∫—Ä–æ–ª–ª–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ —Å–µ–∫—Ü–∏–∏
  categoryBar.addEventListener('click',(e)=>{
    const btn=e.target.closest('button[data-cat]'); if(!btn) return;
    const key=btn.dataset.cat;
    const sec = sections.querySelector('#sec-'+key);
    if(sec){
      menuScroll.scrollTo({ top: sec.offsetTop, behavior: 'smooth' });
      activeKey = key;
      highlightActiveChip(key);
    }
  });

  function highlightActiveChip(key){
    categoryBar.querySelectorAll('button').forEach(b=>{
      const on = b.dataset.cat === key;
      b.classList.toggle('bg-black', on);
      b.classList.toggle('text-white', on);
      b.classList.toggle('border-black', on);
    });
  }

  // === —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ (IntersectionObserver —Å root=menuScroll)
  let io=null;
  function buildObservers(){
    if(io){ io.disconnect(); }
    io = new IntersectionObserver((entries)=>{
      // –±–µ—Ä—ë–º —Å–∞–º—É—é –≤–∏–¥–∏–º—É—é —Å–µ–∫—Ü–∏—é
      let best=null, bestRatio=0;
      entries.forEach(ent=>{
        if(ent.isIntersecting && ent.intersectionRatio>bestRatio){
          best=ent; bestRatio=ent.intersectionRatio;
        }
      });
      if(best){
        const id = best.target.id; // "sec-KEY"
        const key = id.replace(/^sec-/,'');
        if(key && key!==activeKey){
          activeKey=key;
          highlightActiveChip(key);
        }
      }
    }, { root: menuScroll, threshold:[0.15,0.3,0.6] });

    sections.querySelectorAll('[id^="sec-"]').forEach(sec=> io.observe(sec));
  }

  // –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚Äî –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
  checkoutBtn.addEventListener('click', async ()=>{
    // —Å–æ–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏
    const items=[];
    MENU_CATEGORIES.forEach(cat=>cat.items.forEach(item=>{
      const qty=counts[item.name]||0; if(qty>0) items.push({ name:item.name, qty, price:item.price });
    }));
    if(!items.length){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã'); return; }
    const total = recalcTotal();

    const prof = loadProfile();
    if(!prof.name || !prof.phone || !prof.address){ showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –∞–¥—Ä–µ—Å)'); location.hash='#/profile'; return; }
    if(!prof.paymentMethod){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ'); location.hash='#/profile'; return; }

    const payload={ clientId:getClientId(), name:prof.name, phone:prof.phone, address:prof.address,
      deliverByTime:!!prof.deliverByTime, deliverTime:prof.deliverTime||null, paymentMethod:prof.paymentMethod, items, total };

    orderConfirm.open({
      items, total, client:prof,
      onOk: async ()=>{
        checkoutBtn.disabled=true;

        const res=await ycCall("create",{ data:payload });
        if(res.error){
          const data=store.load(); const id='L'+(data.nextLocalId++); const now=Date.now();
          const order={ id, ...payload, status:'–Ω–æ–≤—ã–π', createdAt:now, updatedAt:now, _source:'local', localUid:'local-'+id };
          data.orders.unshift(order); store.save(data); addToClientHistory(clientId, order); renderHistoryGlobal();
          showToast('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)'); resetCounts(); checkoutBtn.disabled=false; return;
        }
        const o=res.order||{ id:'‚Äî', status:'–Ω–æ–≤—ã–π', items, total };
        const shownTotal=Math.max(typeof o.total==='number'?o.total:0, total, calcTotalFromItems(o));
        const now=Date.now(); addToClientHistory(clientId,{ ...o, createdAt:o.createdAt||now, localUid:'srv-'+o.id }); renderHistoryGlobal();
        showToast(res.dedup?'–ó–∞–∫–∞–∑ —É–∂–µ –±—ã–ª, –ø–æ–∫–∞–∑–∞–ª–∏ –µ–≥–æ':'–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        resetCounts(); checkoutBtn.disabled=false;
      }
    });
  });

  function resetCounts(){ for(const k in counts) delete counts[k]; renderSections(); totalVal.textContent='0 —Ä—É–±.' }

  // –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
  renderSections();
  return root;
}

/* ===== Dashboard (—Ç–∞–±–ª–æ) ‚Äî –∫–∞–∫ –±—ã–ª–æ ===== */
function DashboardView(){
  const root=el(`
    <div class="grid gap-4 max-w-6xl">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h2>
        <div class="flex gap-2">
          <button type="button" class="px-3 py-2 rounded-xl border" id="enableSound">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
        </div>
      </div>

      <div class="p-4 rounded-2xl bg-white border">
        <h3 class="font-semibold mb-3">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <p class="text-sm text-gray-500 mb-3">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–∫–æ–π, —á–µ–≥–æ –ù–ï–¢ ‚Äî –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ —Ç–æ–≤–∞—Ä —Å—Ç–∞–Ω–µ—Ç —Å–µ—Ä—ã–º –∏ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å.</p>
        <div id="stockList" class="grid gap-2 md:grid-cols-3"></div>
        <div class="mt-3"><button id="saveStock" class="px-3 py-2 rounded-xl border bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </div>

      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="list"></div>
    </div>
  `);

  const list=root.querySelector('#list'); let audioCtx=null; let soundEnabled=false; const seenIds=new Set(); let lastOrdersMap=new Map();
  const stockList=root.querySelector('#stockList'); let unavailable=new Set(loadUnavailableFromLS());

  function renderStock(){ stockList.innerHTML=''; MENU_CATEGORIES.forEach(cat=>cat.items.forEach(item=>{
    const row=el(`<label class="flex items-center gap-2 text-sm"><input type="checkbox" value="${item.name}" ${unavailable.has(item.name)?'checked':''} /><span>${item.name}</span></label>`);
    stockList.appendChild(row);
  })) }
  renderStock();

  (async()=>{ const srv=await fetchUnavailableFromServer(); if(Array.isArray(srv)){ unavailable=new Set(srv); renderStock(); saveUnavailableToLS(srv); } })();

  root.querySelector('#saveStock').onclick=async()=>{
    const checked=[...stockList.querySelectorAll('input[type=checkbox]:checked')].map(i=>i.value);
    saveUnavailableToLS(checked); const ok=await saveUnavailableToServer(checked);
    showToast(ok?'–ù–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ':'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ'); unavailable=new Set(checked);
  };

  function playBeep(d=0.35,f=880){ if(!audioCtx||!soundEnabled) return; const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.type='square'; osc.frequency.value=f; g.gain.setValueAtTime(0.35,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);
    osc.connect(g).connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+d) }

  root.querySelector('#enableSound').onclick=async()=>{ try{ if(!audioCtx){ const AC=window.AudioContext||window.webkitAudioContext; audioCtx=new AC() }
    if(audioCtx.state==='suspended') await audioCtx.resume(); soundEnabled=true; playBeep(); setTimeout(()=>playBeep(),200); showToast('–ó–≤—É–∫ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤–∫–ª—é—á—ë–Ω') }catch{ showToast('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–∞–ª –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫') } };

  function orderCard(o){
    const clientTotal=calcTotalFromItems(o); const total=Math.max(typeof o.total==='number'?o.total:0, clientTotal);
    const created=o.createdAt? new Date(o.createdAt): new Date(); const itemLines=(o.items||[]).map(i=>`${i.name} √ó${i.qty}`).join(', ');
    const card=el(`
      <div class="p-5 rounded-2xl bg-white border flex flex-col gap-2" data-id="${o.id}">
        <div class="flex items-center justify-between gap-4">
          <div class="text-lg font-semibold">#${o.id} ‚Äî ${o.name}</div>
          <div class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">${o.status}</div>
        </div>
        <div class="text-sm text-gray-600">${created.toLocaleString()} ¬∑ –ò—Ç–æ–≥: <b>${total} —Ä—É–±.</b>${o._source==='local' ? ' ¬∑ <span class="text-red-500">–ª–æ–∫–∞–ª—å–Ω–æ</span>' : ''}</div>
        <div>üìç ${o.address}</div><div>‚òéÔ∏è ${o.phone}</div><div>üßæ ${itemLines||'‚Äî'}</div>
        <div>‚è∞ ${o.deliverByTime&&o.deliverTime?('–∫ '+o.deliverTime):'–∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ'}</div>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <label class="text-sm">–°—Ç–∞—Ç—É—Å:</label>
          <select class="border rounded-xl p-2" data-k="status">
            ${['–Ω–æ–≤—ã–π','–≥–æ—Ç–æ–≤–∏—Ç—Å—è','–≤ –ø—É—Ç–∏','–≥–æ—Ç–æ–≤','–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('')}
          </select>
          <button type="button" class="px-3 py-2 rounded-xl border" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm">–û–∂–∏–¥–∞–Ω–∏–µ (–º–∏–Ω):</label>
          <input type="number" min="0" class="border rounded-xl p-2 w-24" data-k="eta" value="${o.etaMinutes??''}" />
          <button type="button" class="px-3 py-2 rounded-xl border" data-act="set-eta">OK</button>
        </div>
        <div class="mt-2 text-right"><button type="button" class="px-3 py-2 rounded-xl border bg-red-50 hover:bg-red-100" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button></div>
      </div>`);
    card.addEventListener('click', async (e)=>{
      const act=e.target.dataset.act; if(!act) return;
      if(act==='save'){ const status=card.querySelector('[data-k="status"]').value; await ycCall("update",{id:o.id, patch:{status}}); showToast(`–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`) }
      if(act==='set-eta'){ const etaMinutes=Number(card.querySelector('[data-k="eta"]').value||0); await ycCall("update",{id:o.id, patch:{etaMinutes}}); showToast(`ETA –∑–∞–∫–∞–∑–∞ #${o.id} –æ–±–Ω–æ–≤–ª—ë–Ω`) }
      if(act==='delete'){ if(!card.dataset.confirm){ card.dataset.confirm='1'; e.target.textContent='–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?'; setTimeout(()=>{ if(card && card.dataset.confirm==='1'){ delete card.dataset.confirm; e.target.textContent='–£–¥–∞–ª–∏—Ç—å' }},3000); return }
        await ycCall("delete",{id:o.id}); card.remove(); showToast(`–ó–∞–∫–∞–∑ #${o.id} —É–¥–∞–ª—ë–Ω`) }
    });
    return card;
  }

  async function load(){
    const res=await ycCall("list"); const unique=new Map();
    if(!res.error && Array.isArray(res.orders) && res.orders.length>0){ res.orders.forEach(o=>unique.set(String(o.id),o)); lastOrdersMap=new Map(unique) }
    else if(lastOrdersMap.size>0){ lastOrdersMap.forEach((v,k)=>unique.set(k,v)) }
    else { const data=store.load(); data.orders.forEach(o=>unique.set(String(o.id),o)) }
    list.innerHTML=''; if(unique.size===0){ list.innerHTML=`<div class="p-5 rounded-2xl bg-white border text-gray-500 col-span-full">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>`; return }
    const currentIds=new Set(); [...unique.values()].forEach(o=>{ const idStr=String(o.id); currentIds.add(idStr); if(!seenIds.has(idStr)){ showToast("–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #"+o.id); if(soundEnabled){ playBeep(); setTimeout(()=>playBeep(),250) } } list.appendChild(orderCard(o)) });
    seenIds.clear(); currentIds.forEach(id=>seenIds.add(id));
  }
  load(); setInterval(()=>{ if(location.hash==='#/dashboard') load() }, 5000);
  return root;
}

/* ===== Router ===== */
function router(){
  const app=document.getElementById('app'); app.innerHTML='';
  const hash=location.hash;
  if(hash==='#/dashboard'){ app.classList.remove('phone-shell'); app.appendChild(DashboardView()) }
  else if(hash==='#/profile'){ app.classList.add('phone-shell'); app.appendChild(ProfileView()) }
  else if(hash==='#/order'){ app.classList.add('phone-shell'); app.appendChild(OrderView()) }
  else { app.classList.add('phone-shell'); app.appendChild(HomeView()) }
}
window.addEventListener('hashchange', router); router();

/* ===== Drawer ===== */
const drawer=document.getElementById('drawer');
document.getElementById('burgerBtn').onclick=()=> drawer.style.display='block';
document.getElementById('drawerClose').onclick=()=> drawer.style.display='none';
drawer.onclick=(e)=>{ if(e.target===drawer) drawer.style.display='none' };
document.getElementById('drawerPay').onclick=()=>{ drawer.style.display='none'; openPaymentModal() };
document.getElementById('drawerLegal').onclick=()=>{ drawer.style.display='none'; alert('–ó–¥–µ—Å—å –±—É–¥–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') };

/* ===== History sheet ===== */
const historySheet=document.getElementById('historySheet');
document.getElementById('historyHandle').onclick=()=>{ renderHistoryGlobal(); historySheet.classList.add('open') };
document.getElementById('historyClose').onclick=()=> historySheet.classList.remove('open');
historySheet.onclick=(e)=>{ if(e.target===historySheet) historySheet.classList.remove('open') };

function renderHistoryGlobal(){
  const clientId=getClientId(); const box=document.getElementById('historyList'); const list=loadClientHistory(clientId);
  box.innerHTML=''; if(!list.length){ box.innerHTML='<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>'; return }
  list.forEach(o=>{
    const tot=typeof o.total==='number'?o.total:calcTotalFromItems(o);
    const card=el(`<div class="p-3 rounded-xl border flex items-start justify-between gap-3 bg-white"><div>
      <div class="text-sm font-semibold">#${o.id||'‚Äî'} ${o.status? '¬∑ '+o.status:''}</div>
      <div class="text-xs text-gray-500">${o.createdAt? new Date(o.createdAt).toLocaleString():''}</div>
      <div class="text-sm mt-1">${tot? tot+' —Ä—É–±.':''}</div>
    </div><button type="button" class="text-xs text-red-500" data-del>–£–¥–∞–ª–∏—Ç—å</button></div>`);
    card.querySelector('[data-del]').onclick=()=>{ const cur=loadClientHistory(clientId).filter(x=>x.localUid!==o.localUid); saveClientHistory(clientId,cur); renderHistoryGlobal() };
    box.appendChild(card);
  });
}

/* ===== Pin / Tablo ===== */
const pinModal=document.getElementById('pinModal'), pinInput=document.getElementById('pinInput'),
      pinOk=document.getElementById('pinOk'), pinCancel=document.getElementById('pinCancel'), pinError=document.getElementById('pinError');
function showPin(){ pinError.classList.add('hidden'); pinInput.value=''; pinModal.classList.remove('hidden'); pinModal.classList.add('flex'); setTimeout(()=>pinInput.focus(),0) }
function hidePin(){ pinModal.classList.add('hidden'); pinModal.classList.remove('flex') }
function tryEnter(){ if(pinInput.value===ALLOWED_PIN){ hidePin(); location.hash='#/dashboard' } else { pinError.classList.remove('hidden'); pinInput.focus() } }
pinOk.onclick=tryEnter; pinCancel.onclick=hidePin; pinInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') tryEnter(); if(e.key==='Escape') hidePin() });
pinModal.addEventListener('click',(e)=>{ if(e.target===pinModal) hidePin() });
</script>
</body>
</html>
