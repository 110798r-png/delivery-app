<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no" />
  <title>–Ø–º–∞–ú–æ—Ç–æ ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    html, body { width:100%; max-width:100%; overflow-x:hidden; background:#f9fafb; }
    *, *::before, *::after { box-sizing:border-box; }
    img { max-width:100%; display:block; }
    .hidden{ display:none }
    .phone-shell{ width:min(100vw,540px); margin:0 auto; padding:0 .35rem; }

    .toast{ position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; padding:.75rem 1rem; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.2); opacity:.95; z-index:9999 }

    .glass-panel{ background:radial-gradient(circle at 10% 20%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.45) 45%, rgba(255,255,255,.25) 100%); backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.4); box-shadow:0 14px 40px rgba(15,23,42,.12) }
    .no-scrollbar::-webkit-scrollbar{ display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }
    .sticky-top{ position:sticky; top:.5rem; z-index:30 }

    .menu-card{ display:flex; gap:.75rem; align-items:center; background:#fff; border:1px solid #edf2f7; border-radius:1.25rem; padding:1rem; min-height:6.4rem }
    .menu-card-img{ width:110px; height:70px; border-radius:.75rem; background:#eee; object-fit:cover }

    .confirm-bar{ position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:min(540px, 100%); background:#fff; border-top:1px solid #e5e7eb; padding:.6rem .9rem; z-index:50; box-shadow:0 -10px 25px rgba(15,23,42,.06) }

    #catPager{ display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; touch-action: pan-x pinch-zoom; }
    .cat-panel{ flex:0 0 100%; scroll-snap-align:start; scroll-snap-stop: always; padding:0; }
    .v-scroll{ overflow-y:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action: pan-y; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:90 }
    .modal.open{ display:flex }

    .app-header{ position:sticky; top:0; z-index:100; }
    button[data-act], #profileBtn, #payOk, #payCancel, #backBtn { touch-action: manipulation; }
    .badge{ display:inline-flex; align-items:center; gap:.35rem; border-radius:.6rem; padding:.15rem .5rem; font-size:.75rem; background:#f1f5f9; color:#334155 }
    .badge.red{ background:#fee2e2; color:#991b1b }

    .card{ border-radius:1.25rem; background:#fff; border:1px solid #edf2f7; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .card-tall{ min-height: 164px; }
    .rowlink{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:16px 18px; font-weight:600 }

    #tabloTapZone{ height:64px; display:flex; justify-content:flex-end; align-items:center; }
    #tabloTapHot{ width:140px; height:52px; border-radius:12px; }

    .chip{ display:inline-block; padding:.2rem .6rem; border-radius:999px; font-size:.75rem; }
  </style>
</head>
<body>
  <div class="w-full py-3">
    <header id="appHeader" class="phone-shell flex items-center justify-between mb-3 sm:mb-4 app-header">
      <div class="leading-tight">
        <div class="text-2xl font-extrabold tracking-tight">–Ø–º–∞–ú–æ—Ç–æ</div>
      </div>
      <a id="profileBtn" href="#/profile" class="px-3 py-2 rounded-xl border bg-white" aria-label="profile" role="button" title="–ü—Ä–æ—Ñ–∏–ª—å">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z" fill="currentColor"/></svg>
      </a>
      <button id="backBtn" class="hidden px-3 py-2 rounded-xl border bg-white select-none" aria-label="–ù–∞–∑–∞–¥" title="–ù–∞–∑–∞–¥">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </header>
    <main id="app" class="phone-shell"></main>
  </div>

  <!-- –û–ø–ª–∞—Ç–∞ -->
  <div id="payModal" class="modal">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm space-y-3 shadow-xl" role="dialog" aria-modal="true">
      <h3 class="text-lg font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
      <div id="paySummary" class="text-sm bg-gray-50 border rounded-xl p-3 max-h-48 overflow-auto"></div>
      <div class="grid gap-1">
        <label class="text-sm text-gray-600" for="paySelect">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
        <select id="paySelect" class="border rounded-xl p-3 w-full">
          <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
          <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
          <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
        </select>
      </div>
      <div class="flex justify-end gap-2">
        <button id="payCancel" type="button" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
        <button id="payOk" type="button" class="px-3 py-2 rounded-xl bg-black text-white">–û–ö</button>
      </div>
    </div>
  </div>

  <!-- –ö–ª—é—á –¥–ª—è —Ç–∞–±–ª–æ -->
  <div id="pinModal" class="modal">
    <div class="bg-white rounded-2xl p-5 w-full max-w-xs space-y-3 shadow-xl text-center">
      <h3 class="text-lg font-semibold">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á</h3>
      <input id="pinInput" class="border rounded-xl p-3 w-full text-center" placeholder="–≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á" inputmode="text">
      <div class="flex justify-end gap-2">
        <button id="pinCancel" class="px-3 py-2 rounded-xl border">–û—Ç–º–µ–Ω–∞</button>
        <button id="pinOk" class="px-3 py-2 rounded-xl bg-black text-white">–û–ö</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  if (!location.hash || location.hash==='#' || location.hash==='#/') location.hash='#/order';
});

const PROFILE_LS_KEY     = 'client_profile_v1';
const CLIENT_HISTORY_KEY = 'orders_client_history_v1';
const UNAVAILABLE_LS_KEY = 'orders_unavailable_v1';
const DASHBOARD_LS_KEY   = 'dashboard_orders_v1';
const TABLO_PIN_OK       = 'TABLO_PIN_OK';

function el(html){ var t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function showToast(msg){ var t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(function(){ t.classList.add('hidden'); }, 1800); }
var TOST_SELECT = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä';
function money(x){ return x+' —Ä—É–±.'; }
function setBodyScrollLock(on){ document.body.style.overflow = on ? 'hidden' : ''; }

function safeParse(k, f){
  try{
    var v=JSON.parse(localStorage.getItem(k)||'null');
    if(v==null) return f;
    if(Array.isArray(f)) return Array.isArray(v)?v:[];
    if(typeof f==='object') return v&&typeof v==='object'?v:{};
    return v;
  }catch(e){ return f }
}
function loadProfile(){ return safeParse(PROFILE_LS_KEY, {}); }
function saveProfile(p){ localStorage.setItem(PROFILE_LS_KEY, JSON.stringify(p||{})); }
function loadHistory(){ return safeParse(CLIENT_HISTORY_KEY, []); }
function saveHistory(list){ localStorage.setItem(CLIENT_HISTORY_KEY, JSON.stringify(Array.isArray(list)?list:[])); }
function loadUnavailable(){ return safeParse(UNAVAILABLE_LS_KEY, []); }
function saveUnavailable(items){ localStorage.setItem(UNAVAILABLE_LS_KEY, JSON.stringify(Array.isArray(items)?items:[])); }
function loadDash(){ return safeParse(DASHBOARD_LS_KEY, []); }
function saveDash(list){ localStorage.setItem(DASHBOARD_LS_KEY, JSON.stringify(Array.isArray(list)?list:[])); }

function syncOrderStatus(id, status){
  var hist = loadHistory(); var changed = false;
  for (var i=0;i<hist.length;i++){
    if (String(hist[i].id) === String(id)){
      if (hist[i].status !== status){ hist[i] = Object.assign({}, hist[i], { status: status }); changed = true; }
      break;
    }
  }
  if (changed) saveHistory(hist);
}

var MENU_CATEGORIES = [
  { key:'burgers', title:'–ë—É—Ä–≥–µ—Ä—ã', items:[
    { name:'–ì–æ–≤—è–∂–∏–π –±—É—Ä–≥–µ—Ä', price:280, img:'https://images.unsplash.com/photo-1603064752734-4c48eff53d05?w=400&auto=format&fit=crop' },
    { name:'–ì–æ–≤—è–∂–∏–π –¥–≤–æ–π–Ω–æ–π', price:340, img:'https://images.unsplash.com/photo-1516684541-b4de0a07a2e1?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –±—É—Ä–≥–µ—Ä',  price:200, img:'https://images.unsplash.com/photo-1604908176997-1251882fde0b?w=400&auto=format&fit=crop' },
    { name:'–ö—É—Ä–∏–Ω—ã–π –¥–≤–æ–π–Ω–æ–π', price:250, img:'https://images.unsplash.com/photo-1603366615917-1fa6dad5c4fa?w=400&auto=format&fit=crop' },
    { name:'–ß–∏–∑–±—É—Ä–≥–µ—Ä', price:220 }
  ]},
  { key:'twisters', title:'–¢–≤–∏—Å—Ç–µ—Ä—ã', items:[ { name:'–¢–≤–∏—Å—Ç–µ—Ä –æ–±—ã—á–Ω—ã–π', price:200 }, { name:'–¢–≤–∏—Å—Ç–µ—Ä –º–∞–∫—Å', price:250 } ]},
  { key:'drinks',  title:'–ù–∞–ø–∏—Ç–∫–∏', items:[ { name:'–î–æ–±—Ä—ã–π –∫–æ–ª–∞', price:100 }, { name:'–î–æ–±—Ä—ã–π –∞–ø–µ–ª—å—Å–∏–Ω', price:100 }, { name:'–°–ø—Ä–∞–π—Ç', price:100 }, { name:'–≠—Å–ø—Ä–µ—Å—Å–æ', price:120 } ]},
  { key:'sushi',   title:'–°—É—à–∏ / —Ä–æ–ª–ª—ã', items:[ { name:'–ö–∞–ª–∏—Ñ–æ—Ä–Ω–∏—è', price:350 }, { name:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', price:390 }, { name:'–ê–ª—è—Å–∫–∞', price:350 } ]},
  { key:'semi',    title:'–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã', items:[ { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 6 —à—Ç.', price:160 }, { name:'–ù–∞–≥–≥–µ—Ç—Å—ã 9 —à—Ç.', price:210 }, { name:'–°—Ç—Ä–∏–ø—Å—ã', price:190 } ]},
];

function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2 }
function animateScrollX(el, to, opts){
  opts = opts || {}; var duration = typeof opts.duration==='number'?opts.duration:280; var onEnd=opts.onEnd;
  var from=el.scrollLeft; var diff=to-from; if(!diff){ if(onEnd) onEnd(); return; }
  var start=performance.now();
  function step(ts){ var t=Math.min(1,(ts-start)/duration); el.scrollLeft=from+diff*easeInOutCubic(t); if(t<1) requestAnimationFrame(step); else if(onEnd) onEnd(); }
  requestAnimationFrame(step);
}

function bindTapIncDec(catPager, counts, recalcTotal){
  var downX=0, downY=0, pressedEl=null;
  catPager.addEventListener('pointerdown',function(e){ var btn=e.target.closest('button[data-act]'); if(!btn) return; pressedEl=btn; downX=e.clientX; downY=e.clientY; });
  catPager.addEventListener('pointerup',function(e){
    if(!pressedEl) return; var dx=Math.abs(e.clientX-downX), dy=Math.abs(e.clientY-downY); var btn=pressedEl;
    if(dx<6&&dy<6){
      var act=btn.getAttribute('data-act'); var name=btn.getAttribute('data-name');
      if(act==='inc') counts[name]=(counts[name]||0)+1;
      if(act==='dec') counts[name]=Math.max(0,(counts[name]||0)-1);
      var nodes = catPager.querySelectorAll('[data-q="'+CSS.escape(name)+'"]');
      for (var i=0;i<nodes.length;i++){ nodes[i].textContent=counts[name]||0; }
      recalcTotal(); catPager._ignoreNextClickTs=Date.now();
    }
    pressedEl=null;
  });
  ['pointercancel','pointerleave'].forEach(function(evt){ catPager.addEventListener(evt, function(){ pressedEl=null; }); });
}

function OrderView(){
  var root=el(
    '<div class="relative">\
      <section class="sticky-top mb-2">\
        <div class="glass-panel rounded-2xl px-3 py-3">\
          <div id="categoryBar" class="flex gap-2 overflow-x-auto no-scrollbar"></div>\
        </div>\
      </section>\
      <section><div id="catPager" class="no-scrollbar"></div></section>\
      <div id="confirmBar" class="confirm-bar">\
        <div class="flex items-center justify-between gap-3">\
          <div class="text-base">\
            <span class="text-gray-600">–ò—Ç–æ–≥–æ:</span> <b id="totalVal">0 —Ä—É–±.</b>\
            <button id="cartBadge" class="ml-3 align-middle text-xs px-2 py-1 rounded-lg border hidden">\
              <span class="inline-flex items-center gap-1">\
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M6 6h15l-1.5 9h-12L6 6Zm0 0L5 3H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="20" r="1.5" fill="currentColor"/><circle cx="18" cy="20" r="1.5" fill="currentColor"/></svg>\
                <span id="cartActiveInfo"></span>\
              </span>\
            </button>\
          </div>\
          <button id="confirmBtn" class="px-4 py-3 rounded-xl bg-black text-white disabled:opacity-40 disabled:cursor-not-allowed" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>\
        </div>\
      </div>\
    </div>'
  );

  var categoryBar=root.querySelector('#categoryBar'); var catPager=root.querySelector('#catPager');
  var totalEl=root.querySelector('#totalVal');
  var confirmBtn=root.querySelector('#confirmBtn'); var cartBadge=root.querySelector('#cartBadge');

  setBodyScrollLock(true);
  var counts={}; var scrollMemory=new Map(); var activeIdx=0, isAnimating=false; var unavailableClient=new Set(loadUnavailable());
  function panelW(){ var r = catPager.getBoundingClientRect(); return r.width||1; }

  MENU_CATEGORIES.forEach(function(cat,idx){
    categoryBar.appendChild(el('<button type="button" class="px-3 py-1.5 rounded-full border text-sm whitespace-nowrap '+(idx===0?'bg-black text-white border-black':'bg-white/50')+'" data-idx="'+idx+'">'+cat.title+'</button>'));
  });
  function highlightChip(idx){
    var buttons=categoryBar.querySelectorAll('button');
    for (var i=0;i<buttons.length;i++){
      var b=buttons[i]; var on=i===idx;
      b.classList.toggle('bg-black',on);
      b.classList.toggle('text-white',on);
      b.classList.toggle('border-black',on);
      if(on){ try{ b.scrollIntoView({inline:'center', block:'nearest', behavior:'smooth'}); }catch(e){} }
    }
  }
  function goToIndex(idx, opts){
    opts = opts || {}; var animate = (typeof opts.animate==='boolean')?opts.animate:true;
    idx=Math.max(0,Math.min(MENU_CATEGORIES.length-1,idx));
    var target=Math.round(panelW()*idx); highlightChip(idx);
    if(!animate){ catPager.scrollLeft=target; activeIdx=idx; return }
    isAnimating=true; var prevSnap=catPager.style.scrollSnapType; catPager.style.scrollSnapType='none';
    var oldPanel = catPager.children[activeIdx]; var oldBox = oldPanel ? oldPanel.querySelector('.v-scroll') : null;
    if(oldBox){ scrollMemory.set(MENU_CATEGORIES[activeIdx].key, oldBox.scrollTop); }
    animateScrollX(catPager, target, { duration:280, onEnd:function(){
      var newPanel = catPager.children[idx]; var box=newPanel ? newPanel.querySelector('.v-scroll') : null;
      if(box){ box.scrollTop = scrollMemory.get(MENU_CATEGORIES[idx].key)||0; }
      activeIdx=idx; isAnimating=false; catPager.style.scrollSnapType=prevSnap||'x mandatory';
    }});
  }
  categoryBar.addEventListener('click', function(e){ var b=e.target.closest('button[data-idx]'); if(!b||isAnimating) return; goToIndex(+b.getAttribute('data-idx'),{animate:true}); });

  function buildPanels(){
    catPager.innerHTML='';
    MENU_CATEGORIES.forEach(function(cat){
      var panel=el('<div class="cat-panel"></div>'), vbox=el('<div class="v-scroll px-0.5"></div>'), list=el('<div class="grid gap-3"></div>');
      cat.items.forEach(function(it){
        var q=counts[it.name]||0; var disabled=unavailableClient.has(it.name);
        list.appendChild(el(
          '<div class="menu-card '+(disabled?'opacity-50':'')+'">\
            <div class="flex-1 min-w-0">\
              <div class="font-medium text-sm flex items-center gap-2">'+it.name+(disabled?'<span class="badge red">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>':'')+'</div>\
              <div class="text-xs text-gray-500 mt-1">'+money(it.price)+'</div>\
              <div class="flex items-center gap-3 mt-3">\
                <button type="button" class="w-8 h-8 rounded-xl border" data-name="'+it.name+'" data-act="dec" '+(disabled?'disabled':'')+'>‚àí</button>\
                <div class="w-6 text-center text-sm" data-q="'+it.name+'">'+q+'</div>\
                <button type="button" class="w-8 h-8 rounded-xl bg-black text-white" data-name="'+it.name+'" data-act="inc" '+(disabled?'disabled':'')+'>+</button>\
              </div>\
            </div>\
            <img src="'+(it.img||'https://placehold.co/110x70?text=food')+'" class="menu-card-img" alt="">\
          </div>'
        ));
      });
      list.appendChild(el('<div class="h-24"></div>'));
      vbox.appendChild(list); panel.appendChild(vbox); catPager.appendChild(panel);

      var down=false, used=false, sx=0, sy=0, locked=null; var PIX_LOCK=10;
      function THRESH(){ return Math.max(40, panelW()*0.25); }
      vbox.addEventListener('pointerdown',function(e){ if(isAnimating) return; down=true; used=false; sx=e.clientX; sy=e.clientY; locked=null; if (vbox.setPointerCapture) vbox.setPointerCapture(e.pointerId); });
      vbox.addEventListener('pointermove',function(e){
        if(!down||used||isAnimating) return; var dx=e.clientX-sx, dy=e.clientY-sy;
        if(locked===null){ if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>PIX_LOCK) locked='x'; else if(Math.abs(dy)>Math.abs(dx)&&Math.abs(dy)>PIX_LOCK) locked='y'; }
        if(locked==='x'){ try{ e.preventDefault(); }catch(_){} if(Math.abs(dx)>=THRESH()){ used=true; var next=dx<0?activeIdx+1:activeIdx-1; goToIndex(next,{animate:true}); } }
      }, {passive:false});
      ['pointerup','pointercancel','pointerleave'].forEach(function(evt){ vbox.addEventListener(evt,function(){ down=false; used=false; locked=null; }); });
    });

    if(!catPager._pmBound){
      catPager.addEventListener('click', function(e){
        if (catPager._ignoreNextClickTs && Date.now()-catPager._ignoreNextClickTs < 200){ e.preventDefault(); e.stopPropagation(); return; }
        var target=e.target; var ds = target && target.dataset ? target.dataset : null;
        var act = ds ? ds.act : null; if(!act) return;
        var name = ds.name;
        if(act==='inc') counts[name]=(counts[name]||0)+1; else counts[name]=Math.max(0,(counts[name]||0)-1);
        var nodes = catPager.querySelectorAll('[data-q="'+CSS.escape(name)+'"]');
        for (var i=0;i<nodes.length;i++){ nodes[i].textContent=counts[name]||0; }
        recalcTotal();
      });
      catPager.addEventListener('keydown', function(e){ var btn=e.target.closest('button[data-act]'); if(!btn) return; if(e.key==='Enter'||e.key===' '){ e.preventDefault(); btn.click(); }});
      catPager._pmBound=true;
    }

    applyHeights(); setTimeout(applyHeights,60);
  }

  function applyHeights(){
    try{
      var header=document.getElementById('appHeader');
      var headerH = header ? header.getBoundingClientRect().height : 0;
      var stickyTop = root.querySelector('.sticky-top');
      var chipsH = stickyTop ? stickyTop.getBoundingClientRect().height : 0;
      var confirmBarEl = document.getElementById('confirmBar');
      var confirmH = confirmBarEl ? confirmBarEl.getBoundingClientRect().height : 0;
      var availH=Math.max(240, window.innerHeight - headerH - chipsH - confirmH - 8);
      var first=catPager.querySelector('.menu-card');
      var cardH=first?Math.ceil(first.getBoundingClientRect().height):104;
      var h=Math.min(availH, cardH*4 + 12*3 + 4);
      var scrollers = root.querySelectorAll('.v-scroll');
      for (var i=0;i<scrollers.length;i++){ scrollers[i].style.height=h+'px'; }
      goToIndex(activeIdx,{animate:false});
    }catch(e){ console.warn('[applyHeights]', e); }
  }
  window.addEventListener('resize', applyHeights);

  catPager.addEventListener('scroll', function(){
    if (isAnimating) return;
    if (catPager._scrollTimer) clearTimeout(catPager._scrollTimer);
    catPager._scrollTimer = setTimeout(function(){
      var idx = Math.round(catPager.scrollLeft / (catPager.getBoundingClientRect().width||1));
      if(idx!==activeIdx){ highlightChip(idx); activeIdx=idx; }
    }, 80);
  });

  function recalcTotal(){ var sum=0; MENU_CATEGORIES.forEach(function(cat){ cat.items.forEach(function(it){ sum += (counts[it.name]||0)*it.price; }); }); totalEl.textContent=money(sum); confirmBtn.disabled = sum<=0; return sum; }

  (function applyPreselect(){
    var payload = sessionStorage.getItem('repeat_order_items');
    if(!payload) return;
    try{
      var items=JSON.parse(payload)||[];
      items.forEach(function(it){ counts[it.name]= (counts[it.name]||0) + (it.qty||0); });
      var qs = catPager.querySelectorAll('[data-q]');
      for (var i=0;i<qs.length;i++){ var name=qs[i].getAttribute('data-q'); qs[i].textContent = counts[name]||0; }
      recalcTotal();
      sessionStorage.removeItem('repeat_order_items');
      if(sessionStorage.getItem('open_pay_after_repeat')==='1'){ sessionStorage.removeItem('open_pay_after_repeat'); setTimeout(function(){ confirmBtn.click(); }, 150); }
    }catch(e){}
  })();

  function updateCartBadge(){
    var list = loadHistory();
    var active=null;
    if (Array.isArray(list)){
      for (var i=0;i<list.length;i++){
        var st=list[i].status||'';
        if (st!=='–∑–∞–≤–µ—Ä—à—ë–Ω' && st!=='–æ—Ç–º–µ–Ω—ë–Ω'){ active=list[i]; break; }
      }
    }
    var info = root.querySelector('#cartActiveInfo');
    if(active){ info.textContent = '‚Ññ '+active.id+' ‚Äî '+(active.status||'–Ω–æ–≤—ã–π'); cartBadge.classList.remove('hidden'); }
    else { cartBadge.classList.add('hidden'); }
  }
  cartBadge.addEventListener('click', function(){ location.hash='#/history'; });
  updateCartBadge();

  confirmBtn.addEventListener('click', function(){
    var items=[]; MENU_CATEGORIES.forEach(function(cat){ cat.items.forEach(function(it){ var q=counts[it.name]||0; if(q>0) items.push({name:it.name, qty:q, price:it.price}); }); });
    if(!items.length){ showToast(TOST_SELECT); return; }
    if (confirmBtn._busy) return; confirmBtn._busy=true; confirmBtn.disabled=true;

    var sumBox = document.getElementById('paySummary');
    var total=0; sumBox.innerHTML = items.map(function(i){ total += i.qty*i.price; return '<div class="flex items-center justify-between"><div class="truncate">'+i.name+' √ó'+i.qty+'</div><div class="ml-2 whitespace-nowrap">'+money(i.qty*i.price)+'</div></div>'; }).join('');
    sumBox.insertAdjacentHTML('beforeend', '<div class="mt-2 pt-2 border-t flex items-center justify-between font-semibold"><div>–ò—Ç–æ–≥–æ</div><div>'+money(total)+'</div></div>');
    var prof=loadProfile(); var sel=document.getElementById('paySelect'); sel.value = prof.paymentMethod||'cash';
    document.getElementById('payModal').classList.add('open');
  });

  function resetCounts(){ Object.keys(counts).forEach(function(k){ counts[k]=0; }); var qs=catPager.querySelectorAll('[data-q]'); for (var i=0;i<qs.length;i++){ qs[i].textContent='0'; } recalcTotal(); }

  (function bindPayModal(){
    var m=document.getElementById('payModal'); var ok=document.getElementById('payOk'); var cancel=document.getElementById('payCancel'); var sel=document.getElementById('paySelect');
    function close(){ if(m) m.classList.remove('open'); }
    function finalize(){ confirmBtn._busy=false; confirmBtn.disabled=false; }

    function onCancel(e){ if(e){ e.preventDefault(); e.stopPropagation(); } close(); finalize(); }
    function onOk(e){
      if(e){ e.preventDefault(); e.stopPropagation(); }
      var itemsSel=[]; var total=0;
      MENU_CATEGORIES.forEach(function(cat){ cat.items.forEach(function(it){ var q=counts[it.name]||0; if(q>0){ itemsSel.push({name:it.name, qty:q, price:it.price}); total+=q*it.price; } }); });
      if(!itemsSel.length){ showToast(TOST_SELECT); close(); finalize(); return; }

      var order = { id: Date.now().toString().slice(-6), createdAt: Date.now(), items: itemsSel, total: total, pay: sel.value||'cash', status:'–Ω–æ–≤—ã–π' };
      var history = loadHistory(); history.unshift(order); saveHistory(history.slice(0,50));
      var dash = loadDash(); dash.unshift(order); saveDash(dash.slice(0,200));
      var p=loadProfile(); p.paymentMethod = sel.value||'cash'; saveProfile(p);

      close(); finalize(); resetCounts(); updateCartBadge();
    }
    ['click','pointerup','touchend'].forEach(function(ev){ ok.addEventListener(ev, onOk, {passive:false}); });
    ['click','pointerup','touchend'].forEach(function(ev){ cancel.addEventListener(ev, onCancel, {passive:false}); });
    m.onclick=function(e){ if(e.target===m) onCancel(e); };
  })();

  buildPanels(); bindTapIncDec(catPager, counts, recalcTotal); highlightChip(0); requestAnimationFrame(function(){ goToIndex(0,{animate:false}); });
  root.cleanup = function(){ setBodyScrollLock(false); };
  return root;
}

function ProfileHubView(){
  var p=Object.assign({ name:'', phone:'', address:'', paymentMethod:'cash' }, loadProfile());

  var root=el(
  '<div class="grid gap-4 pb-28">\
    <section class="grid grid-cols-2 gap-3">\
      <button class="card card-tall p-4 text-left" id="profileEditBtn">\
        <div class="flex items-start justify-between">\
          <div class="min-w-0">\
            <div class="text-base font-semibold truncate">'+(p.name || '–ò–º—è –§–∞–º–∏–ª–∏—è')+'</div>\
            <div class="text-xs text-gray-600 mt-2 truncate">'+(p.phone || '+7 ___ ___-__-__')+'</div>\
          </div>\
          <svg width="22" height="22" viewBox="0 0 24 24" class="text-red-500"><path d="M12 8.5A3.5 3.5 0 1 1 8.5 12 3.5 3.5 0 0 1 12 8.5Zm8.94 2.26-1.73-.29a7.83 7.83 0 0 0-.73-1.76l1-1.46-1.41-1.41-1.46 1a7.83 7.83 0 0 0-1.76-.73l-.29-1.73h-2l-.29 1.73a7.83 7.83 0 0 0-1.76.73l-1.46-1-1.41 1.41 1 1.46a7.83 7.83 0 0 0-.73 1.76l-1.73.29v2l1.73.29c.16.62.41 1.21.73 1.76–ª-1 1.46 1.41 1.41 1.46-1c.55.32 1.14.57 1.76.73l.29 1.73h2l.29-1.73c.62-.16 1.21-.41 1.76-.73l1.46 1 1.41-1.41-1-1.46c.32-.55.57-1.14.73-1.76l1.73-.29Z" fill="currentColor"/></svg>\
        </div>\
      </button>\
      <button class="card card-tall p-4 text-left flex items-center justify-between" id="ordersBtn">\
        <div class="text-base font-semibold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>\
        <div class="flex items-center gap-3">\
          <svg width="28" height="28" viewBox="0 0 24 24"><path d="M7 4h10l1 4H6l1-4Zm-1 6h12l-1.2 8.4A3 3 0 0 1 13.84 21h-3.68A3 3 0 0 1 7.2 18.4L6 10Z" fill="#ff6f00"/></svg>\
          <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\
        </div>\
      </button>\
    </section>\
    <section class="card p-5"><div class="text-2xl font-extrabold tracking-tight">–ó–î–ï–°–¨ –ë–£–î–ï–¢ –ë–õ–û–ö –ü–û–î –†–ï–ö–õ–ê–ú–£</div></section>\
    <section class="card p-4 flex flex-col items-center gap-2">\
      <div class="text-xl font-bold">üé• –õ–∞–π–≤-–∫–∞–º–µ—Ä–∞</div>\
      <div class="rounded-2xl overflow-hidden border w-full">\
        <img id="liveCam" class="w-full object-cover" src="https://placehold.co/540x300?text=Live+Camera" alt="camera">\
      </div>\
      <button id="reloadCam" class="px-3 py-2 rounded-xl border bg-white">–û–±–Ω–æ–≤–∏—Ç—å</button>\
    </section>\
    <section class="grid gap-2">\
      <button class="rowlink text-left flex items-center justify-between" id="reviewsBtn">–û—Ç–∑—ã–≤—ã\
        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\
      </button>\
      <button class="rowlink text-left flex items-center justify-between" id="supportBtn">–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞\
        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\
      </button>\
      <button class="rowlink text-left flex items-center justify-between" id="feedbackBtn">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å\
        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M8 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\
      </button>\
    </section>\
    <section class="card p-4 text-sm leading-relaxed">\
      <div class="text-base font-semibold mb-2">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>\
      <div class="text-xs text-gray-600">–ê–¥—Ä–µ—Å: —Å. –ö–æ—Å—è–∫–∏–Ω–æ, —É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞, 26<br>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 08:00‚Äì23:00</div>\
    </section>\
    <section id="tabloTapZone"><div id="tabloTapHot" aria-label="tablo-tap-hot"></div></section>\
  </div>'
  );

  root.querySelector('#profileEditBtn').onclick = function(){ location.hash = '#/profile-edit'; };
  root.querySelector('#ordersBtn').onclick      = function(){ location.hash = '#/history'; };
  root.querySelector('#supportBtn').onclick     = function(){ alert('–ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —á–∞—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏.'); };
  root.querySelector('#reviewsBtn').onclick     = function(){ alert('–ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —ç–∫—Ä–∞–Ω –æ—Ç–∑—ã–≤–æ–≤.'); };
  root.querySelector('#feedbackBtn').onclick    = function(){ location.hash = '#/contact'; };
  root.querySelector('#reloadCam').onclick      = function(){ var img=root.querySelector('#liveCam'); var url=img.src.split('?')[0]; img.src = url+'?t='+Date.now(); };

  return root;
}

function ContactView(){
  var p=Object.assign({ phone:'' }, loadProfile());
  var root=el(
    '<div class="grid gap-4 pb-24">\
      <div class="flex items-center gap-3">\
        <button id="backOnly" class="px-3 py-2 rounded-xl border bg-white" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>\
        <div class="text-lg font-semibold">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>\
      </div>\
      <section class="card p-4 text-sm grid gap-2">\
        <div>–ü–æ—á—Ç–∞: <a class="underline" href="mailto:sabirbis@bk.ru">sabirbis@bk.ru</a></div>\
        <div>–¢–µ–ª.: <a class="underline" href="tel:+79899932108">+7 989 993-21-08</a></div>\
        '+(p.phone ? '<div class="text-xs text-gray-500">–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ: '+p.phone+'</div>' : '')+'\
      </section>\
    </div>'
  );
  root.querySelector('#backOnly').onclick = function(){ history.length ? history.back() : (location.hash='#/profile'); };
  return root;
}

function ProfileEditView(){
  var p=Object.assign({ name:'', phone:'', address:'', paymentMethod:'cash' }, loadProfile());
  var root=el(
    '<div class="grid gap-4 pb-24">\
      <section class="glass-panel rounded-2xl p-5">\
        <h2 class="text-lg font-semibold mb-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>\
        <div class="grid gap-3">\
          <input id="pName" class="border rounded-xl p-3" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è" value="'+(p.name||'')+'">\
          <input id="pPhone" class="border rounded-xl p-3" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7‚Ä¶)" value="'+(p.phone||'')+'">\
          <input id="pAddr" class="border rounded-xl p-3" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ)" value="'+(p.address||'')+'">\
          <div class="text-sm font-medium mt-2">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>\
          <select id="paydef" class="border rounded-xl p-3">\
            <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>\
            <option value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>\
            <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>\
          </select>\
          <div class="flex gap-2">\
            <button id="pSave" class="px-4 py-3 rounded-xl bg-black text-white flex-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\
            <button id="pBack" class="px-4 py-3 rounded-xl border flex-1">–ù–∞–∑–∞–¥</button>\
          </div>\
        </div>\
      </section>\
    </div>'
  );
  root.querySelector('#paydef').value = p.paymentMethod;
  root.querySelector('#pSave').onclick=function(){ var p2={ name:root.querySelector('#pName').value.trim(), phone:root.querySelector('#pPhone').value.trim(), address:root.querySelector('#pAddr').value.trim(), paymentMethod:root.querySelector('#paydef').value }; saveProfile(p2); showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); location.hash='#/profile'; };
  root.querySelector('#pBack').onclick=function(){ history.length ? history.back() : (location.hash='#/profile'); };
  return root;
}

function HistoryView(){
  var root=el(
    '<div class="grid gap-3 pb-24">\
      <div class="flex items-center justify-between">\
        <h2 class="text-lg font-semibold">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>\
        <div class="flex gap-2">\
          <button id="clearAll" class="px-3 py-2 rounded-xl border">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>\
          <button id="back" class="px-3 py-2 rounded-xl border">–ù–∞–∑–∞–¥</button>\
        </div>\
      </div>\
      <div id="historyList" class="grid gap-3"></div>\
    </div>'
  );
  var box=root.querySelector('#historyList');
  function cardView(o, idx){
    var items=o.items||[];
    var active = !['–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].includes(o.status||'–Ω–æ–≤—ã–π');
    var chipClass = active ? 'bg-yellow-200 text-yellow-800' : 'bg-gray-200 text-gray-700';
    var outerBg = active ? 'bg-yellow-50 border-yellow-200' : 'bg-white';

    var elCard = el(
      '<div class="card p-4 '+outerBg+'">\
        <div class="flex items-center justify-between">\
          <div class="text-2xl font-extrabold">‚Ññ '+(o.id||'‚Äî')+'</div>\
          <span class="chip '+chipClass+'">'+(o.status||'–Ω–æ–≤—ã–π')+'</span>\
        </div>\
        <div class="text-xs text-gray-500 mt-1">'+(o.createdAt? new Date(o.createdAt).toLocaleString():'')+'</div>\
        <div class="mt-3 grid gap-2">'+
          items.map(function(i){ return '<div class="flex items-center justify-between text-sm"><div class="truncate mr-2">'+i.name+'</div><div class="whitespace-nowrap">'+i.qty+' √ó '+i.price+' ‚ÇΩ</div></div>'; }).join('')+
        '</div>\
        <div class="mt-3 border-t pt-2 flex items-center justify-between">\
          <div class="font-semibold">–ò—Ç–æ–≥–æ: '+money(o.total||0)+'</div>\
          <div class="flex gap-2">\
            <button class="px-3 py-2 rounded-xl border" data-repeat>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</button>\
            <button class="px-3 py-2 rounded-xl border text-red-600" data-del>–£–¥–∞–ª–∏—Ç—å</button>\
          </div>\
        </div>\
      </div>'
    );
    elCard.querySelector('[data-repeat]').onclick=function(){
      sessionStorage.setItem('repeat_order_items', JSON.stringify(items));
      sessionStorage.setItem('open_pay_after_repeat','1');
      location.hash='#/order';
    };
    elCard.querySelector('[data-del]').onclick=function(){
      var cur=loadHistory(); cur.splice(idx,1); saveHistory(cur); render();
    };
    return elCard;
  }
  function render(){
    var list=loadHistory(); box.innerHTML='';
    if(!Array.isArray(list)||!list.length){ box.innerHTML='<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>'; return }
    list.forEach(function(o,idx){ box.appendChild(cardView(o, idx)); });
  }
  root.querySelector('#clearAll').onclick=function(){ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')){ saveHistory([]); render(); } };
  root.querySelector('#back').onclick=function(){ history.length ? history.back() : (location.hash='#/profile'); };
  render(); return root;
}

function DashboardView(){
  var root=el(
    '<div class="grid gap-4 max-w-6xl pb-24">\
      <div class="flex items-center justify-between"><h2 class="text-xl font-semibold">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h2></div>\
      <div class="p-4 rounded-2xl bg-white border">\
        <h3 class="font-semibold mb-3">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>\
        <p class="text-sm text-gray-500 mb-3">–û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–∫–æ–π, —á–µ–≥–æ –ù–ï–¢ ‚Äî –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Ç–æ–≤–∞—Ä —Å—Ç–∞–Ω–µ—Ç —Å–µ—Ä—ã–º –∏ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å.</p>\
        <div id="stockList" class="grid gap-2 md:grid-cols-3"></div>\
        <div class="mt-3"><button id="saveStock" class="px-3 py-2 rounded-xl border bg-black text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>\
      </div>\
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="list"></div>\
      <div><button class="px-3 py-2 rounded-xl border" onclick="location.hash=\'#/profile\'">–ù–∞–∑–∞–¥</button></div>\
    </div>'
  );
  var list=root.querySelector('#list'); var stockList=root.querySelector('#stockList'); var unavailable=new Set(loadUnavailable()); var dashOrders=loadDash();

  function renderStock(){ stockList.innerHTML=''; MENU_CATEGORIES.forEach(function(cat){ cat.items.forEach(function(item){ var row=el('<label class="flex items-center gap-2 text-sm"><input type="checkbox" value="'+item.name+'" '+(unavailable.has(item.name)?'checked':'')+' /><span>'+item.name+'</span></label>'); stockList.appendChild(row); }); }); }
  renderStock();
  root.querySelector('#saveStock').onclick=function(){ var checked=[].slice.call(stockList.querySelectorAll('input[type=checkbox]:checked')).map(function(i){ return i.value; }); saveUnavailable(checked); unavailable=new Set(checked); showToast('–ù–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

  function orderCard(o){
    var clientTotal=(o.items||[]).reduce(function(s,i){ return s + (i.price||0)*(i.qty||0); },0);
    var total=Math.max(typeof o.total==='number'?o.total:0, clientTotal);
    var created=o.createdAt? new Date(o.createdAt): new Date();
    var itemLines=(o.items||[]).map(function(i){return i.name+' √ó'+i.qty;}).join(', ');
    var card=el(
      '<div class="p-5 rounded-2xl bg-white border flex flex-col gap-2" data-id="'+o.id+'">\
        <div class="flex items-center justify-between gap-4">\
          <div class="text-lg font-semibold">#'+o.id+' ‚Äî '+(o.name||'')+'</div>\
          <div class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-sm">'+(o.status||'–Ω–æ–≤—ã–π')+'</div>\
        </div>\
        <div class="text-sm text-gray-600">'+created.toLocaleString()+' ¬∑ –ò—Ç–æ–≥: <b>'+total+' —Ä—É–±.</b></div>\
        <div>üßæ '+(itemLines||'‚Äî')+'</div>\
        <div class="mt-3 flex flex-wrap gap-2 items-center">\
          <label class="text-sm">–°—Ç–∞—Ç—É—Å:</label>\
          <select class="border rounded-xl p-2" data-k="status">'+['–Ω–æ–≤—ã–π','–≥–æ—Ç–æ–≤–∏—Ç—Å—è','–≤ –ø—É—Ç–∏','–≥–æ—Ç–æ–≤','–∑–∞–≤–µ—Ä—à—ë–Ω','–æ—Ç–º–µ–Ω—ë–Ω'].map(function(s){return '<option '+(s===(o.status||'–Ω–æ–≤—ã–π')?'selected':'')+'>'+s+'</option>';}).join('')+'</select>\
          <button type="button" class="px-3 py-2 rounded-xl border" data-act="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>\
        </div>\
        <div class="mt-2 text-right"><button type="button" class="px-3 py-2 rounded-xl border bg-red-50 hover:bg-red-100" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button></div>\
      </div>'
    );
    card.addEventListener('click',function(e){
      var act=e.target.dataset.act; if(!act) return;
      if(act==='save'){
        var status=card.querySelector('[data-k="status"]').value;
        var i=dashOrders.findIndex(function(x){ return String(x.id)===String(o.id); });
        if(i>=0){ dashOrders[i]=Object.assign({}, dashOrders[i], {status:status}); saveDash(dashOrders); syncOrderStatus(o.id, status); showToast('–°—Ç–∞—Ç—É—Å #'+o.id+' –æ–±–Ω–æ–≤–ª—ë–Ω'); }
      }
      if(act==='delete'){
        if(!card.dataset.confirm){ card.dataset.confirm='1'; e.target.textContent='–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?'; setTimeout(function(){ if(card&&card.dataset.confirm==='1'){ delete card.dataset.confirm; e.target.textContent='–£–¥–∞–ª–∏—Ç—å'; } },3000); return }
        dashOrders=dashOrders.filter(function(x){ return String(x.id)!==String(o.id); }); saveDash(dashOrders); card.remove(); showToast('–ó–∞–∫–∞–∑ #'+o.id+' —É–¥–∞–ª—ë–Ω —Å —Ç–∞–±–ª–æ');
      }
    });
    return card;
  }
  function load(){ var unique=new Map(); dashOrders.forEach(function(o){ unique.set(String(o.id),o); }); list.innerHTML=''; if(unique.size===0){ list.innerHTML='<div class="p-5 rounded-2xl bg-white border text-gray-500 col-span-full">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>'; return } unique.forEach(function(o){ list.appendChild(orderCard(o)); }); }
  load(); return root;
}

function bindTabloTapZone(){
  var hot = document.getElementById('tabloTapHot');
  if (!hot || hot._bound) return; hot._bound = true;
  var taps = 0, first = 0, timer = null;
  var windowMs = 1200;
  function reset(){ taps = 0; first = 0; if (timer){ clearTimeout(timer); timer = null; } }
  function handler(){
    var now = Date.now();
    if (!first) first = now; taps++;
    if (now - first > windowMs){ reset(); taps = 1; first = now; }
    if (taps >= 4){
      reset();
      var pm = document.getElementById('payModal'); if (pm) pm.classList.remove('open');
      if (sessionStorage.getItem(TABLO_PIN_OK) === '1') location.hash = '#/dashboard';
      else document.getElementById('pinModal').classList.add('open');
    }else{ if (timer) clearTimeout(timer); timer = setTimeout(reset, windowMs); }
  }
  ['click','pointerup','touchend'].forEach(function(ev){ hot.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); handler(); }, {passive:false}); });
}

function mount(view){
  var app=document.getElementById('app');
  if(app.firstChild && typeof app.firstChild.cleanup==='function'){ try{ app.firstChild.cleanup(); }catch(e){} }
  app.innerHTML=''; app.classList.add('phone-shell'); app.appendChild(view);
}
function realRouter(){
  var h=location.hash.split('?')[0];
  if(h==='#/profile'){ mount(ProfileHubView()); bindTabloTapZone(); }
  else if(h==='#/profile-edit') mount(ProfileEditView());
  else if(h==='#/history') mount(HistoryView());
  else if(h==='#/contact') mount(ContactView());
  else if(h==='#/dashboard') mount(DashboardView());
  else mount(OrderView());
}
function router(){
  var h=location.hash.split('?')[0];
  var profileBtn=document.getElementById('profileBtn'); var backBtn=document.getElementById('backBtn');
  var showBack=(h==='#/profile'||h==='#/history'||h==='#/profile-edit'||h==='#/contact');
  if(showBack){ if(profileBtn) profileBtn.classList.add('hidden'); if(backBtn) backBtn.classList.remove('hidden'); }
  else { if(backBtn) backBtn.classList.add('hidden'); if(profileBtn) profileBtn.classList.remove('hidden'); }

  if(h==='#/dashboard' && sessionStorage.getItem(TABLO_PIN_OK)!=='1'){
    document.getElementById('pinModal').classList.add('open');
    var app=document.getElementById('app'); if(app) app.innerHTML='';
    return;
  }
  if(h==='#/profile'){ var pm2=document.getElementById('payModal'); if(pm2) pm2.classList.remove('open'); }
  realRouter();
}
window.addEventListener('hashchange', function(){ try{ router(); }catch(e){ console.error(e); }});
try{ router(); }catch(e){ console.error(e); }

/* Header –∏ –º–æ–¥–∞–ª–∫–∏ */
document.addEventListener('DOMContentLoaded', function(){
  var profileBtn=document.getElementById('profileBtn');
  function goProfile(e){ if(e){ e.preventDefault(); e.stopPropagation(); } location.hash='#/profile'; }
  ['click','pointerup','touchend'].forEach(function(ev){ profileBtn.addEventListener(ev, goProfile, {passive:false}); });

  var backBtn=document.getElementById('backBtn');
  function goOrder(e){ if(e){ e.preventDefault(); e.stopPropagation(); } location.hash='#/order'; }
  ['click','pointerup','touchend'].forEach(function(ev){ backBtn.addEventListener(ev, goOrder, {passive:false}); });

  bindTabloTapZone();

  var pinM=document.getElementById('pinModal'); var pinOk=document.getElementById('pinOk'); var pinCancel=document.getElementById('pinCancel'); var pinInput=document.getElementById('pinInput');
  pinOk.onclick=function(e){ if(e) e.preventDefault(); if((pinInput.value||'').length>0){ sessionStorage.setItem(TABLO_PIN_OK,'1'); pinM.classList.remove('open'); try{ router(); }catch(_){} } else { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á'); } };
  pinCancel.onclick=function(){ pinM.classList.remove('open'); location.hash='#/profile'; };
  pinM.onclick=function(e){ if(e.target===pinM) pinCancel.onclick(); };
});
</script>
</body>
</html>
